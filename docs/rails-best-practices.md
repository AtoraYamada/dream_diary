# Rails コーディング規約 (レビュー基準)

## 📑 目次
1. [アーキテクチャ・設計原則](#アーキテクチャ設計原則) - SOLID原則、サービスクラス
2. [MVC各層](#mvc各層) - Model、View、Controller、Routing
3. [データベース](#データベース) - DB設計、マイグレーション
4. [コード品質](#コード品質) - コーディングスタイル、RuboCop、テスト
5. [非機能要件](#非機能要件) - セキュリティ、パフォーマンス、エラーハンドリング

---

# アーキテクチャ・設計原則

## SOLID-01: SOLID原則の適用

### Single Responsibility (単一責任の原則)
- [ ] 1つのクラスは1つの責任のみを持つ
- [ ] メソッドは1つの処理のみを行う
- [ ] 例: UserMailer は通知のみ、UserService はビジネスロジックのみ

### Open/Closed (開放/閉鎖の原則)
- [ ] 拡張に対して開いている（継承、ポリモーフィズム活用）
- [ ] 修正に対して閉じている（既存コードを変更せず機能追加）

### Liskov Substitution (リスコフの置換原則)
- [ ] サブクラスは親クラスと置換可能であること
- [ ] オーバーライドメソッドは親の契約を守ること

### Interface Segregation (インターフェース分離の原則)
- [ ] 使わないメソッドへの依存を避ける
- [ ] Concernを適切に分割する

### Dependency Inversion (依存性逆転の原則)
- [ ] 具象クラスではなく抽象に依存する
- [ ] 依存性注入（DI）の活用

## ARCH-01: サービスクラス (Service Objects)
> **使い分けガイド（MODEL-01 Fat Modelとの使い分け）**:
> - **モデル（MODEL-01）**: 単一モデルに関するビジネスロジック（例: `User#full_name`, `Task#overdue?`）
> - **サービスクラス**: 複数モデルにまたがる処理、外部API連携、複雑なトランザクション（例: `Tasks::CreateService`）

- **単一責任**: 1つのサービスクラスは1つのビジネスアクションのみを担当すること。
- **名前空間**: 関連するサービスは名前空間でグループ化すること（例: `Tasks::CreateService`）。
- **結果オブジェクト**: 処理結果は `ServiceResult` を使用し、`success?`/`failure?` で判定可能にすること。
- **トランザクション**: DB更新を伴う処理は `ActiveRecord::Base.transaction` で囲むこと。
- **エラーハンドリング**: 例外は適切にレスキューし、`ServiceResult` のエラーとして返すこと。

---

# MVC各層

## MODEL-01: モデル (Model)
- **Fat Model**：ビジネスロジック、複雑なバリデーション、DBクエリはモデル層に記述すること。
- **N+1の回避**: データ取得の際は、`includes` や `eager_load` を使用し、N+1クエリを発生させないこと。
- **スコープ**: クエリを再利用可能にするため、可能な限りクラスメソッドではなく `scope` を使用すること。

## MODEL-02: バリデーション (Validations)
- **適切な制約**: presence, format, inclusion などを適切に使用すること。
- **カスタムバリデーション**: 複雑なロジックは custom validator に抽出すること。
- **エラーメッセージ**: ユーザーフレンドリーなメッセージを設定すること（i18n推奨）。

## VIEW-01: JSON API / View (jbuilder)
- **レスポンス構造の統一**: APIレスポンスは一貫した構造を持つこと（成功時・エラー時）。
- **部分テンプレート**: 共通のJSON構造は部分テンプレート（partials）に抽出すること。
- **エラーレスポンス**: バリデーションエラーは `{ errors: [...] }` 形式で返すこと。
- **ステータスコード**: HTTP status codeを適切に設定すること（200, 201, 400, 404, 422, 500等）。

## CTRL-01: コントローラ (Controller)
- **Thin Controller**：アクションは、リクエストの受け付け、パラメータの検証、レスポンスの返却のみに集中すること。**ビジネスロジックは、モデルまたはサービスクラスに委譲**すること。
- **リダイレクト**: URLはハードコードせず、常に`*_path`ヘルパーまたは`url_for`ヘルパーを使用すること。
- **Strong Parameters**: パラメータ受け取り時は、必ず`params.require(:model).permit(...)`を使用し、セキュリティを確保すること。

## ROUTE-01: ルーティング (Routing)
- **RESTful設計**: 原則として `resources` を使用し、RESTfulな設計にすること。
- **カスタムアクション**: RESTに収まらないアクションは `member` または `collection` で明示すること。
- **名前空間**: API versioning には `namespace` を使用すること（例: `/api/v1/tasks`）。

### チェックリスト (ROUTE-01)
- [ ] **RESTful設計の遵守**: 標準的なRESTアクションが適切に実装されているか
  - GET /resources → index（一覧取得）
  - POST /resources → create（新規作成）
  - PATCH/PUT /resources/:id → update（更新）
  - DELETE /resources/:id → destroy（削除）
  - GET /resources/:id → show（詳細取得）
- [ ] **カスタムアクション**: RESTに収まらないアクションが適切に定義されているか
  - member アクション（単一リソースへの操作、例: POST /resources/:id/activate）
  - collection アクション（複数リソースへの操作、例: POST /resources/bulk_delete）
- [ ] **API バージョニング**: namespace で適切に整理されているか
  - `/api/v1/` 形式で明確に区分
  - ルーティングファイルでバージョン分離が確認できる
- [ ] **認証が必要なルート**: 公開ルート vs. 認証ルートが明確に分離されているか
  - 保護されるべきエンドポイントに認証ガード実装

**判定基準**:
- ✅ PASS: RESTful設計に従い、カスタムアクション・バージョニングが適切
- ⚠️ WARNING: 一部RESTful でない、または namespace未使用だが実装可能
- ❌ REJECT: ルーティング設計が大きく逸脱し、メンテナンス性に懸念

---

# データベース

## DB-01: データベース (Database)
- **マイグレーション**: カラム追加時は `null` 制約の有無、デフォルト値を明示すること。
- **インデックス**: 外部キーや検索条件に使うカラムには必ずインデックスを追加すること。
- **外部キー制約**: `add_foreign_key` を使用し、参照整合性を保証すること。

## DB-02: データベースマイグレーション
> **Note**: このセクションはDB-01（データベース基本原則）の詳細版です。マイグレーション実行時に使用してください。

### マイグレーション作成の原則
- [ ] **可逆性**: `up`/`down`または`change`で必ずロールバック可能にする
- [ ] **本番考慮**: ダウンタイムが発生しないか検証
- [ ] **データ整合性**: 既存データへの影響を確認
- [ ] **インデックス**: 外部キー、検索条件カラムにインデックス追加 (DB-01参照)
- [ ] **NOT NULL制約**: 既存データがある場合、デフォルト値を設定してから追加 (DB-01参照)
- [ ] **commentオプション**: ⚠️ WARNING - カラムには `comment` オプションでカラムの用途・説明を記述

### マイグレーション実行前チェック
```bash
# ロールバックテスト（必須）
rails db:migrate
rails db:rollback
rails db:migrate
```

**注意**: インデックス追加、NOT NULL制約、データ型変更などの大規模テーブル変更（10万件以上）は、ステージング環境での性能確認を推奨。必要に応じてロールバックテスト時に実行時間計測のこと。

### 注意事項
- ❌ マイグレーション内でモデルを直接使用しない（将来のモデル変更でマイグレーションが壊れる）
- ✅ SQL実行や`execute`メソッドを使用
- ✅ 大規模テーブルの変更は段階的に実施

---

# コード品質

## CODE-01: コーディングスタイル

### DRY (Don't Repeat Yourself)
- [ ] 同じコードを2回以上書かない
- [ ] 共通処理はメソッド化、モジュール化、Concernで共有
- [ ] ビューの共通部分はパーシャル化

### マジックナンバー/文字列の排除
- [ ] 数値や文字列は定数として定義
- [ ] enumの活用を推奨
```ruby
# Bad
if user.status == 0
  # ...
end

# Good
class User
  enum status: { active: 0, inactive: 1, banned: 2 }
end

if user.active?
  # ...
end
```

### コメント方針
- [ ] **コードで表現できることはコメント不要**
- [ ] **Why（なぜ）を書く、What（何を）は書かない**
- [ ] 複雑なビジネスロジック、回避策、TODO には理由を記載
```ruby
# Bad: コードを読めばわかる
# ユーザー名を返す
def user_name
  "#{first_name} #{last_name}"
end

# Good: なぜその実装が必要かを説明
# NOTE: 外部API仕様によりUTC固定が必須
Time.use_zone('UTC') do
  # ...
end
```

## CODE-02: RuboCop運用

### 基本方針
- [ ] プロジェクトの `.rubocop.yml` に従う
- [ ] 無効化（`rubocop:disable`）は最小限に
- [ ] 無効化する場合は理由をコメントで明記

### 重要なルール
- `Style/StringLiterals`: 文字列リテラルの統一
- `Metrics/MethodLength`: メソッドの長さ制限
- `Layout/LineLength`: 行の長さ制限
- `Rails/`: Rails固有のルール群

### 違反の重大度
- **❌ REJECT**: セキュリティリスク（`Rails/OutputSafety`, `Security/*`等）
- **⚠️ WARNING**: メトリクス違反（`Metrics/MethodLength`, `Metrics/ClassLength`, `Metrics/CyclomaticComplexity`等）
- **軽微（任意対応）**: スタイル違反（`Style/StringLiterals`, `Style/TrailingComma`等）

## TEST-01: テスト (RSpec)
- テストは実装ではなく**振る舞い**をテストすること。
- テストコードは明確なテスト名を持ち、期待されるシナリオを説明すること。

## TEST-02: テスト戦略
> **Note**: このセクションはTEST-01（テスト基本原則）の詳細版です。テスト設計・実装時に使用してください。

### テストの種類と方針
- **Model（単体テスト）**:
  - バリデーションルール
  - カスタムメソッドのロジック
  - スコープの動作
  - 関連（Association）の検証

- **Request Spec（統合テスト）**:
  - HTTPリクエスト/レスポンスの検証
  - 認証・認可の動作確認
  - エラーハンドリング

- **System Spec（E2E）**:
  - 重要なユーザーフロー
  - JavaScript連携が必要な機能

### テスト品質基準
- [ ] **カバレッジ**: SimpleCovを使用し、以下の基準を満たすこと
  - **80%以上**: ✅ PASS
  - **60-79%**: ⚠️ WARNING（改善推奨）
  - **60%未満**: ❌ REJECT（新規実装のテスト不足）
- [ ] **可読性**: テストケース名は日本語で明確に記述
- [ ] **独立性**: テスト間で依存関係を持たない
- [ ] **高速性**: 遅いテストは分離・最適化
- [ ] **FactoryBot**: テストデータはFactoryBotで管理

### テスト命名規則
```ruby
# Good: 何をテストしているか明確
describe "ユーザーがログインする場合" do
  context "正しいパスワードを入力したとき" do
    it "ダッシュボードにリダイレクトされる" do
      # ...
    end
  end
end
```

---

# 非機能要件

## SEC-01: セキュリティ (Security)
- **CORS**: 許可するオリジンは本番環境で適切に制限すること。
- **認証・認可**: APIには適切な認証（JWT等）を実装すること（該当する場合）。
- **SQLインジェクション**: ActiveRecordのクエリメソッドを使用すること。やむを得ず生SQLを書く場合は必ずプレースホルダーを使用すること。

## SEC-02: セキュリティチェックリスト
> **Note**: このセクションはSEC-01（セキュリティ基本原則）の詳細チェックリストです。実装時・レビュー時に使用してください。

実装時には以下のセキュリティ観点を必ず確認すること。

### 重大度
- [ ] **Strong Parameters**: ❌ **未設定の場合はREJECT** - コントローラーで適切にパラメータを制限している (CTRL-01参照)
- [ ] **SQLインジェクション対策**: ❌ **脆弱性がある場合はREJECT** - ActiveRecordのクエリメソッド（`where`, `find_by`等）を使用。やむを得ず生SQLを使う場合はプレースホルダー必須 (SEC-01参照)
- [ ] **認証・認可**: ❌ **不備がある場合はREJECT** - 適切な権限チェック（Pundit/CanCanCanなど使用） (SEC-01参照)
- [ ] **マスアサインメント**: ❌ **脆弱性がある場合はREJECT** - 意図しない属性更新の防止
- [ ] **XSS対策**: ⚠️ WARNING - ユーザー入力を適切にサニタイズ、`html_safe`の使用を最小限に
- [ ] **CSRF対策**: ⚠️ WARNING - `protect_from_forgery`が有効、API認証トークン適用
- [ ] **センシティブ情報のログ出力**: ❌ **ログ出力している場合はREJECT** - パスワード、トークン、個人情報などをログ出力している（ERROR-01参照）
- [ ] **環境変数**: 軽微（任意対応）- APIキー、シークレットは環境変数で管理（dotenv/credentials）

## PERF-01: パフォーマンスチェックリスト
> **Note**: このセクションはMODEL-01（モデル）とDB-01（データベース）のパフォーマンス観点の詳細チェックリストです。

効率的なコードのために以下を確認すること。

### 重大度
- [ ] **N+1クエリ**: ❌ **検出された場合はREJECT**（最優先） - `includes`/`eager_load`/`preload`で関連データを事前読み込み (MODEL-01参照)
- [ ] **インデックス欠落**: ⚠️ WARNING - 外部キー、検索条件となるカラムにインデックスを設定 (DB-01参照)
- [ ] **バッチ処理未使用**: ⚠️ WARNING - 大量データ処理時は`find_each`/`in_batches`で処理
- [ ] **不要なクエリ**: ⚠️ WARNING - 同じデータを複数回取得していないか
- [ ] **カウンタキャッシュ**: 軽微（任意対応）- 関連レコード数の頻繁な参照には`counter_cache`使用
- [ ] **セレクト最適化**: 軽微（任意対応）- 必要なカラムのみ取得（`select`メソッド活用）
- [ ] **ページネーション**: 軽微（任意対応）- 大量データ表示時は`kaminari`/`pagy`などで分割

## ERROR-01: エラーハンドリング

### 例外処理の方針
- **予期されるエラー**: 適切に`rescue`し、ユーザーにわかりやすいメッセージを表示
- **予期しないエラー**: そのまま発生させ、監視ツール（Sentry等）で捕捉
- **外部API連携**: タイムアウトや接続エラーを考慮

### 重大度
- [ ] **センシティブ情報のログ出力**: ❌ **ログ出力している場合はREJECT** - パスワード、トークン、個人情報などをログ出力している（SEC-02参照）
- [ ] **予期されるエラーの未処理**: ⚠️ WARNING - ユーザー向けの適切なエラーメッセージがない、rescue未実装
- [ ] **外部API連携のエラーハンドリング不足**: ⚠️ WARNING - タイムアウトや接続エラー、リトライ処理を考慮していない
- [ ] **ログレベルの不適切な使用**: 軽微（任意対応）- info/warn/errorの使い分けが不適切

### ログ出力ガイドライン
```ruby
# Good: 適切なログレベルと構造化
Rails.logger.info "User #{user.id} logged in successfully"
Rails.logger.warn "Failed login attempt for email: #{email}"
Rails.logger.error "Payment processing failed: #{e.message}", error: e

# Bad: センシティブ情報の出力
Rails.logger.debug "Password: #{password}"  # ❌
```

### エラーメッセージ
- ユーザー向け: わかりやすく、次のアクションを示す
- 開発者向け: デバッグに必要な情報を含める
- 国際化: `config/locales/ja.yml`でメッセージ管理
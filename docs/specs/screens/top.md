# トップ画面（現実）

夢が消える前に捕まえる切迫感と没入感を優先。ログイン前の殴り書きメモ機能により、ユーザーは認証前でも夢を記録できる。

---

## 要件

- ログイン前でも一時メモを入力可能（LocalStorage）
- 森の扉をクリックで認証画面へ遷移
- 音声推奨文とミュートボタンを表示
- ブラウザの自動再生制限に対応した音声有効化

---

## 設計判断

| 項目 | 選択 | 理由 |
|------|------|------|
| 一時保存先 | LocalStorage | 認証前のため、端末固有ストレージを使用 |
| 保存タイミング | 1文字ごと | 夢が消える前に確実に記録するため |
| 最大文字数 | 2,000文字 | 一時メモとして十分な容量 |
| カーソル | 鉛筆（`cursor_pencil.png`） | 現実世界の素朴な質感を表現 |
| 音声有効化 | 扉クリック時にAudioContext有効化 | ブラウザの自動再生制限に対応 |

---

## 画面構成

| レイヤー | 要素 | 説明 |
|---------|------|------|
| 背景 | 森の扉 | 全画面を覆う背景画像（`bg_top_forest_door.png`）。ズームに耐える高解像度 |
| 中景 | 殴り書きの紙片 | 初期状態：扉の傍らに小さな「紙片」が落ちている。クリックで展開（`img_scratchpad_paper.png`） |
| 前景（上部） | 音声推奨文 | 画面中央上部に「音声ONでの体験を推奨します」等のメッセージ |
| 前景（右上） | ミュートボタン | 右上に配置、ON/OFF切替可能 |

---

## 入力フィールド

| フィールド | 必須 | 型 | 制約 | 初期値 | 備考 |
|-----------|------|-----|------|--------|------|
| メモ本文 | - | text | 最大2,000文字 | LocalStorageから復元 | 1文字ごとに自動保存 |

---

## UI動作

### 紙片の展開

**トリガー**: 紙片をクリック

**動作**:
1. 紙片が画面中央へ移動・拡大（500ms）
2. 背景が減光
3. 入力可能状態になる
4. カーソルが鉛筆（`cursor_pencil.png`）に変化
5. LocalStorageに保存されたテキストがあれば復元

### テキスト入力

**トリガー**: 入力エリアにフォーカス

**動作**:
- カーソルが鉛筆（`cursor_pencil.png`）に変化
- 鉛筆の筆記音（`sfx_pencil_write.wav`）をループ再生（フォーカス中のみ）
- 1文字入力ごとにLocalStorageへ自動保存（debounceなし）

**フォーカス解除時**:
- カーソルを通常に戻す
- 筆記音を停止

### 紙片を閉じる

**トリガー**: 閉じるボタンをクリック

**動作**:
1. 紙片が元の位置へ縮小・移動（500ms）
2. 背景の減光解除
3. LocalStorageの内容は保持

### 扉をクリック（認証画面へ遷移）

**トリガー**: 扉をクリック

**動作**:
1. AudioContext有効化（即時）- ブラウザの自動再生制限に対応
2. 瞬き演出（`animations.md` 参照）
3. 扉の開閉音（`sfx_door_open_heavy.wav`）再生
4. 認証画面へ遷移

### ミュートボタン

**トリガー**: ミュートボタンをクリック

**動作**:
- ミュート状態をトグル（ON/OFF切替）
- LocalStorage（`audio_muted`）に保存
- 以降のSE再生を制御

---

## エラーハンドリング

該当なし（LocalStorageのみのため、通信エラーなし）

---

## データ送受信（API）

該当なし（LocalStorageのみ）

### LocalStorage仕様

#### キー: `scratch_memo`

**構造**（トップページ時点）:
```json
{
  "content": "入力されたテキスト",
  "timestamp": 1234567890
}
```

**ライフサイクル**:
- 発生: 未ログイン状態での入力
- 継承: ログイン後の作成画面（`create.md`）で本文の初期値として使用
- 削除: DB保存成功時

**タイムスタンプ管理**:
- ログイン後、作成画面を開く際に自動比較
- DBの最終更新日時より新しければ復元を提案

#### キー: `audio_muted`

**構造**:
```json
{
  "muted": false
}
```

**用途**: ミュート状態の永続化

---

## 演出

`animations.md` の以下のセクションを参照：
- トップページ > 紙片の展開
- トップページ > テキスト入力
- トップページ > 紙片を閉じる
- トップページ > 扉をクリック（認証画面へ遷移）

---

## 実装状況

### バックエンド（API）

該当なし（LocalStorageのみ）

### フロントエンド

- [ ] HTMLビュー（app/views/pages/top.html.erb）
- [ ] JavaScript（app/javascript/top.js）
- [ ] CSS（app/assets/stylesheets/top.css）
- [ ] 画面表示
- [ ] 紙片の展開/閉じる演出
- [ ] テキスト入力（鉛筆カーソル、筆記音）
- [ ] LocalStorage連携（scratch_memo）
- [ ] 扉クリック遷移
- [ ] AudioContext有効化
- [ ] ミュートボタン（LocalStorage: audio_muted）
- [ ] 演出・SE再生

**Note**: プロトタイプ（`prototype/`）に参考実装あり。Rails本体への統合が必要。

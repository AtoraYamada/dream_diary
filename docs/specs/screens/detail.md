# 夢詳細画面（記憶の断片）

見開きの本としてモーダル表示。ページめくり機能付き。一覧画面の背景上に表示。

---

## 要件

- 見開き本形式で夢日記を閲覧
- ページめくり機能（3D回転演出）
- 編集画面への遷移
- 削除機能（忘却の儀式）

---

## 設計判断

| 項目 | 選択 | 理由 |
|------|------|------|
| UI形式 | 見開き本（モーダル） | 没入型の閲覧体験を提供 |
| ページ分割 | 500字/ページ（目安） | 読みやすさを考慮 |
| ページめくり | CSS 3D変換（rotateY） | リアルな本のめくり演出 |
| 削除確認 | 砂時計クリック時に確認ダイアログ | 誤操作防止 |

---

## 画面構成

| レイヤー | 要素 | 説明 |
|---------|------|------|
| 背景 | 一覧画面（ぼかし） | 一覧画面が減光・ぼかし状態 |
| 前景 | 見開き本フレーム | 感情彩色に応じた画像（`img_book_open_frame_*.png`） |
| 前景 | ページ内容 | 左右ページ。CSSで描画 |
| 前景（右端） | 編集トリガー | 羽ペンとペーパーナイフ（`icon_edit_quill_knife.png`） |
| 前景（右端） | 削除トリガー | アンティークな砂時計（`icon_hourglass_antique.png`）。羽ペンとペーパーナイフの下 |
| 前景（下部） | ページ番号 | 各ページに「1/10」形式で表示 |

---

## UI動作

### 詳細表示（一覧から）

**トリガー**: 一覧画面の背表紙をクリック（`list.md` 参照）

**動作**:
- 見開き本が表示される
- 最初の見開き（1-2ページ）が表示される

### ページめくり

**トリガー**: 左右ページをクリック

**動作**:
1. ページ回転アニメーション（3D rotateY、800ms）
2. SE: `sfx_page_turn.wav`
3. 回転中間地点（400ms）でページ内容更新
4. 次/前のページへ移動

### 本を閉じる（一覧へ戻る）

**トリガー**: 本の外側をクリック

**動作**:
1. 本が閉じるアニメーション（見開き→半開き→閉、600ms）
2. SE: `sfx_book_close_heavy.wav`
3. 背表紙の再表示（フェードイン、即時）
4. モーダル閉じ、一覧画面に戻る（瞬き演出なし）

### 編集トリガー（編集画面へ）

**トリガー**: 羽ペンとナイフをクリック

**動作**:
1. 本が閉じるアニメーション（見開き→半開き→閉、600ms）
2. SE: `sfx_book_close_heavy.wav`
3. 瞬き演出（`animations.md` 参照）
4. 巻物展開演出（`animations.md` 参照）
5. 編集画面（`edit.md`）がモーダル表示される

### 削除トリガー（忘却の儀式へ）

**トリガー**: 砂時計をクリック

**動作**:
1. 確認ダイアログ表示「この記憶を忘却しますか？（取り消し不可）」
2. 「はい」選択で忘却の儀式開始（`animations.md` 参照）
3. 削除成功後、一覧画面に留まる

---

## エラーハンドリング

| 状況 | 対応 |
|------|------|
| 取得失敗（404） | 一覧画面へ戻る + エラーメッセージ「記憶が見つかりません。」 |
| 削除失敗 | 保存失敗演出（`sfx_glitch_dissonance.wav`） + エラーメッセージ表示 |

エラーメッセージは `config/locales/ja.yml` 参照。

---

## データ送受信（API）

### 夢詳細取得

**エンドポイント**: `GET /api/v1/dreams/:id`

**レスポンス（成功: 200）**:
```json
{
  "id": 1,
  "title": "夢のタイトル",
  "content": "夢の本文...",
  "emotion_color": "peace",
  "lucid_dream_flag": false,
  "dreamed_at": "2025-01-15",
  "tags": [
    {"id": 1, "name": "田中", "yomi": "たなか", "category": "person"},
    {"id": 2, "name": "学校", "yomi": "がっこう", "category": "place"}
  ],
  "created_at": "2025-01-15T10:00:00.000Z",
  "updated_at": "2025-01-15T10:00:00.000Z"
}
```

### 夢削除

**エンドポイント**: `DELETE /api/v1/dreams/:id`

**レスポンス（成功: 204）**: No Content

**レスポンス（失敗: 404）**:
```json
{
  "error": "エラー種別",
  "message": "エラーメッセージ（日本語）"
}
```

**補足**: `config/locales/ja.yml`参照

---

## 演出

`animations.md` の以下のセクションを参照：
- 詳細画面（本の閲覧） > 編集トリガー（編集画面へ）
- 詳細画面（本の閲覧） > 本を閉じる（一覧へ戻る）
- ページめくり（詳細画面）
- 忘却の儀式（削除）

---

## 実装状況

### バックエンド（API）

- [x] GET /api/v1/dreams/:id（Dreams#show）
- [x] Jbuilderビュー（show.json.jbuilder）
- [x] DELETE /api/v1/dreams/:id（Dreams#destroy）

### フロントエンド

- [ ] HTMLビュー（モーダル）
- [ ] JavaScript（app/javascript/detail.js）
- [ ] CSS（app/assets/stylesheets/book.css）
- [ ] 画面表示
- [ ] 見開き本フレームUI
- [ ] ページ内容表示（左右ページ、HTML/CSSベース）
- [ ] ページ分割処理（JavaScript、500字/ページ）
- [ ] ページめくりアニメーション（3D rotateY）
- [ ] 本を開く演出（閉→半開き→見開き）
- [ ] 本を閉じる演出（見開き→半開き→閉）
- [ ] 編集トリガー→編集画面へ
- [ ] 削除トリガー→忘却の儀式
- [ ] 削除確認ダイアログ
- [ ] 本の外側クリックで閉じる
- [ ] ページ番号表示
- [ ] API連携（取得、削除）
- [ ] エラーハンドリング
- [ ] 演出・SE再生

**Note**: プロトタイプ（`prototype/`）に参考実装あり。Rails本体への統合が必要。

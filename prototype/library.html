<!DOCTYPE html>
<html lang="ja" class="after-door">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>夢日記帳 - 静寂の書斎</title>
    <link rel="stylesheet" href="css/style.css">
    <script>
        // チラつき完全防止：URL確認して即座にhtml要素にクラス追加
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('blink') === 'open') {
                document.documentElement.classList.add('will-open-eyes');
            }
        })();
    </script>
    <style>
        body {
            /* Asset: bg_library_desk.png (書斎の机の背景) */
            background-image: url('assets/bg_library_desk.png');
            background-size: cover;
            background-position: center;
            font-family: var(--font-pixel);
            color: var(--color-ink);
            cursor: grab;
            overflow: hidden;
        }

        /* Page-specific viewport background (書斎ページ専用背景) */
        .viewport-container {
            /* Asset: bg_library_desk.png (書斎の机の背景) */
            background-image: url('assets/bg_library_desk.png');
            background-size: cover;
            background-position: center;
        }

        /* Interactive areas (objects) - Positioning based on bg_library_desk.png */
        /* These positions are approximate and would need fine-tuning with the actual image */

        /* Desk / Scroll (夢を編む) */
        .interactive-area.desk-scroll {
            position: absolute;
            width: 25%;
            height: 30%;
            left: 50%;
            bottom: 0%;
            transform: translateX(-50%);
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            /* Asset: 巻物：上端/下端 (img_scroll_top_bottom.png) - not directly used here but implied for interaction */
        }

        /* 縮小版巻物UI（机上）5.4.2. 参照 */
        .desk-scroll-mini {
            position: relative;
            width: 250px; /* 画像アスペクト比に合わせて調整 */
            height: 127px; /* 1404:711のアスペクト比を維持 */
            margin-bottom: 0px; /* 画像とテキストの間隔なし */
            z-index: 9; /* desk-scrollより低い */
            cursor: pointer;
            transition: opacity 0.3s ease-in-out;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .desk-scroll-mini.hidden {
            display: none;
        }

        /* 縮小版巻物の画像切り替え（LocalStorage メモ有無） */
        .desk-scroll-mini.has-memo {
            background-image: url('assets/img_scroll_mini_draft.png');
        }

        .desk-scroll-mini.no-memo {
            background-image: url('assets/img_scroll_mini_blank.png');
        }

        /* Bookshelf (記憶の目録) */
        .interactive-area.bookshelf {
            position: absolute;
            width: 32%; /* サイズ縮小（80%） */
            height: 48%; /* サイズ縮小（80%） */
            left: 53%;
            top: 7%;
            transform: translateX(-50%);
            z-index: 5;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        /* 本棚画像バリエーション（夢の数に応じて切り替え） */
        .interactive-area.bookshelf.bookshelf-empty {
            background-image: url('assets/img_bookshelf_empty.png');
        }

        .interactive-area.bookshelf.bookshelf-small {
            background-image: url('assets/img_bookshelf_small.png');
        }

        .interactive-area.bookshelf.bookshelf-medium {
            background-image: url('assets/img_bookshelf_medium.png');
        }

        .interactive-area.bookshelf.bookshelf-large {
            background-image: url('assets/img_bookshelf_large.png');
        }

        /* Window (夢の氾濫) */
        .interactive-area.window {
            position: absolute;
            width: 20%;
            height: 40%;
            left: 0%;
            top: 10%;
            z-index: 7;
        }

        /* Mirror (目覚める / Logout) */
        .interactive-area.mirror {
            position: absolute;
            width: 15%;
            height: 35%;
            right: 0%;
            top: 25%;
            z-index: 8;
        }

        /* Dream Flood Overlay */
        .dream-flood-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 15;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out;
            background-color: rgba(75, 0, 130, 0.3); /* Placeholder for window/mirror distortion */
            background-size: cover;
            animation: distort-noise 1s infinite alternate; /* Continuous subtle distortion */
        }

        .dream-flood-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        @keyframes distort-noise {
            0% { filter: hue-rotate(0deg) blur(0px); }
            100% { filter: hue-rotate(360deg) blur(1px); }
        }

        .dream-fragment-text {
            color: var(--color-paper);
            font-family: var(--font-pixel);
            font-size: 20px;
            text-align: center;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--color-brass);
            max-width: 80%;
            position: relative;
            /* Mirror text effect */
            transform: scaleX(-1);
        }

        .dream-fragment-text:hover {
            transform: scaleX(1); /* Flip to normal on hover */
            filter: brightness(1.5);
        }

        /* Create/Edit Modal Overlay (書斎から夢を編むへ) */
        .create-edit-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9000;  /* blink overlay (10000) より低いが、他の要素より高い */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }

        .create-edit-modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Background blur layer (背景のぼかし層 - オーバーレイの背後) */
        .create-edit-modal-overlay::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0);
            filter: blur(8px) brightness(0.6);
            z-index: -1;
            pointer-events: none;
        }

        /* Scroll Middle Animation (scroll-middleの展開・収縮) */
        @keyframes scroll-unfurl {
            from {
                height: 0;
            }
            to {
                height: calc(95vh * 0.8 - 50px);  /* scroll-top(50px) + scroll-bottom(50px) - 負マージン(50px) */
            }
        }

        @keyframes scroll-roll-up {
            from {
                height: calc(95vh * 0.8 - 50px);
            }
            to {
                height: 0;
            }
        }

        /* Scroll Container (巻物の構造) */
        .scroll-container {
            display: flex;
            flex-direction: column;
            width: calc(95vh * 4 / 3 * 0.8);  /* viewport幅の80% */
            height: auto;  /* 子要素のサイズに応じて自動調整 */
            margin: 0 auto;  /* 中央に配置 */
            margin-top: calc(95vh * 0.05);  /* 上からの余白 */
            position: relative;
            z-index: 10;
            filter: drop-shadow(0px 10px 10px rgba(0,0,0,0.5)); /* 暫定的なドロップシャドウ */
        }

        /* scroll-middleの背景（常時表示） */
        .scroll-container::before {
            content: '';
            position: absolute;
            top: 25px;  /* scroll-topの高さ50px - 負マージン25px */
            left: 50%;
            transform: translateX(-50%);
            width: 85%;  /* scroll-middleと同じ幅 */
            bottom: 25px;  /* scroll-bottomの高さ50px - 負マージン25px */
            background-color: var(--color-paper);
            z-index: 0;
        }

        /* scroll-middle の展開・収縮アニメーション */
        .scroll-middle.unfurl {
            animation: scroll-unfurl 0.6s ease-out forwards;
        }

        .scroll-middle.roll-up {
            animation: scroll-roll-up 0.6s ease-in forwards;
        }

        .scroll-top {
            width: 100%;
            height: 50px;
            /* Asset: img_scroll_top_bottom.png (巻物：上端) */
            background-image: url('assets/img_scroll_top_bottom.png');
            background-size: 100% 100%;
            background-repeat: no-repeat;
            background-position: center;
            position: relative;
            z-index: 2;
        }

        .scroll-middle {
            height: 0;  /* 初期状態：閉じている */
            width: 85%;
            margin-left: auto;
            margin-right: auto;
            padding: 30px;
            box-sizing: border-box;
            background-color: var(--color-paper);  /* 感情彩色が上書きされる */
            overflow: hidden;
            position: relative;
            z-index: 1;
            margin-top: -25px;
            margin-bottom: -25px;
            display: flex;
            flex-direction: column;
        }

        .scroll-middle textarea {
            width: 100%;
            flex: 0 1 auto;
            height: 250px;
            border: none;
            background-color: transparent;
            font-family: var(--font-pixel);
            font-size: 16px;
            color: var(--color-ink);
            resize: none;
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .scroll-middle textarea::-webkit-scrollbar {
            display: none;
        }

        .scroll-middle textarea:focus {
            outline: none;
        }

        /* タイトル入力欄 */
        .dream-title-input {
            width: 100%;
            padding: 10px 0;
            border: none;
            border-bottom: 2px solid var(--color-brass-dark);
            background-color: transparent;
            font-family: var(--font-pixel);
            font-size: 20px;
            font-weight: bold;
            color: var(--color-ink);
            margin-bottom: 15px;
        }

        .dream-title-input:focus {
            outline: none;
            border-bottom-color: var(--color-brass);
        }

        .dream-title-input::placeholder {
            color: var(--color-ink-light);
            opacity: 0.6;
        }

        .tag-input-area {
            margin-top: 20px;
        }

        .tag-input-area h3 {
            font-size: 14px;
            margin: 10px 0 5px 0;
            color: var(--color-ink);
        }

        .tag-input-area input {
            width: 100%;
            padding: 5px;
            border: none;
            border-bottom: 1px solid var(--color-brass-dark);
            background-color: transparent;
            color: var(--color-ink);
            font-family: var(--font-pixel);
            margin-bottom: 10px;
        }

        .tag-input-area input:focus {
            outline: none;
            border-bottom-color: var(--color-brass);
        }

        .tag-input-area input::placeholder {
            color: var(--color-ink-light);
            opacity: 0.6;
        }

        .selected-tags-area {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .tag-badge {
            background-color: var(--color-brass-dark);
            color: var(--color-paper);
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tag-badge .remove-btn {
            cursor: pointer;
            font-weight: bold;
        }

        .scroll-bottom {
            width: 100%;
            height: 50px;
            /* Asset: img_scroll_top_bottom.png (巻物：下端・上下反転) */
            background-image: url('assets/img_scroll_top_bottom.png');
            transform: scaleY(-1); /* 上下反転 */
            background-size: 100% 100%;
            background-repeat: no-repeat;
            background-position: center;
            position: relative;
            z-index: 2;
        }

        /* Scroll Controls (インクボトルを画面下部中央に固定) */
        .scroll-controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: row;
            gap: 20px;
            z-index: 9100;  /* モーダルオーバーレイより上、blink より下 */
        }

        /* Emotion Ink Bottles (4色のインク瓶 - 横並び) */
        .ink-bottles {
            display: flex;
            flex-direction: row;
            gap: 10px;
        }

        .ink-bottle {
            width: 90px;
            height: 120px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            position: relative;
            transition: filter 0.2s;
            filter: drop-shadow(0px 5px 5px rgba(0,0,0,0.4));
        }
        .ink-bottle:hover {
            filter: brightness(1.2) drop-shadow(0px 5px 5px rgba(0,0,0,0.4));
        }

        /* インクボトルのラベル（ガラス部分に表示される漢字） */
        .ink-label {
            position: absolute;
            top: 68%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: var(--font-pixel);
            font-size: 20px;
            font-weight: bold;
            color: rgba(0, 0, 0, 0.7);
            letter-spacing: 2px;
            pointer-events: none;
            text-shadow: 0px 0px 2px rgba(255, 255, 255, 0.5);
            -webkit-text-stroke: 0.5px rgba(0, 0, 0, 0.5);
        }

        /* 各感情に対応するインクボトル画像 */
        .ink-bottle.peace {
            background-image: url('assets/img_ink_bottle_peace.png');
        }
        .ink-bottle.chaos {
            background-image: url('assets/img_ink_bottle_chaos.png');
        }
        .ink-bottle.fear {
            background-image: url('assets/img_ink_bottle_fear.png');
        }
        .ink-bottle.elation {
            background-image: url('assets/img_ink_bottle_elation.png');
        }

        .ink-bottle.selected {
            outline: 2px solid var(--color-brass); /* Highlight selected */
            outline-offset: -2px; /* Draw outline inside the element */
            filter: brightness(1.5) drop-shadow(0px 5px 10px currentColor);
        }

        /* Silver Bookmark (Save Button - scroll-containerの右端に揃える) */
        .save-bookmark {
            position: fixed;
            right: calc((100vw - (95vh * 4 / 3 * 0.8)) / 2);
            bottom: 30px;
            width: 75px;
            height: 120px;
            background-image: url('assets/icon_bookmark_silver.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            transition: transform 0.2s, filter 0.2s;
            filter: drop-shadow(0px 5px 5px rgba(0,0,0,0.4));
            z-index: 9100;
        }

        .save-bookmark:hover {
            transform: translateY(-5px);
            filter: brightness(1.2);
        }

        /* Silver Bookmark Glow Animation (保存時の発光演出 - しおりが挿さる動き) */
        @keyframes bookmark-glow {
            0% {
                transform: translateY(0) scale(1);
                filter: brightness(1) saturate(1);
            }
            50% {
                transform: translateY(-10px) scale(1.1);
                filter: brightness(1.5) saturate(2);  /* 金色で発光 */
            }
            100% {
                transform: translateY(0) scale(1);
                filter: brightness(1) saturate(1);
            }
        }

        .save-bookmark.glow {
            animation: bookmark-glow 0.3s ease-out;
        }
    </style>
</head>
<body>
    <!-- 4:3 Viewport with outer wall as background (from 5.5) -->
    <div class="viewport-container">
        <!-- Asset: bg_library_desk.png applied as body background -->

        <div class="interactive-area desk-scroll interactive-object" id="desk-scroll">
            <!-- インタラクティブ要素: 机の上の巻物。クリックで「夢を編む」ページへ遷移。 -->
            <!-- 縮小版巻物UI（机上）5.4.2. 参照 -->
            <p id="desk-scroll-text" style="color:white; text-align:center; margin:0 0 10px 0;">夢を編む (作成)</p>

            <div class="desk-scroll-mini interactive-object" id="desk-scroll-mini">
                <!-- Asset: LocalStorage メモ有無に応じて画像を切り替え（JavaScript） -->
            </div>
        </div>

        <div class="interactive-area bookshelf interactive-object" id="bookshelf">
            <!-- インタラクティブ要素: 本棚。クリックで「記憶の目録」ページへ遷移。 -->
            <p style="color:white; text-align:center; margin: 0;">記憶の目録 (一覧)</p>
        </div>

        <div class="interactive-area window interactive-object" id="window">
            <!-- インタラクティブ要素: 窓。クリックで「夢の氾濫」特殊ギミックを発動。 -->
            <p style="color:white; text-align:center;">窓 (夢の氾濫)</p>
        </div>

        <div class="interactive-area mirror interactive-object" id="mirror">
            <!-- インタラクティブ要素: 鏡。クリックで「目覚める」（ログアウト処理）を発動。 -->
            <p style="color:white; text-align:center;">鏡 (目覚める)</p>
        </div>

        <!-- Dream Flood Overlay -->
        <div class="dream-flood-overlay" id="dream-flood-overlay">
            <div class="dream-fragment-text">
                <p>「遠くで鐘が鳴っている」</p>
                <p>「鍵は開いたままだ」</p>
                <p>「しかし、誰もそこにはいない」</p>
                <p>「霧が、深く、深く…」</p>
            </div>
        </div>
    </div>

    <!-- Create/Edit Modal Overlay -->
    <div class="create-edit-modal-overlay" id="create-edit-modal-overlay">
        <div class="scroll-container" id="scroll-container">
            <div class="scroll-top"></div>
            <div class="scroll-middle">
                <input type="text" id="dream-title-input" class="dream-title-input" placeholder="タイトル">
                <textarea id="dream-textarea" placeholder="夢の内容をここに書き記す..."></textarea>
                <div class="tag-input-area">
                    <h3>登場人物</h3>
                    <input type="text" id="character-tag-input" placeholder="登場人物名を入力">
                    <div id="character-tags-display" class="selected-tags-area"></div>
                    <h3>場所</h3>
                    <input type="text" id="location-tag-input" placeholder="場所名を入力">
                    <div id="location-tags-display" class="selected-tags-area"></div>
                </div>
            </div>
            <div class="scroll-bottom"></div>
        </div>
        <!-- Scroll Controls (Ink Bottles) -->
        <div class="scroll-controls">
            <!-- Emotion Ink Bottles (4色のインク瓶) -->
            <div class="ink-bottles">
                <div class="ink-bottle peace interactive-object" data-emotion="peace">
                    <span class="ink-label">平穏</span>
                </div>
                <div class="ink-bottle chaos interactive-object" data-emotion="chaos">
                    <span class="ink-label">混沌</span>
                </div>
                <div class="ink-bottle fear interactive-object" data-emotion="fear">
                    <span class="ink-label">恐怖</span>
                </div>
                <div class="ink-bottle elation interactive-object" data-emotion="elation">
                    <span class="ink-label">高揚</span>
                </div>
            </div>
        </div>
        <!-- Silver Bookmark (Save Button) -->
        <div class="save-bookmark interactive-object" id="library-save-bookmark"></div>
    </div>

    <script src="js/script.js"></script>
    <script>
        // グローバル関数: 作成編集モーダルを開く
        function openCreateEditModal(isEdit = false) {
            const createEditModalOverlay = document.getElementById('create-edit-modal-overlay');
            const scrollMiddle = document.querySelector('.scroll-middle');
            const deskScrollMini = document.getElementById('desk-scroll-mini');
            const deskScrollText = document.getElementById('desk-scroll-text');

            console.log('[openCreateEditModal] Starting create/edit modal open sequence, isEdit:', isEdit);

            // 瞬き演出を実行
            closeEyes(() => {
                console.log('[openCreateEditModal] Eyes closed, displaying modal...');

                // 瞬き中に縮小版巻物とテキストを非表示にする（机の上の巻物が手に取られた感覚を演出）
                if (deskScrollMini) {
                    deskScrollMini.classList.add('hidden');
                    console.log('[openCreateEditModal] Desk scroll mini hidden during blink');
                }
                if (deskScrollText) {
                    deskScrollText.classList.add('hidden');
                    console.log('[openCreateEditModal] Desk scroll text hidden during blink');
                }

                // 瞬き中にモーダルオーバーレイを表示（巻物は見えない状態：scroll-middle height 0）
                createEditModalOverlay.classList.add('active');

                // 開眼を実行（50msの小さなバッファを追加して、モーダル表示を確実に）
                console.log('[openCreateEditModal] Opening eyes...');
                setTimeout(() => {
                    console.log('[openCreateEditModal] Calling openEyes()...');
                    openEyes();

                    // 目が開いた後、点滅アニメーション完了後に巻物の展開アニメーションを開始
                    setTimeout(() => {
                        console.log('[openCreateEditModal] Starting scroll-middle unfurl animation...');
                        scrollMiddle.classList.add('unfurl');
                        // playSound('sfx_scroll_unfurl.wav'); // Asset: 巻物を広げる音
                    }, 500); // openEyes()の点滅アニメーション完了を待つ
                }, 50);
            });
        }

        // グローバル関数: 作成編集モーダルを閉じる
        function closeCreateEditModal() {
            const createEditModalOverlay = document.getElementById('create-edit-modal-overlay');
            const scrollMiddle = document.querySelector('.scroll-middle');
            const deskScrollMini = document.getElementById('desk-scroll-mini');
            const deskScrollText = document.getElementById('desk-scroll-text');

            console.log('[closeCreateEditModal] Starting close sequence...');

            // 巻物収縮アニメーション開始
            console.log('[closeCreateEditModal] Starting scroll-middle roll-up animation...');
            scrollMiddle.classList.remove('unfurl');
            scrollMiddle.classList.add('roll-up');
            // playSound('sfx_scroll_roll_up.wav'); // Asset: 巻物の収束音

            // 巻物収縮完了後に瞬きを実行（巻物から本への遷移を隠蔽、または机に戻す）
            setTimeout(() => {
                console.log('[closeCreateEditModal] Starting blink animation after scroll collapse...');

                closeEyes(() => {
                    console.log('[closeCreateEditModal] Eyes closed, preparing modal closure...');

                    // 瞬き中にモーダルを閉じる
                    createEditModalOverlay.classList.remove('active');
                    scrollMiddle.classList.remove('unfurl', 'roll-up');

                    // scroll-middleの色とインクボトルの選択状態をリセット（瞬き中）
                    const inkBottlesForReset = document.querySelectorAll('.ink-bottle');
                    if (scrollMiddle) {
                        scrollMiddle.style.backgroundColor = ''; // CSSデフォルトに戻す
                    }
                    inkBottlesForReset.forEach(b => b.classList.remove('selected'));
                    console.log('[closeCreateEditModal] Scroll color and ink bottle selection reset during blink');

                    // フォーム入力内容をクリア（保存時のリセット）
                    const dreamTitleInput = document.getElementById('dream-title-input');
                    const dreamTextarea = document.getElementById('dream-textarea');
                    const characterTagInput = document.getElementById('character-tag-input');
                    const locationTagInput = document.getElementById('location-tag-input');
                    const characterTagsDisplay = document.getElementById('character-tags-display');
                    const locationTagsDisplay = document.getElementById('location-tags-display');

                    if (dreamTitleInput) dreamTitleInput.value = '';
                    if (dreamTextarea) dreamTextarea.value = '';
                    if (characterTagInput) characterTagInput.value = '';
                    if (locationTagInput) locationTagInput.value = '';
                    if (characterTagsDisplay) characterTagsDisplay.innerHTML = '';
                    if (locationTagsDisplay) locationTagsDisplay.innerHTML = '';
                    console.log('[closeCreateEditModal] Form inputs cleared for next use');

                    // 瞬き明け
                    setTimeout(() => {
                        console.log('[closeCreateEditModal] Opening eyes and restoring desk scroll mini...');
                        openEyes();
                    }, 50);

                    // 縮小版巻物とテキストを瞬きのタイミングで確実に再表示
                    setTimeout(() => {
                        if (deskScrollMini) {
                            deskScrollMini.classList.remove('hidden');
                            console.log('[closeCreateEditModal] Desk scroll mini shown - returned to desk');
                        }
                        if (deskScrollText) {
                            deskScrollText.classList.remove('hidden');
                            console.log('[closeCreateEditModal] Desk scroll text shown - returned to desk');
                        }
                    }, 100); // 瞬き明けのアニメーション完了後に表示
                });
            }, 600); // 巻物アニメーション時間に合わせる（0.6s = 600ms）
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Check for opening eyes animation (from page transition)
            checkAndOpenEyes();

            const deskScroll = document.getElementById('desk-scroll');
            const bookshelf = document.getElementById('bookshelf');
            const windowElement = document.getElementById('window');
            const mirror = document.getElementById('mirror');
            const dreamFloodOverlay = document.getElementById('dream-flood-overlay');
            const createEditModalOverlay = document.getElementById('create-edit-modal-overlay');

            // Play ambient sound (placeholder)
            // Commented out: playSound('sfx_library_ambience.mp3'); // Asset: 書斎の環境音 (loop)

            // Desk/Scroll click (夢を編む機能への遷移 - モーダル方式)
            deskScroll.addEventListener('click', () => {
                playSound('sfx_ui_confirm.wav'); // Asset: 選択・決定音
                openCreateEditModal(false); // false = 新規作成モード
            });

            // Create/Edit Modal: 外クリックで閉じる
            createEditModalOverlay.addEventListener('click', (e) => {
                if (e.target === createEditModalOverlay) {
                    closeCreateEditModal();
                    playSound('sfx_ui_confirm.wav'); // Asset: 選択・決定音
                }
            });

            // Bookshelf click (記憶の目録機能への遷移)
            bookshelf.addEventListener('click', () => {
                // Asset: ズームイン/アウト音 (sfx_zoom_in_out.wav)
                // 書斎から一覧へ（別ページ遷移）
                navigateWithBlink('list.html');
            });

            // Window click (夢の氾濫ギミックの発動)
            windowElement.addEventListener('click', () => {
                playSound('sfx_glass_warp.wav'); // Asset: ガラスの歪む音
                dreamFloodOverlay.classList.add('active');
                // Auto-hide after 1 minute, or click outside to close
                setTimeout(() => {
                    if (dreamFloodOverlay.classList.contains('active')) {
                        dreamFloodOverlay.classList.remove('active');
                    }
                }, 60000); // 1 minute
            });
            
            // Click outside dream flood text to close
            dreamFloodOverlay.addEventListener('click', (event) => {
                if (event.target === dreamFloodOverlay) { // Only if clicking the overlay itself, not the text
                    dreamFloodOverlay.classList.remove('active');
                    playSound('sfx_ui_confirm.wav'); // Asset: 選択・決定音 (オーバーレイを閉じる確認音)
                }
            });

            // Save Bookmark click (Save/Close create-edit modal - 定着の儀式)
            const saveBookmark = document.getElementById('library-save-bookmark');
            saveBookmark.addEventListener('click', () => {
                console.log('[Save Bookmark] Save button clicked - initiating save ritual');

                // 栞の発光演出（保存の儀式を視覚的に表現）
                console.log('[Save Bookmark] Starting bookmark glow animation...');
                saveBookmark.classList.add('glow');
                playSound('sfx_ui_confirm.wav'); // Asset: 選択・決定音

                // 発光アニメーション完了後にモーダルを閉じる
                setTimeout(() => {
                    console.log('[Save Bookmark] Glow animation complete, closing modal...');
                    closeCreateEditModal();
                    // playSound('sfx_scroll_roll_up.wav'); // Asset: 巻物の収束音 (closeCreateEditModal内で実行)

                    // アニメーション終了後にglowクラスを削除
                    setTimeout(() => {
                        saveBookmark.classList.remove('glow');
                    }, 600); // closeCreateEditModalの処理時間に合わせる
                }, 300); // bookmark-glowアニメーションの時間
            });

            /* ============================================================
             * 段階2：本の実体化アニメーション（将来実装：アセット到着時に有効化）
             * ============================================================
             *
             * Assets Required:
             * - img_book_closed_front.png (本：正面（閉）)
             * - img_book_half_open.png (本：半分開きかけ)
             *
             * Animation Sequence (Timing: 栞の発光完了後 0.3s に開始):
             * 1. 巻物の中間部分が高速で縮小（Height: 0）
             *    - Sound: sfx_scroll_roll_up.wav（巻物の収束音）
             *
             * 2. 本のパラパラ漫画アニメーション（モーダル内中央）
             *    - img_book_half_open.png を表示（0.1s〜0.2s）
             *    - img_book_closed_front.png に切り替わる
             *    - Sound: sfx_book_close.wav（重厚な閉本音）を同期
             *
             * 3. 本が飛び去る演出
             *    - 本がモーダル背後の本棚へ縮小しながら飛んでいく
             *    - モーダルが閉じる
             *    - 書斎のぼかしが解除される
             *
             * 4. 本棚のテクスチャ更新
             *    - 蔵書数に応じて段階（小/中/大）へ更新
             *
             * Note: テキスト内容は表示しない（本のビジュアルアニメーションのみ）
             * Deferred: Assets未到着のため、段階1（発光演出）のみ実装
             * Status: 詳細な仕様で実装準備完了、アセット到着時に実装可能
             * ============================================================ */

            // Ink bottle click (感情選択 - scroll-middleの背景色変更)
            const inkBottles = document.querySelectorAll('.ink-bottle');
            const scrollMiddle = document.querySelector('.scroll-middle');

            // 感情と色の対応
            const emotionColors = {
                peace: '#a0a9a6',
                chaos: '#b07a70',
                fear: '#838387',
                elation: '#ca9e63'
            };

            inkBottles.forEach(bottle => {
                bottle.addEventListener('click', () => {
                    const emotion = bottle.dataset.emotion;

                    // 全てのボトルから選択状態を解除
                    inkBottles.forEach(b => b.classList.remove('selected'));

                    // クリックしたボトルを選択状態に
                    bottle.classList.add('selected');

                    // scroll-middleの背景色を変更
                    if (scrollMiddle && emotionColors[emotion]) {
                        scrollMiddle.style.backgroundColor = emotionColors[emotion];
                    }

                    playSound('sfx_ui_confirm.wav'); // Asset: 選択・決定音
                    console.log(`Emotion selected: ${emotion}, color: ${emotionColors[emotion]}`);
                });
            });

            // Mirror click (Logout - 目覚める儀式)
            mirror.addEventListener('click', () => {
                // Mirror effect (wave distortion)
                console.log('Mirror clicked - initiating awakening effect');

                // Logout sequence with awakening effect (3.4.1)
                logoutWithAwakeningEffect();
            });
        });
    </script>
</body>
</html>

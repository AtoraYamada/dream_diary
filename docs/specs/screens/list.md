# 夢一覧画面（記憶の目録）

本棚に背表紙が並ぶ形式で、日付順（降順）固定表示。ページネーション付き。

---

## 要件

- 夢日記を日付順（降順）で一覧表示
- 背表紙形式（感情彩色で色分け）
- ページネーション（本棚ページ切替）
- 索引箱から検索画面へ
- コールドスタート対策（0件時はチュートリアル本表示）

---

## 設計判断

| 項目 | 選択 | 理由 |
|------|------|------|
| 表示順序 | 日付降順（固定） | 最新の夢を優先表示 |
| ページあたり件数 | 12件 | 本棚の視覚的なバランス |
| ホバー/タップ | 2段階（1.タイトル表示、2.詳細遷移） | モバイル対応 |
| ページ遷移演出 | 瞬き + 画面スライド | API遅延の隠蔽 |

---

## 画面構成

| レイヤー | 要素 | 説明 |
|---------|------|------|
| 背景 | 壁面アップ | 本棚が置かれている壁面（`bg_library_wall_up.png`） |
| 中景 | 本棚本体 | 空の棚（`img_bookshelf_empty.png`） |
| 前景 | 背表紙 | 感情彩色に応じた背表紙画像（`img_book_spine_*.png`） |
| 前景 | タイトル | 背表紙上に縦書きで表示（ホバー/1タップで浮遊表示） |
| 前景（端） | 真鍮製銘板 | 「一号館」「二号館」等（ページネーション現在地表示） |
| 前景（脇） | 索引箱 | 検索機能へのアクセス（`img_index_box_exterior.png`） |
| 前景（左上） | 戻るボタン | 書斎へ戻る（`icon_back.png`） |

---

## UI動作

### 一覧表示（書斎から）

**トリガー**: 書斎の本棚をクリック（`library.md` 参照）

**動作**:
- 夢日記が日付順（降順）で表示される
- ページネーション付き（12件/ページ）

### 背表紙ホバー / 1タップ（タイトル表示）

**トリガー**: 背表紙にホバー（PC）/ 1タップ（モバイル）

**動作**:
- タイトルが浮遊表示される（300ms）
- リフト効果（scale 1.03, translateY -5px）

### 背表紙クリック / 2タップ（詳細へ）

**トリガー**: 背表紙をクリック（PC）/ 2タップ（モバイル）

**動作**:
1. 瞬き演出（`animations.md` 参照）
2. 瞬き（暗転中）: クリックされた本の背表紙を非表示に
3. 背景のぼかし（一覧画面が減光・ぼかし）
4. 本が開くアニメーション（閉→半開き→見開き、600ms）
5. SE: `sfx_page_turn.wav`
6. 詳細画面（`detail.md`）がモーダル表示される

### ページネーション（左右端クリック）

**トリガー**: 画面左右端をクリック

**動作**:
1. 瞬き演出（ラグ隠蔽）
2. 画面スライド演出（400ms）
3. SE: `sfx_screen_slide.wav`
4. 隣の本棚ページへ移動

### 索引箱をクリック（検索へ）

**トリガー**: 索引箱をクリック

**動作**:
1. 索引箱の開閉音（即時）: `sfx_index_box_open_close.wav`
2. 瞬き演出（`animations.md` 参照）
3. 検索画面（`search.md`）がモーダル表示される

### 戻るボタン（書斎へ）

**トリガー**: 左上の戻るボタンをクリック

**動作**:
1. ズームアウト（300ms）: `sfx_zoom_in_out.wav`
2. 瞬き演出（`animations.md` 参照）
3. 書斎画面（`library.md`）へ戻る

---

## エラーハンドリング

| 状況 | 対応 |
|------|------|
| API取得失敗 | エラーメッセージ表示「記憶が霞んでいます。しばらくしてから再度お試しください。」 |
| 0件（初回） | 「先代の主の手記」チュートリアル本を表示 |

---

## コールドスタート対策（チュートリアル本）

### 概要

ユーザー作成時に自動生成される「先代の主の手記」。夢日記が0件の場合に本棚に表示され、使い方ガイドとして機能する。

### 仕様

**自動生成タイミング**: User 作成時（after_create コールバック）

**データ**:
- タイトル: 「先代の主の手記」
- 感情彩色: peace（青系）
- dreamed_at: ユーザー作成日時
- lucid_dream_flag: false
- タグ: なし

**内容（本文）**:
```
ここは夢の記録館。

この手記を開いたあなたは、新たな記憶の管理者となった。
先代の主が遺した手引きを記しておく。

■ 記憶の記録
巻物を開き、夢の記録を綴る。
タイトル、本文、見た日、感情の色、登場人物や場所を記す。

■ 記憶の整理
本棚には日付順に夢が並ぶ。
索引箱で人物や場所から夢を探せる。

■ 記憶の回顧
背表紙を開けば、過去の夢を再び読める。
編む（編集）こともできる。

■ 記憶の忘却
不要な記憶は削除できる。儀式が執り行われる。

■ 夢の氾濫
窓から溢れる記憶の断片。
ランダムに夢の一節が現れる。

さあ、あなたの夢を記録しよう。
```

**表示条件**: 夢日記が0件の場合のみ本棚に表示

---

## データ送受信（API）

### 夢一覧取得

**エンドポイント**: `GET /api/v1/dreams`

**クエリパラメータ**:
| パラメータ | 型 | 説明 |
|-----------|-----|------|
| page | integer | ページ番号（デフォルト: 1） |
| per_page | integer | 1ページあたり件数（デフォルト: 12） |

**レスポンス（成功: 200）**:
```json
{
  "dreams": [
    {
      "id": 1,
      "title": "夢のタイトル",
      "emotion_color": "peace",
      "lucid_dream_flag": false,
      "dreamed_at": "2025-01-15",
      "tags": [
        {"id": 1, "name": "田中", "yomi": "たなか", "category": "person"}
      ]
    }
  ],
  "pagination": {
    "current_page": 1,
    "total_pages": 3,
    "total_count": 25,
    "per_page": 12
  }
}
```

---

## 演出

`animations.md` の以下のセクションを参照：
- 一覧画面（本棚） > 背表紙ホバー / 1タップ（タイトル表示）
- 一覧画面（本棚） > 背表紙クリック / 2タップ（詳細へ）
- 一覧画面（本棚） > ページネーション（左右端クリック）
- 一覧画面（本棚） > 索引箱をクリック（検索へ）
- 一覧画面（本棚） > 戻るボタン（書斎へ）

---

## 実装状況

### バックエンド（API）

- [x] GET /api/v1/dreams（Dreams#index、ページネーション対応）
- [x] Jbuilderビュー（index.json.jbuilder）
- [x] Kaminariページネーション
- [ ] チュートリアル本自動生成（User作成時 after_create）

### フロントエンド

- [ ] HTMLビュー（app/views/pages/list.html.erb）
- [ ] JavaScript（app/javascript/list.js）
- [ ] CSS（app/assets/stylesheets/list.css）
- [ ] 画面表示
- [ ] 本棚UI
- [ ] 背表紙表示（感情彩色による画像切替）
- [ ] タイトル縦書き・浮遊表示（ホバー/1タップ）
- [ ] 背表紙クリック（2タップ）→詳細画面へ
- [ ] ページネーション UI・API連携
- [ ] 画面スライド演出
- [ ] 索引箱クリック→検索画面へ
- [ ] 戻るボタン（ズームアウト→書斎へ）
- [ ] エラーハンドリング
- [ ] 演出・SE再生

**Note**: プロトタイプ（`prototype/`）に参考実装あり。Rails本体への統合が必要。

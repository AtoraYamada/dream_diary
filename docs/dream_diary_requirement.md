# 要件定義書：夢日記帳 (Dream Library)

## 1. プロジェクト概要
夢で見た内容を「忘れないうちに記録」し、「自分だけの書斎」に蓄積していくWebアプリ。
Mystのような没入感のある世界観と、PS1時代のレトロな質感を重視し、単なる実用ツールではなく「体験」としての夢日記を提供する。

## 2. ユーザー体験 (UX) フロー
1. **【現実】** トップページ（森の扉）にアクセス。音声推奨文とミュートボタンを確認。
2. **【移行】** 扉をクリック。ズームと瞬きの演出を経て、扉の開く音と共にログイン・サインアップ画面へ。
3. **【境界】** ログイン前に殴り書きしたメモ（LocalStorage）を保持したままサインアップ/ログイン。
4. **【夢の中】** 「夢の書斎（マイページ）」へ到達。
5. **【定着】** 机の上のメモから「夢を編む（作成）」へ。メモがなくても作成可能。
6. **【一覧】** 本棚から「記憶の目録（一覧）」へ。索引箱で検索が可能。
7. **【閲覧】** 本棚に収まっている本をクリック。夢日記が開く。
8. **【編集・削除】** 閲覧ページから編集へ。削除も可能。
9. **【氾濫】** 「夢の書斎（マイページ）」の窓をクリックで、夢日記からランダムな文を抽出、その場限りの夢の断片生成。
10. **【目覚め】** 「夢の書斎（マイページ）」の鏡をクリックでログアウト。「夢から覚める」演出を経て、トップページ（現実）へ戻る。

## 3. 機能要件

### 3.1. CRUD対応表

| 画面名（世界観呼称） | 主要オブジェクト | CRUD | 状態管理の主体 | 備考 |
| :--- | :--- | :---: | :--- | :--- |
| **現実（トップ）** | 殴り書きの紙片 | **C** | LocalStorage | ログイン前の一時保存 |
| **入館手続き（Auth）** | 入館証 | **R** | Session/DB | ログイン・サインアップ |
| **静寂の書斎（メイン）** | 巻物・窓・正面本棚・鏡 | **-** | Session | 各機能へのハブ、特殊演出、鏡でログアウト |
| **夢を編む（作成/編集）** | 巻物 | **C / U** | DB (API) | LocalStorageからデータ継承 |
| **記憶の目録（一覧）** | 正面本棚・背表紙・索引箱 | **R** | DB (API) | 索引（検索・絞り込み）、ページネーション |
| **記憶の断片（詳細）** | 見開きの本 | **R / D** | DB (API) | 夢の削除（忘却演出） |

### 3.2. 現実（トップページ）と殴り書きメモ
トップページは「夢が消える前に捕まえる」切迫感と没入感を優先する。

- **トップページ演出:** 扉クリック時の瞬き演出と「重厚な扉の開閉音」再生
- **UI構成:**
  - **初期状態:** 森の扉の傍らに、小さな「紙片」が落ちている
  - **展開時:** 紙片をクリックすると画面中央に「殴り書きの紙片」がオーバーレイ表示。背景は減光
  - **現実の質感:** 素朴な「紙片」と「鉛筆カーソル/筆記音」で、夢の中の豪華な巻物と対比
- **インタラクション:**
  - **自動保存:** 1文字入力ごとにLocalStorageへ保存。保存ボタンは置かない
  - **鉛筆の演出:** フォーカス中のみカーソルが「鉛筆」に変化、「鉛筆の筆記音」ループ再生
  - **閉じるボタン:** 明確に閉じる。誤って途中で閉じないように
- **ライフサイクルと継承ルール:**
  - **発生と復元:** 未ログイン状態で入力された内容はLocalStorageに自動保存。DB保存成功まで復元可能
  - **継承（新規作成時）:** ログイン後の「夢を編む」画面でLocalStorageの内容を初期値として展開
  - **隔離（既存編集時）:** 既存の夢を編集する際はLocalStorageを参照しない
  - **消去:** DB保存成功時にLocalStorageを消去
  - **タイムスタンプ管理:** 最終入力日時を付与し、DBより新しければ復元を提案
- **入力制限:** 最大2,000文字
- **音声管理:** 画面中央上部に音声推奨文、右上にミュートボタン
- **ブラウザ音声対応:** 扉クリック時にAudioContextを有効化し、以降SE再生可能にする

### 3.3. 入館手続き（認証）
現実から夢（書斎）へアクセスするための「手続きの場」。

- **ユーザー管理:** ログイン、サインアップ、ログアウト機能
- **ビジュアルコンセプト:**
  - 前景にバインダーと「継続（ログイン）」「新規（サインアップ）」のカード
  - 継続は古びれた紙、新規は綺麗な新しい紙で視覚的に差別化
  - 背景はシュールで幾何学的な廊下
- **切り替えUI:** カードクリックで「カードの摩擦音」と共にスライドアニメーション
- **遷移演出:** 成功時、「境界を越える音」と瞬き演出を経て書斎へ
- **認証エラー演出:** 入力文字が砂のように崩れ落ち、「砂の崩落音」と共に儚いエラーメッセージ表示
- **戻るボタン:** 左上にトップページへ戻るボタン

### 3.4. 静寂の書斎（メインハブ）
アプリのハブとなる画面。「ポイント＆クリック」形式。

- **レイアウト:**
  - **手前（机）:** 「縮小版巻物」→『夢を編む（作成）』へ
  - **正面（奥の壁）:** 「本棚」→『記憶の目録（一覧）』へ
  - **左側（窓）:** 「窓」→『夢の氾濫』演出
  - **隅（鏡）:** 「鏡」→ログアウト演出
- **視覚的示唆:** クリック可能なオブジェクトはホバー時に発光
- **音響:** 「書斎の環境音」をループ。トップページ以外の共通BGM

#### 3.4.1. 目覚めの儀式（ログアウト演出）
1. **鏡の反応:** ホバーで鏡が光る
2. **第1の瞬き:** クリックで「境界を越える音」と共に暗転
3. **覚醒の兆候:** トップページの森がぼかし状態で表示。霞がかったSE
4. **第2の瞬き:** 再度瞬き演出
5. **完全な覚醒:** ピントが合ったトップページが表示され操作可能に

### 3.5. 夢を編む（作成・編集）
巻物スクロールに直接文字を書き込む没入型UI。作成は書斎が背景、編集は一覧が背景。

- **UI構造:** 羽ペンカーソル、縦スクロールの巻物（上端（画像）＋入力エリア＋下端（画像））
- **データ読み込み:**
  - **新規作成:** LocalStorageがあれば初期値としてロード
  - **既存編集:** DBの保存データを優先。LocalStorageは参照しない
- **入力フィールド:**
  - **タイトル（必須）:** 最大15文字、リアルタイム文字数表示
  - **夢を見た日（必須）:** 日付選択、デフォルトは現在日付
  - **本文（必須）:** 最大10,000文字、リアルタイム文字数表示
  - **感情彩色（必須）:** 「平穏・混沌・恐怖・高揚」の4色インク瓶から選択
  - **タグ（オプション）:** 「登場人物」「場所」の2カテゴリ
- **音響:** 入力中は「羽ペンの筆記音」ループ、感情選択時は「インクの滴り音」
- **保存ボタン:** 銀の栞

#### 3.5.1. タグ登録機能
- **UI:** 巻物の入力エリア直下に「登場人物」「場所」の入力フィールド
- **入力支援:** 過去のタグからサジェスト/オートコンプリート
- **タグバッジ:** 追加されたタグは「×」ボタン付きバッジで表示

#### 3.5.2. 作成・定着の画面遷移フロー

**A. 作成開始（書斎→作成）:**
1. 机上の縮小版巻物オブジェクトをクリック
2. 瞬き演出。書斎背景をぼかす
3. モーダルとして巻物が出現・展開。「巻物を広げる音」再生
4. 机上の縮小版巻物は非表示に（手に取られた感覚）

**B. 定着（新規保存）:**
1. 銀の栞をクリック。一瞬発光
2. 巻物が縮小。「巻物の収束音」再生
3. 瞬き演出。縮小版巻物を再表示
4. **瞬き明け後**、本が実体化アニメーション（半分開き→閉じる）。「重厚な閉本音」再生
5. 本が本棚へ飛翔。「吸入・飛翔音」再生
6. モーダル閉じ、書斎復帰。本棚の蔵書画像が更新

**C. 更新時（既存編集の保存）:**
1. 銀の栞をクリック。巻物が縮小。「巻物の収束音」再生
2. 瞬き演出開始
3. **暗転中に**、暗闇から本が実体化アニメーション（半分開き→閉じる）。「重厚な閉本音」再生
4. 実体化した本は暗闇に溶け込むように消える
5. 瞬き明けで直接「一覧画面」へ遷移（モーダル削除）
6. 編集した本の背表紙が「キラリ」と光る。「光の音」再生

### 3.6. 記憶の目録（一覧）
本棚に背表紙が並ぶ形式で、日付順（降順）固定表示。

- **構造:** 書斎の壁（背景）＋本棚本体（背景の上に配置）＋背表紙＋タイトル（縦書き）
- **ページネーション:** 左右端クリックで「画面スライド音」と共に隣の本棚へ。瞬きロードでラグを隠蔽
- **現在地表示:** 本棚端に真鍮製銘板（「一号館」「二号館」等）
- **背表紙:** 通常時はタイトル非表示、ホバー/1タップでタイトル浮遊表示
- **フィルタリング:** 本棚脇の索引箱で検索
- **コールドスタート対策:** 0件時は「先代の主の手記」チュートリアル本を配置

**画面遷移フロー（書斎→一覧）:**
1. 本棚オブジェクトをクリック。ズームイン。「ズーム移動音」再生
2. 瞬き演出
3. 一覧表示

### 3.7. 記憶の断片（詳細）と忘却（削除）

**モーダル表示:**
- **開く時:** 背表紙クリック→瞬き→背景ぼかし→本が開くアニメーション（閉→半開→見開き）。「ページをめくる音」再生
- **閉じる時:** 瞬き不要。本の外をクリック→本が閉じるアニメーション（見開き→半開き→閉）。「重厚な閉本音」と共に本棚へ戻る

**UI構造:** 見開き本（画像）とページ部分。ページ遷移は簡易3D。「ページをめくる音」

**忘却の儀式（削除）:**
1. 砂時計が逆回転。「砂時計の回転音」再生
2. 文字がインクのように滲み霧散。「インクの滲む音」再生
3. 本がフェードアウト
4. 本棚へ戻り、空隙ができる
5. 数秒後、隣の本がスライドして隙間を埋める

**UI:**
- **忘却ボタン:** アンティークな砂時計
- **編集トリガー:** 修正用の羽ペンとペーパーナイフ（砂時計の上方に配置）

**画面遷移フロー（詳細→編集）:**
1. 羽ペンとナイフをクリック
2. 本が閉じるアニメーション。「重厚な閉本音」再生
3. 瞬き演出
4. 編集巻物モーダルが出現・展開。「巻物を広げる音」再生

### 3.8. 索引を辿る（検索）
本棚傍の「索引箱」をクリックで起動。「索引箱の開閉音」と瞬き演出を経て引き出しモーダル表示。

#### 3.8.1. UI構造
- **ヘッダー:** 選択中タグのバッジ表示、タグ絞り込み窓、タイトル・本文検索窓
- **カードリスト:** 全タグがカードで表示。五十音順。ホバーで「索引カードをめくる音」
- **インデックス:** 右端に「あ」「か」「さ」…「英」「他」の真鍮製プレート
- **フッター:** 「抽出」「開架」ボタン

#### 3.8.2. 検索操作フロー（AND検索）
1. 索引箱クリック→瞬き→引き出し表示
2. タグカードをクリックで選択（「ピン留め音」、ピン留めアイコン表示）
3. タイトル・本文検索窓にキーワード入力（スペース区切り）
4. 「抽出」クリック→瞬き→本棚に結果表示

#### 3.8.3. 補助機能
- **選択解除:** タグバッジの「×」クリック
- **リセット:** 「開架」クリック→瞬き→全表示に戻る
- **タグ絞り込み:** 表示名・読みがな両方で検索可能
- **五十音ジャンプ:** インデックスクリックでスクロール
- **タグ削除:** タグカード右下の「破れた紙片」クリック→風化アニメーションで消滅

#### 3.8.4. データ要件（読みがな）
- **表示名 (name):** ユーザー入力文字列
- **読みがな (yomi):** ひらがな読み（自動生成）
- **五十音インデックス (yomi_index):** 「あ」〜「他」（自動生成）

### 3.9. 夢の氾濫（特殊演出）
- **トリガー:** 書斎の「窓」をクリック
- **生成ロジック:** 最大10冊の夢日記から句点単位で分割、5〜8文をランダム結合。直近多用タグを優先抽出
- **フォールバック:** DB不足時はプリセット文章（『遠くで鐘が鳴っている』等）を混入
- **視覚演出:**
  - 「ガラスの歪む音」と共に窓が歪む
  - 感情彩色付きの文字が窓から流入
  - 画面中央に「鏡文字」として表示
  - ホバー/長押しで正像に反転
- **解除:** 背景クリック、または1分放置で自動解除

### 3.10. 横断的要件

**メタデータ:**
- **タグ:** 「登場人物」「場所」の2軸
- **明晰夢チェック:** 「これは夢だと気づいていたか」
- **感情彩色:** 「平穏・混沌・恐怖・高揚」から選択
  - 作成・編集時の巻物の紙色に適用
  - 背表紙、閉じた本、半開きの本、見開きの本すべてに適用

**モバイル・レスポンシブ:**
- LocalStorageは端末固有（同期なし）
- ホバー→2段階タップ（1.タイトル表示、2.詳細遷移）
- 一覧/詳細は横持ち推奨、作成/編集は縦持ち最適化

**保存失敗時:**
- 通信中は巻物が震える
- 失敗時はLocalStorage保持、専用避難領域（`lost_dream_fragment`）へ退避
- PS1風ノイズ、「不協和音（グリッチ音）」と共に「記憶が定着しません。霧が深すぎます。」等のメッセージ表示
- 最終救済: クリップボードへコピーボタン

**ナビゲーション制御:**
- `history.pushState`で仮想履歴
- ブラウザバック時は逆再生アニメーション
- 未保存時は警告「未定着の記憶が霧に消えます。現実に戻りますか？」

## 4. デザインガイドライン

### 4.1. 世界観の統一

**UI名称の置き換え:**
- 作成 → **夢を編む**
- 一覧 → **記憶の目録**
- 検索 → **索引を辿る**
- 削除 → **忘却する**
- ログイン・サインアップ → **入館手続き**
- ログアウト → **目覚める**

**タイポグラフィ:**
- **夢の中:** ビットマップフォント（DotGothic16等）
- **現実:** 素朴な明朝体

**ビジュアル:** 生成AIによるPS1風レトロ質感

### 4.2. 世界観用語マッピング

| 世界観用語 | 実際の機能名 | 関連セクション |
| :--------- | :----------- | :------------- |
| 現実（トップ） | トップページ表示 | 3.2 |
| 殴り書きの紙片 | 一時メモの入力・自動保存 | 3.2 |
| 入館手続き（Auth） | ログイン・サインアップ画面 | 3.3 |
| 静寂の書斎（メイン） | メインハブ画面 | 3.4 |
| 夢を編む | 夢日記の新規作成・編集 | 3.5 |
| 定着の儀式 | 保存処理と演出 | 3.5 |
| 記憶の目録（一覧） | 一覧表示・検索画面 | 3.6 |
| 記憶の断片（詳細） | 詳細表示画面 | 3.7 |
| 忘却（削除） | 削除機能 | 3.7 |
| 忘却の儀式 | 削除時の演出 | 3.7 |
| 索引を辿る | 検索・絞り込み機能 | 3.8 |
| タグの削除 | タグマスター削除 | 3.8.3 |
| 夢の氾濫 | 特殊演出 | 3.9 |
| 目覚める | ログアウト処理 | 3.4.1 |
| 目覚めの儀式 | ログアウト演出 | 3.4.1 |
| 銀の栞 | 保存ボタンUI | 3.5 |
| アンティークな砂時計 | 削除ボタンUI | 3.7 |
| 修正用の羽ペンとペーパーナイフ | 編集トリガーUI | 3.7 |
| 破れた紙片 | タグ削除ボタンUI | 3.8.3 |

### 4.3. テクスチャの共通化

**共通ベース（羊皮紙の地色）:**
- 作成用巻物と見開き本のページは同一のアンティークな羊皮紙の地色・ノイズ感を採用
- 感情彩色が適用されていないデフォルト状態のベース質感

**構造的差異:**
- **巻物:** 垂直方向の波打ち、両端の「巻き癖」による影
- **見開き本:** 中央の「ノド（綴じ目）」に濃い影、左右ページの緩やかなカーブ

### 4.4. 本棚の蔵書画像

書斎から見える本棚のクリックオブジェクトは、夢日記の冊数によって変化。
アセットリスト参照（`img_bookshelf_*.png`）。

| 冊数 | アセット |
|------|----------|
| 0冊 | img_bookshelf_empty.png |
| 少量 | img_bookshelf_small.png（上段のみ） |
| 中量 | img_bookshelf_medium.png（中段まで） |
| 多量 | img_bookshelf_large.png（下段まで） |

### 4.5. 書斎オブジェクトのホバー効果

| オブジェクト | ホバー動作 |
|-------------|-----------|
| 巻物 | 発光 |
| 本棚 | 発光 |
| 窓 | 七色に光りながら楕円が収縮 |
| 鏡 | 黄色く白く光りながら楕円が収縮 |

## 5. 技術仕様

### 5.1. 画面構成と余白（額縁）の演出

- **4:3 ビューポートの固定:** メイン画面は **4:3（320x240基準）** を維持し、ブラウザ中央に配置。
- **余白（額縁）:** 4:3画面の外側には、「暗い石壁」を配置し、世界観を補強する。全画面共通の最背面。

### 5.2. 質感の演出（PS1フィルタ）

- **演出の注力ポイント:** 複雑な3D挙動よりも、CSSアニメーションの「イージング」や「SE（効果音）との同期」に注力することで、低コストで高い没入感を実現する。
- **解像度とディザリング:** 全てのアセットを低解像度でレンダリングし、エッジを際立たせる。グラデーションにはディザリング処理を施す。
- **ジッター（不規則な揺れ）演出:** 特定のオブジェクトに微細なアニメーションで不規則な揺れを付与する。
- **ポストプロセス:** 画面全体の統一感を出すため、コントラスト・明度・セピア調整を全コンポーネントに一括適用する。


# 夢作成画面（夢を編む）

巻物スクロールに直接文字を書き込む没入型UI。書斎の背景上にモーダル表示。

---

## 要件

- LocalStorageからの殴り書きメモ継承
- タイトル、本文、日付、感情彩色、タグ、明晰夢フラグの入力
- タグのサジェスト/オートコンプリート機能
- 感情彩色による巻物の色変化
- 自動保存（LocalStorage）
- 保存成功時の定着の儀式（本が実体化して本棚へ飛翔）
- 保存失敗時の救済処理（クリップボードコピー）

---

## 設計判断

| 項目 | 選択 | 理由 |
|------|------|------|
| UI形式 | 巻物モーダル | 没入型の筆記体験を提供 |
| カーソル | 羽ペン（`cursor_quill.png`） | 夢の領域での筆記具を表現 |
| 自動保存先 | LocalStorage（`scratch_memo`） | 保存失敗時の救済、トップページと共有 |
| タグサジェスト | debounce 300ms | サーバー負荷とUXのバランス |
| 明晰夢フラグ | データ構造のみ確保、UI未実装 | 将来拡張用 |

---

## 画面構成

| レイヤー | 要素 | 説明 |
|---------|------|------|
| 背景 | 書斎背景（ぼかし） | 書斎画面の減光・ぼかし状態 |
| 前景 | 巻物 | 縦スクロール。上端（画像）＋入力エリア＋下端（画像）。`img_scroll_top_bottom.png` |
| 前景 | 羽ペンカーソル | 入力中のカーソル（`cursor_quill.png`） |
| 前景 | インク瓶（4色） | 感情彩色選択UI（`img_ink_bottle_*.png`） |
| 前景 | 銀の栞 | 保存ボタン（`icon_bookmark_silver.png`） |

---

## 入力フィールド

| フィールド | 必須 | 型 | 制約 | 初期値 | 備考 |
|-----------|------|-----|------|--------|------|
| タイトル | ○ | string | 最大15文字 | なし | リアルタイム文字数表示 |
| 夢を見た日 | ○ | date | - | 現在日付 | 日付選択 |
| 本文 | ○ | text | 最大10,000文字 | LocalStorageから | リアルタイム文字数表示 |
| 感情彩色 | ○ | enum | peace/chaos/fear/elation | なし | 4色のインク瓶から選択 |
| タグ（登場人物） | - | array | - | なし | サジェスト/オートコンプリート |
| タグ（場所） | - | array | - | なし | サジェスト/オートコンプリート |
| 明晰夢チェック | - | boolean | - | false | 【将来拡張：データ構造のみ確保、UI未実装】 |

制約詳細は `data.md` 参照。

---

## UI動作

### 作成開始（書斎から）

**トリガー**: 書斎の縮小版巻物をクリック（`library.md` 参照）

**動作**:
1. `scratch_memo` があれば構造化して全フィールドを初期化
   - `content`: トップページからの値を継承
   - `title`, `emotion_color`: null（未入力）
   - `dreamed_at`: 現在日付（デフォルト）
   - `tags`: 空配列
   - `lucid_dream_flag`: false（デフォルト）
2. `scratch_memo` がなければ空白で開始
3. タイムスタンプ比較: DBより新しければ復元を提案

### テキスト入力

**トリガー**: 入力エリアにフォーカス

**動作**:
- 羽ペンカーソルに変化（`cursor_quill.png`）
- 羽ペンの筆記音（`sfx_quill_write.wav`）ループ再生（フォーカス中のみ）
- 入力ごとにLocalStorageへ自動保存（`scratch_memo`）

### 感情彩色の選択

**トリガー**: インク瓶をクリック

**動作**:
1. インクの滴り音（即時）: `sfx_ink_drip.wav`
2. 巻物の紙色変更（即時）: 選択した感情彩色に応じて背景色が変化

### タグ入力

**UI**: 巻物の入力エリア直下に「登場人物」「場所」の入力フィールド

**動作**:
- 入力開始時（300ms debounce後）: サジェストAPI呼び出し
- 過去のタグからサジェスト/オートコンプリート
- 追加されたタグは「×」ボタン付きバッジで表示
- 「×」クリックでタグ削除

**タグ読み仮名の自動生成**:
- kuromoji.js（クライアント側）で読み仮名を生成
- サーバーへ送信時に `yomi` フィールドに含める

### 保存（銀の栞をクリック）

**トリガー**: 銀の栞をクリック

**動作**:
1. バリデーション（クライアント側）
2. API送信（POST /api/v1/dreams）
3. 通信中: 巻物が震える
4. 成功: 定着の儀式（`animations.md` 参照） → 書斎画面に戻る
5. 失敗: 保存失敗演出（`animations.md` 参照）

**成功時のLocalStorage削除**:
- `scratch_memo` を削除

### 画面外クリック（保存せずに閉じる）

**トリガー**: 巻物の外側（画面外）をクリック

**動作**:
1. 巻物収束演出（`animations.md` 参照）
2. 瞬き演出（`animations.md` 参照）
3. 書斎画面に戻る
4. LocalStorageの`scratch_memo`は保持される（再度開くと前の入力状態を保っている）

---

## エラーハンドリング

| 状況 | 対応 |
|------|------|
| バリデーションエラー（422） | エラーメッセージ表示、フォームは維持 |
| 通信エラー | 保存失敗演出、LocalStorage保持、クリップボードコピーボタン表示 |

エラーメッセージは `config/locales/ja.yml` 参照。

---

## データ送受信（API）

### 夢作成

**エンドポイント**: `POST /api/v1/dreams`

**リクエスト**:
```json
{
  "dream": {
    "title": "夢のタイトル",
    "content": "夢の本文...",
    "emotion_color": "peace",
    "lucid_dream_flag": false,
    "dreamed_at": "2025-01-15",
    "tag_attributes": [
      {"name": "田中", "yomi": "たなか", "category": "person"},
      {"name": "学校", "yomi": "がっこう", "category": "place"}
    ]
  }
}
```

**レスポンス（成功: 201）**:
```json
{
  "id": 1,
  "title": "夢のタイトル",
  "content": "夢の本文...",
  "emotion_color": "peace",
  "lucid_dream_flag": false,
  "dreamed_at": "2025-01-15",
  "tags": [
    {"id": 1, "name": "田中", "yomi": "たなか", "category": "person"},
    {"id": 2, "name": "学校", "yomi": "がっこう", "category": "place"}
  ],
  "created_at": "2025-01-15T10:00:00.000Z",
  "updated_at": "2025-01-15T10:00:00.000Z"
}
```

**レスポンス（失敗: 422）**:
```json
{
  "errors": [
    "属性名 + エラーメッセージ（日本語）",
    "..."
  ]
}
```

**補足**: エラーメッセージは`config/locales/ja.yml`で定義

### タグサジェスト

**エンドポイント**: `GET /api/v1/tags/suggest`

**クエリパラメータ**:
| パラメータ | 型 | 説明 |
|-----------|-----|------|
| q | string | 検索クエリ |
| category | string | person / place |

**レスポンス（成功: 200）**:
```json
{
  "suggestions": [
    {"id": 1, "name": "田中", "yomi": "たなか", "category": "person"},
    {"id": 2, "name": "太郎", "yomi": "たろう", "category": "person"}
  ]
}
```

---

## 演出

`animations.md` の以下のセクションを参照：
- 巻物演出 > 展開・収束
- 作成画面 > テキスト入力
- 作成画面 > 感情彩色の選択
- 作成画面 > 保存せずに閉じる（画面外クリック）
- 定着の儀式（新規作成・保存成功）
- 保存失敗時の救済処理

---

## 実装状況

### バックエンド（API）

- [x] POST /api/v1/dreams（Dreams#create）
- [x] Jbuilderビュー（create.json.jbuilder）
- [x] GET /api/v1/tags/suggest（Tags#suggest）
- [x] タグ付与サービス（Dreams::AttachTagsService）
- [x] タグ読み仮名・インデックス生成

### フロントエンド

- [ ] HTMLビュー（モーダル）
- [ ] JavaScript（app/javascript/create.js）
- [ ] CSS（app/assets/stylesheets/scroll.css）
- [ ] 画面表示
- [ ] 巻物モーダルUI
- [ ] 入力フォーム（タイトル、本文、日付、感情彩色、タグ）
- [ ] テキスト入力（羽ペンカーソル、筆記音）
- [ ] インク瓶（感情彩色選択）
- [ ] 巻物の紙色変更
- [ ] タグ入力・サジェスト（kuromoji.js連携）
- [ ] LocalStorage読み込み（scratch_memo）
- [ ] LocalStorage自動保存
- [ ] API連携（作成、サジェスト）
- [ ] 定着の儀式（保存成功演出）
- [ ] 通信中演出（巻物が震える）
- [ ] 保存失敗演出
- [ ] エラーハンドリング
- [ ] 画面外クリックで閉じる
- [ ] 演出・SE再生

**Note**: プロトタイプ（`prototype/`）に参考実装あり。Rails本体への統合が必要。

# 索引を辿る（検索）

本棚傍の「索引箱」から過去の夢を探し出す。タグと本文検索のAND条件で絞り込み可能。

---

## 要件

- 索引箱からタグ一覧を表示
- タグ選択（複数可）による絞り込み
- キーワード検索（タイトル・本文対象）
- タグとキーワードのAND検索
- 五十音インデックスによるナビゲーション
- タグ削除機能（物理削除）
- 検索結果を一覧画面に表示
- 検索リセット機能

---

## 設計判断

| 項目 | 選択 | 理由 |
|------|------|------|
| UI形式 | 索引箱モーダル | 没入型の検索体験を提供 |
| タグ表示 | カード形式、五十音順 | 視認性と操作性を考慮 |
| タグ絞り込み | debounce 300ms | サーバー負荷とUXのバランス |
| 検索条件 | AND検索 | より精度の高い絞り込みを実現 |
| タグ削除 | 物理削除 | 不要なタグを完全に削除 |
| 検索結果表示 | 一覧画面 | 既存UIの再利用 |

---

## 画面構成

| レイヤー | 要素 | 説明 |
|---------|------|------|
| 背景 | 一覧画面（ぼかし） | 一覧画面が減光・ぼかし状態 |
| 前景 | 索引箱内装 | フレーム（`img_index_box_interior.png`） |
| 前景（ヘッダー） | 選択中タグバッジ | 「×」クリックで選択解除 |
| 前景（ヘッダー） | タグ絞り込み窓 | タグカードの絞り込み |
| 前景（ヘッダー） | キーワード検索窓 | タイトル・本文検索 |
| 前景（中央） | タグカードリスト | 全タグがカード表示、五十音順（`img_tag_card_base.png`） |
| 前景（右端） | 五十音インデックス | 「あ」「か」「さ」…「英」「他」の真鍮製プレート |
| 前景（フッター） | 「抽出」ボタン | 検索実行 |
| 前景（フッター） | 「開架」ボタン | 検索リセット |

---

## 入力フィールド

| フィールド | 必須 | 制約 | 説明 |
|------------|------|------|------|
| タグ絞り込み窓 | - | - | タグカードの表示名・読みがな両方で検索 |
| キーワード検索窓 | - | スペース区切り | タイトル・本文を対象に複数キーワードAND検索 |
| タグ選択（カードクリック） | - | 複数選択可 | 選択タグはヘッダーにバッジ表示 |

---

## UI動作

### 索引箱の開閉

**開く**:

**トリガー**: 一覧画面の索引箱（`img_index_box_exterior.png`）をクリック

**動作**:
1. 索引箱の開閉音（即時）: `sfx_index_box_open_close.wav`
2. 瞬き演出（`animations.md` 参照）
3. モーダル表示（索引箱内装）
4. タグ一覧API呼び出し

**閉じる**:

**トリガー**: 背景クリック、または「抽出」「開架」ボタンクリック

**動作**:
1. モーダル閉じる（索引箱の開閉音）
2. 該当する画面へ遷移

### タグカード操作

**カードクリック（選択）**:

**トリガー**: タグカードをクリック

**動作**:
1. ピン留めアイコン表示
2. SE: `sfx_pin.wav`
3. ヘッダーに選択中タグバッジが表示

**カードホバー**:

**トリガー**: タグカードにホバー

**動作**:
- SE: `sfx_tag_card_flip.wav`

**タグバッジの「×」クリック（選択解除）**:

**トリガー**: ヘッダーのタグバッジ「×」をクリック

**動作**:
- タグの選択が解除される
- ピン留めアイコンが消える

**カード削除**:

**トリガー**: カード右下の「破れた紙片」（`img_tag_delete.png`）をクリック

**動作**:
1. 確認ダイアログ表示「このタグは N 個の夢に紐づいています。削除しますか？」
2. 「はい」選択でAPI呼出（DELETE /api/v1/tags/:id）
3. 風化アニメーション（500ms）
4. SE: `sfx_sand_crumble.wav`
5. カードリストから消える

### 検索実行

**「抽出」クリック**:

**トリガー**: 「抽出」ボタンをクリック

**動作**:
1. 検索API呼び出し（GET /api/v1/dreams/search）
2. 瞬き演出（`animations.md` 参照）
3. 本棚に検索結果を表示（一覧画面へ遷移）
4. モーダル閉じ

**「開架」クリック**:

**トリガー**: 「開架」ボタンをクリック

**動作**:
1. 全選択解除
2. 瞬き演出（`animations.md` 参照）
3. 全件表示に戻る（一覧画面へ遷移）
4. モーダル閉じ

### 補助機能

**タグ絞り込み窓入力**:

**トリガー**: タグ絞り込み窓に入力

**動作**:
- debounce 300ms
- 表示名・読みがなで前方一致検索
- カードリストをリアルタイム絞り込み

**五十音インデックスクリック**:

**トリガー**: 五十音インデックスをクリック

**動作**:
- 該当セクションへスムーズスクロール

---

## エラーハンドリング

| 状況 | 対応 |
|------|------|
| API通信失敗 | 「索引が開けません。霧が深すぎます。」表示、PS1風ノイズ、SE: `sfx_glitch_dissonance.wav` |
| 検索結果0件 | 「該当する記憶がありません」表示（本棚空白） |
| タグ削除時、紐付く夢あり | 確認メッセージ「このタグは N 個の夢に紐づいています。削除しますか？」 |
| タグ削除失敗 | 「削除できませんでした。もう一度お試しください。」、SE: `sfx_glitch_dissonance.wav` |

エラーメッセージは `config/locales/ja.yml` 参照。

---

## データ送受信（API）

### タグ一覧取得

**エンドポイント**: `GET /api/v1/tags`

**クエリパラメータ**:
| パラメータ | 型 | 説明 |
|-----------|-----|------|
| category | string | person / place（省略時: 全カテゴリ） |
| yomi_index | string | 五十音インデックス（あ、か、さ...）（省略時: 全て） |

**レスポンス（成功: 200）**:
```json
{
  "tags": [
    {
      "id": 1,
      "name": "太郎",
      "yomi": "たろう",
      "yomi_index": "た",
      "category": "person"
    },
    {
      "id": 2,
      "name": "学校",
      "yomi": "がっこう",
      "yomi_index": "か",
      "category": "place"
    }
  ]
}
```

### 夢検索

**エンドポイント**: `GET /api/v1/dreams/search`

**クエリパラメータ**:
| パラメータ | 型 | 説明 |
|-----------|-----|------|
| tag_ids | string | タグIDのカンマ区切り文字列（例: "1,2,3"） |
| keywords | string | キーワード文字列（スペース区切りでAND検索） |
| page | integer | ページ番号（デフォルト: 1） |
| per_page | integer | 1ページあたり件数（デフォルト: 12） |

**レスポンス（成功: 200）**:
```json
{
  "dreams": [
    {
      "id": 1,
      "title": "タイトル",
      "emotion_color": "peace",
      "lucid_dream_flag": false,
      "dreamed_at": "2025-01-15",
      "tags": [
        {"id": 1, "name": "田中", "yomi": "たなか", "category": "person"}
      ]
    }
  ],
  "pagination": {
    "current_page": 1,
    "total_pages": 1,
    "total_count": 1,
    "per_page": 12
  }
}
```

### タグ削除

**エンドポイント**: `DELETE /api/v1/tags/:id`

**レスポンス（成功: 204）**: No Content

**レスポンス（失敗: 404）**:
```json
{
  "error": "エラー種別",
  "message": "エラーメッセージ（日本語）"
}
```

**補足**: `config/locales/ja.yml`参照

---

## 演出

`animations.md` の以下のセクションを参照：
- 索引箱（検索） > タグカードをクリック（選択）
- 索引箱（検索） > タグバッジの「×」クリック（選択解除）
- 索引箱（検索） > タグ絞り込み
- 索引箱（検索） > 五十音ジャンプ
- 索引箱（検索） > タグカードホバー
- 索引箱（検索） > タグ削除
- 索引箱（検索） > 検索実行（「抽出」クリック）
- 索引箱（検索） > 検索リセット（「開架」クリック）

---

## 実装状況

### バックエンド（API）

- [x] GET /api/v1/tags（Tags#index）
- [x] GET /api/v1/dreams/search（Dreams#search）
- [ ] キーワードのスペース区切りAND検索（Dream.search_by_keyword）
- [x] DELETE /api/v1/tags/:id（Tags#destroy）
- [x] Jbuilderビュー（index.json.jbuilder, search.json.jbuilder）

### フロントエンド

- [ ] HTMLビュー（モーダル）
- [ ] JavaScript（app/javascript/search.js）
- [ ] CSS（app/assets/stylesheets/index_box.css）
- [ ] 画面表示
- [ ] 索引箱外観クリックでモーダル起動
- [ ] タグ一覧取得API連携
- [ ] タグカードの五十音順表示
- [ ] タグ選択（ピン留め）機能
- [ ] タグ絞り込み窓（debounce 300ms）
- [ ] キーワード検索窓
- [ ] 「抽出」ボタンで検索API呼出
- [ ] 「開架」ボタンでリセット
- [ ] 五十音インデックスでスクロール
- [ ] タグ削除機能（確認→API→風化）
- [ ] エラーハンドリング
- [ ] 検索結果0件時の表示
- [ ] 瞬き演出との統合
- [ ] 全SE再生

**Note**: プロトタイプ（`prototype/js/script.js`）に一部機能実装あり。Rails本体への統合が必要。

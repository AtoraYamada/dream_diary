# 夢の氾濫（特殊演出）

書斎の窓から過去の夢が溢れ出す特殊演出。夢日記からランダムな文を抽出し、その場限りの夢の断片を生成。

---

## 要件

- 書斎の窓クリックで発動
- 過去の夢日記からランダムな文を抽出
- 鏡文字として表示
- ホバー/長押しで正像に反転
- 背景クリックまたは1分放置で解除

---

## 設計判断

| 項目 | 選択 | 理由 |
|------|------|------|
| 生成元 | 最大10冊の夢日記 | パフォーマンスと多様性のバランス |
| 抽出方法 | 句点単位で分割、5〜8文をランダム結合 | 読みやすさを考慮 |
| タグ優先 | 直近多用タグを優先抽出 | ユーザーの関心に沿った内容 |
| フォールバック | プリセット文章（『遠くで鐘が鳴っている』等） | DB不足時の対応 |
| 表示形式 | 鏡文字 | 夢の儚さ・不確かさを表現 |
| 自動解除 | 1分 | 長時間の放置を防ぐ |

---

## 画面構成

| レイヤー | 要素 | 説明 |
|---------|------|------|
| 背景 | 書斎背景 | bg_library_desk.png |
| 前景 | 窓 | クリックトリガー |
| オーバーレイ | 氾濫テキスト | 鏡文字（白字）、画面中央に表示 |

---

## UI動作

### 発動

**トリガー**: 書斎の窓をクリック

**動作**:
1. 窓が歪む演出（500ms）
2. SE: `sfx_glass_warp.wav`
3. 文字が窓から流入（1000ms）
   - 流入中の文字にランダムな感情彩色を表示
4. 画面中央に「鏡文字」として表示（統一色）

### テキスト表示

**初期表示**:
- 鏡文字として画面中央に表示

**ホバー / 長押し**:
- 正像に反転

### 解除

**背景クリック**:
1. 文字がフェードアウト（500ms）
2. 書斎画面に戻る

**1分放置**:
1. 自動的に文字がフェードアウト（500ms）
2. 書斎画面に戻る

---

## エラーハンドリング

| 状況 | 対応 |
|------|------|
| API通信失敗 | 演出を開始せず書斎に留まる、エラーメッセージ表示 |
| 夢日記0件 | プリセット文章のみで構成 |

エラーメッセージは `config/locales/ja.yml` 参照。

---

## データ送受信（API）

### 氾濫テキスト取得

**エンドポイント**: `GET /api/v1/dreams/overflow`

**レスポンス（成功: 200）**:
```json
{
  "fragments": [
    "遠くで鐘が鳴っている",
    "太郎が笑っている",
    "学校の廊下を歩いている"
  ]
}
```

**レスポンス（失敗: 500）**:
```json
{
  "errors": [
    "エラーメッセージ"
  ]
}
```

**生成ロジック**:
- 最大10冊の夢日記を抽出
  - 優先順位1: 直近多用タグを含む夢日記を優先
  - 優先順位2: 多用タグがない場合は完全ランダム
- 抽出した夢日記から句点単位で分割
- 5〜8文をランダム結合
- DB不足時はプリセット文章（『遠くで鐘が鳴っている』等）を混入

---

## 演出

`animations.md` の以下のセクションを参照：
- 夢の氾濫（特殊演出） > 夢の氾濫開始
- 夢の氾濫（特殊演出） > 文字の反転（ホバー/長押し）
- 夢の氾濫（特殊演出） > 解除

**視覚演出**:
- 流入演出: 感情彩色をランダムに付与
- 鏡文字表示: 統一色で表示
- ホバー/長押しで正像に反転

---

## 実装状況

### バックエンド（API）

- [x] GET /api/v1/dreams/overflow（Dreams#overflow）
- [x] 氾濫テキスト生成サービス（Dreams::OverflowService）
- [ ] タグ頻度分析
- [x] プリセット文章管理

### フロントエンド

- [ ] JavaScript（app/javascript/overflow.js）
- [ ] CSS（app/assets/stylesheets/overflow.css）
- [ ] 窓クリックトリガー
- [ ] 氾濫テキスト生成API連携
- [ ] 窓歪み演出
- [ ] 文字流入演出（感情彩色）
- [ ] 鏡文字表示
- [ ] ホバー/長押しで正像反転
- [ ] 背景クリックで解除
- [ ] 自動解除タイマー（1分）
- [ ] エラーハンドリング
- [ ] 演出・SE再生

**Note**: プロトタイプ（`prototype/`）に参考実装あり。Rails本体への統合が必要。

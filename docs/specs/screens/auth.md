# 認証画面（入館手続き）

現実から夢（書斎）へアクセスするための「手続きの場」。ログイン・サインアップ機能を提供する。

---

## 要件

- ログイン機能（メールアドレスまたはユーザー名でログイン可能）
- サインアップ機能（ユーザー名、メールアドレス、パスワードで登録）
- カード切り替えUI（ログイン⇔サインアップ）
- 戻るボタンでトップページへ戻る
- 認証エラー時の儀式的な演出

---

## 設計判断

| 項目 | 選択 | 理由 |
|------|------|------|
| 認証方式 | Devise | Rails標準的な認証Gem、セキュア |
| ログイン識別子 | email OR username | 柔軟性を提供（どちらでもログイン可能） |
| パスワード最小長 | 6文字 | Deviseデフォルト |
| UI切替 | カード前後入れ替え | 物理的なカードの質感を表現 |
| エラー演出 | 砂崩れ（文字の霧散） | 夢の儚さを表現 |

---

## 画面構成

| レイヤー | 要素 | 説明 |
|---------|------|------|
| 背景 | シュールで幾何学的な廊下 | 奥に続く廊下のシルエット（`bg_auth_corridor.png`） |
| 中景 | バインダー | クリップとボードの質感・形状（`img_binder.png`） |
| 前景 | 入館証カード | 「継続（ログイン）」（`img_auth_card_in.png`）と「新規（サインアップ）」（`img_auth_card_up.png`）のカードが前後にズレて重なる（初期：ログインが前面） |
| 前景（左上） | 戻るボタン | トップページへ戻る（`icon_back.png`） |

---

## 入力フィールド

### ログイン

| フィールド | 必須 | 型 | 制約 | 備考 |
|-----------|------|-----|------|------|
| メールアドレスまたはユーザー名 | ○ | string | メール形式またはユーザー名形式 | どちらでもログイン可能 |
| パスワード | ○ | string | 最小6文字 | |

### サインアップ

| フィールド | 必須 | 型 | 制約 | 備考 |
|-----------|------|-----|------|------|
| ユーザー名 | ○ | string | 英数字・アンダースコア・日本語、一意性制約 | |
| メールアドレス | ○ | string | メール形式、一意性制約 | |
| パスワード | ○ | string | 最小6文字 | |
| パスワード確認 | ○ | string | パスワードと一致 | |

---

## UI動作

### カード切り替え（ログイン⇔サインアップ）

**初期表示**:
- ログインカードが前面に表示
- サインアップカードが背面にズレて重なっており、一部が見える

**トリガー**: 背面に見えているカードをクリック

**動作**:
1. クリックされたカードが前面に移動（300ms）
2. 前面にあったカードが背面に移動（300ms）
3. SE: `sfx_auth_card_slide.wav`
4. ログイン⇔サインアップフォームが切り替わる

### ログイン成功

**トリガー**: ログインボタンをクリック、認証成功

**動作**:
1. 瞬き演出（`animations.md` 参照）
2. 境界を越える音（澄んだチャイム）: `sfx_boundary_pass.wav`
3. 書斎画面へ遷移
4. LocalStorage（`scratch_memo`）は保持され、作成画面で使用可能

### サインアップ成功

**トリガー**: サインアップボタンをクリック、認証成功

**動作**: ログイン成功と同様

### 認証エラー（ログイン失敗、サインアップ失敗）

**トリガー**: 認証失敗

**動作**:
1. 入力文字が砂のように崩れ落ちる（500ms）
2. SE: `sfx_sand_crumble.wav`
3. エラーメッセージ表示（即時）
4. 入力フィールドがクリアされ、再入力可能状態

**エラーメッセージ例**:
- ログイン失敗: 「入館証が認識されません。」
- サインアップ失敗: 「この入館証は既に使用されています。」
- バリデーションエラー: `config/locales/ja.yml` 参照

### 戻るボタン

**トリガー**: 左上の戻るボタンをクリック

**動作**:
1. 瞬き演出（`animations.md` 参照）
2. トップページへ戻る

---

## エラーハンドリング

| 状況 | 対応 |
|------|------|
| ログイン失敗（401） | 砂崩れ演出 + エラーメッセージ表示 |
| サインアップ失敗（422） | 砂崩れ演出 + エラーメッセージ表示（バリデーションエラー詳細） |
| 通信エラー | エラーメッセージ表示「接続できません。しばらくしてから再度お試しください。」 |

エラーメッセージは `config/locales/ja.yml` 参照。

---

## データ送受信（API）

### ログイン

**エンドポイント**: `POST /users/sign_in`

**リクエスト**:
```json
{
  "user": {
    "login": "user@example.com",
    "password": "password123"
  }
}
```

**レスポンス（成功: 200）**:
```json
{
  "message": "Logged in successfully.",
  "user": {
    "id": 1,
    "email": "user@example.com",
    "username": "user1"
  }
}
```

**レスポンス（失敗: 401）**:
```json
{
  "error": "エラーメッセージ"
}
```

**補足**: Devise未実装（JSON API化未対応）

---

### サインアップ

**エンドポイント**: `POST /users`

**リクエスト**:
```json
{
  "user": {
    "username": "newuser",
    "email": "new@example.com",
    "password": "password123",
    "password_confirmation": "password123"
  }
}
```

**レスポンス（成功: 201）**:
```json
{
  "message": "Signed up successfully.",
  "user": {
    "id": 2,
    "email": "new@example.com",
    "username": "newuser"
  }
}
```

**レスポンス（失敗: 422）**:
```json
{
  "errors": [
    "属性名 + エラーメッセージ（日本語）",
    "..."
  ]
}
```

**補足**: `config/locales/ja.yml`で定義。Devise未実装（JSON API化未対応）

---

## 演出

`animations.md` の以下のセクションを参照：
- 認証画面 > カード切り替え（ログイン⇔サインアップ）
- 認証画面 > ログイン成功
- 認証画面 > 認証エラー
- 認証画面 > 戻るボタン

---

## 実装状況

### バックエンド（API）

- [x] Deviseセットアップ
- [x] POST /users/sign_in（Sessions#create）
- [x] POST /users（Registrations#create）
- [x] Devise JSON API化
- [x] login（email OR username）対応

### フロントエンド

- [ ] HTMLビュー（app/views/pages/auth.html.erb）
- [ ] JavaScript（app/javascript/auth.js）
- [ ] CSS（app/assets/stylesheets/auth.css）
- [ ] 画面表示
- [ ] カード切替UI・アニメーション
- [ ] ログインフォーム送信
- [ ] サインアップフォーム送信
- [ ] API連携
- [ ] 認証成功演出（瞬き、境界を越える音）
- [ ] 認証失敗演出（砂崩れ）
- [ ] エラーハンドリング
- [ ] 戻るボタン
- [ ] 演出・SE再生

**Note**: プロトタイプ（`prototype/`）に参考実装あり。Rails本体への統合が必要。

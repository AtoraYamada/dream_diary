<!DOCTYPE html>
<html lang="ja" class="after-door">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>夢日記帳 - 記憶の目録</title>
    <link rel="stylesheet" href="css/style.css">
    <script>
        // チラつき完全防止：URL確認して即座にhtml要素にクラス追加
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('blink') === 'open') {
                document.documentElement.classList.add('will-open-eyes');
            }
        })();
    </script>
    <style>
        body {
            /* Asset: bg_library_wall_up (書斎の壁の背景) */
            background-image: url('assets/bg_library_wall_up.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            cursor: grab;
            overflow: hidden;
        }

        /* Page-specific viewport settings (一覧ページ専用) */
        .viewport-container {
            /* Asset: bg_library_wall_up (書斎の壁の背景) */
            background-image: url('assets/bg_library_wall_up.png');
            background-size: cover;
            background-position: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .bookshelf-display {
            position: relative;
            width: 80%;
            height: 80%;
            min-height: 600px; /* Ensure minimum height for tab display (778px viewport) */
            max-height: 630px; /* Fix relative position between bookshelf and book-spine */
            top: 9.5%;
            background-image: url('assets/img_bookshelf_empty.png'); /* Asset: 本棚本体 */
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5% 0; /* Vertical padding for shelves */
            box-sizing: border-box;
        }

        .book-spines-container {
            display: flex;
            flex-wrap: wrap; /* Allows books to wrap to next shelf */
            gap: 5px; /* Spacing between books */
            max-width: 90%; /* Keep books within shelf limits */
            height: 100%;
            align-content: flex-start; /* Stack books from the top */
            position: relative;
            z-index: 2; /* Above bookshelf background */
        }


        .book-spine {
            width: 30px; /* Width of a book spine */
            height: 150px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            background-size: 100% 100%;
            background-repeat: no-repeat;

            writing-mode: vertical-rl; /* Vertical text */
            text-orientation: upright;
            color: var(--color-paper);
            font-family: var(--font-pixel);
            font-size: 14px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        /* Emotion-specific book spine backgrounds */
        .book-spine.peace {
            background-image: url('assets/img_book_spine_peace.png'); /* Asset: 安らぎの感情色 */
        }
        .book-spine.chaos {
            background-image: url('assets/img_book_spine_chaos.png'); /* Asset: 混沌の感情色 */
        }
        .book-spine.fear {
            background-image: url('assets/img_book_spine_fear.png'); /* Asset: 恐怖の感情色 */
        }
        .book-spine.elation {
            background-image: url('assets/img_book_spine_elation.png'); /* Asset: 高揚の感情色 */
        }

        .book-spine:hover {
            transform: translateY(-5px); /* Slight lift */
            box-shadow: 4px 4px 10px rgba(0,0,0,0.5);
        }

        /* Book Spine Glow Animation (保存完了時の発光演出 - ゆっくり点滅) */
        @keyframes book-spine-glow {
            0% {
                filter: brightness(1);
            }
            10% {
                filter: brightness(1.8) drop-shadow(0px 8px 15px rgba(255, 255, 200, 0.8));
            }
            20% {
                filter: brightness(1.8) drop-shadow(0px 8px 15px rgba(255, 255, 200, 0.8));
            }
            30% {
                filter: brightness(1);
            }
            40% {
                filter: brightness(1.8) drop-shadow(0px 8px 15px rgba(255, 255, 200, 0.8));
            }
            50% {
                filter: brightness(1.8) drop-shadow(0px 8px 15px rgba(255, 255, 200, 0.8));
            }
            60% {
                filter: brightness(1);
            }
            70% {
                filter: brightness(1.8) drop-shadow(0px 8px 15px rgba(255, 255, 200, 0.8));
            }
            80% {
                filter: brightness(1.8) drop-shadow(0px 8px 15px rgba(255, 255, 200, 0.8));
            }
            100% {
                filter: brightness(1);
            }
        }

        .book-spine.glow {
            animation: book-spine-glow 3s ease-in-out;
        }

        .book-spine::after {
            content: attr(data-title); /* Use data-title for content */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none; /* Don't block click on spine */
        }
        .book-spine:hover::after {
            opacity: 1; /* Show title on hover */
        }


        /* Pagination controls */
        .pagination-left, .pagination-right {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: clamp(60px, 6vw, 80px);
            height: clamp(80px, 8vh, 100px);
            background-color: rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: clamp(24px, 2.5vw, 30px);
            cursor: pointer;
            z-index: 10;
            transition: background-color 0.2s;
        }
        .pagination-left:hover, .pagination-right:hover {
            background-color: rgba(0, 0, 0, 0.6);
        }
        .pagination-left { left: 0; border-radius: 0 10px 10px 0; }
        .pagination-right { right: 0; border-radius: 10px 0 0 10px; }

        /* Index Box */
        .index-box-trigger {
            position: absolute;
            bottom: 0%;
            right: 2%;
            width: clamp(100px, 10vw, 130px);
            height: clamp(120px, 12vw, 156px);
            background-image: url('assets/img_index_box_exterior.png'); /* Asset: 索引箱の外装 */
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            z-index: 10;
            filter: drop-shadow(0px 5px 5px rgba(0,0,0,0.4)); /* Asset: 汎用影テクスチャ */
        }
        .index-box-trigger:hover {
            filter: brightness(1.2) drop-shadow(0px 5px 5px rgba(0,0,0,0.4));
        }

        /* Back to Library Button */
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            width: clamp(50px, 5vw, 60px);
            height: clamp(50px, 5vw, 60px);
            background-image: url('assets/icon_back.png'); /* Asset: 操作アイコン/戻る */
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            z-index: 15;
            filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.4));
        }
        .back-button:hover {
            filter: brightness(1.2) drop-shadow(0px 2px 2px rgba(0,0,0,0.4));
        }

        /* Index Card Modal Overlay */
        .index-card-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Dark overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100; /* Above everything else */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .index-card-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .index-card-modal-overlay .drawer-container {
             /* Add styles for the drawer container when it's inside the modal */
            position: relative; /* To position the close button */
            background-image: url('assets/img_index_box_interior.png'); /* Asset: 索引箱の内装 */
            background-size: 100% 100%;
            background-repeat: no-repeat;
            background-position: center;
        }

        .index-card-modal-overlay .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 30px;
            height: 30px;
            background-color: #f00; /* Example close button color */
            cursor: pointer;
            z-index: 101; /* Above modal content */
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-family: sans-serif;
        }

        /* Detail Modal Overlay (詳細表示用モーダル) */
        .detail-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            background-color: rgba(0, 0, 0, 0.3);
            z-index: 9000;  /* blink overlay (10000) より低いが、他の要素より高い */
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }

        .detail-modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Open Book Container (見開き本) */
        .open-book-container {
            position: relative;
            width: 90%;
            max-width: 880px;
            height: auto;
            aspect-ratio: 8 / 5; /* Maintain 880:550 ratio */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            filter: drop-shadow(0px 10px 15px rgba(0,0,0,0.7)); /* Asset: 汎用影テクスチャ */
        }

        .book-frame {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: url('assets/img_book_open_frame_chaos.png'); /* Asset: 開かれた本のフレーム(混沌) */
            background-size: 100% 100%;
            background-repeat: no-repeat;
            z-index: 3;
        }

        .book-page {
            position: absolute;
            width: 45%; /* Each page takes almost half the book frame width */
            height: 97%;
            top: 1%;
            background-color: var(--color-paper); /* Default paper color */
            padding: 40px 20px;
            box-sizing: border-box;
            overflow-y: auto;
            font-family: var(--font-pixel);
            font-size: 14px;
            line-height: 1.6;
            color: var(--color-ink);
            -ms-overflow-style: none; scrollbar-width: none;
            z-index: 4; /* Above frame */
        }
        .book-page::-webkit-scrollbar { display: none; }

        .book-page-left {
            left: 5%; /* Adjusted position */
            /* Asset: img_book_open_left_page.png (開かれた本の左ページ) */
            /* background-image: url('assets/img_book_open_left_page.png'); */
            background-size: cover;
            background-blend-mode: multiply; /* Blend page texture with background color */
            border-right: 2px solid rgba(0,0,0,0.3); /* Added border to simulate spine shadow */
        }

        .book-page-right {
            right: 5%; /* Adjusted position */
            /* Asset: img_book_open_right_page.png (開かれた本の右ページ) */
            /* background-image: url('assets/img_book_open_right_page.png'); */
            background-size: cover;
            background-blend-mode: multiply; /* Blend page texture with background color */
            border-left: 2px solid rgba(0,0,0,0.3); /* Added border to simulate spine shadow */
        }

        /* Edit and Delete buttons for detail modal */
        .hourglass-delete-btn {
            position: fixed;
            bottom: calc(5% + 20px);  /* Bottom of modal viewport area + margin */
            right: calc(5% + 20px);   /* Right of modal viewport area + margin */
            width: clamp(70px, 7vw, 90px);
            height: clamp(70px, 7vw, 90px);
            background-image: url('assets/icon_hourglass_antique.png'); /* Asset: アンティーク砂時計アイコン */
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            z-index: 9100;  /* Above modal overlay but below blink */
            filter: drop-shadow(0px 5px 5px rgba(0,0,0,0.4));
        }
        .hourglass-delete-btn:hover {
            filter: brightness(1.2) drop-shadow(0px 5px 5px rgba(0,0,0,0.4));
            animation: rotate-hourglass 1s infinite linear;
        }

        @keyframes rotate-hourglass {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .edit-quill-knife-btn {
            position: fixed;
            bottom: calc(5% + 130px);  /* Above hourglass with more spacing */
            right: calc(5% + 20px);     /* Same right position as hourglass */
            width: clamp(70px, 7vw, 90px);
            height: clamp(70px, 7vw, 90px);
            background-image: url('assets/icon_edit_quill_knife.png'); /* Asset: 羽ペンとナイフの編集アイコン */
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            z-index: 9100;  /* Above modal overlay but below blink */
            filter: drop-shadow(0px 5px 5px rgba(0,0,0,0.4));
        }
        .edit-quill-knife-btn:hover {
            filter: brightness(1.2) drop-shadow(0px 5px 5px rgba(0,0,0,0.4));
        }

        /* Edit Modal (巻物モーダル - library.htmlから流用) */
        .create-edit-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            background-color: rgba(0, 0, 0, 0.3);
            z-index: 9000;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }

        .create-edit-modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .create-edit-modal-overlay::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0);
            filter: blur(8px) brightness(0.6);
            z-index: -1;
            pointer-events: none;
        }

        @keyframes scroll-unfurl {
            from { height: 0; }
            to { height: calc(95vh * 0.8 - 50px); }
        }

        @keyframes scroll-roll-up {
            from { height: calc(95vh * 0.8 - 50px); }
            to { height: 0; }
        }

        .scroll-container {
            display: flex;
            flex-direction: column;
            width: calc(95vh * 4 / 3 * 0.8);
            height: auto;
            margin: 0 auto;
            margin-top: calc(95vh * 0.05);
            position: relative;
            z-index: 10;
            filter: drop-shadow(0px 10px 10px rgba(0,0,0,0.5));
        }

        .scroll-container::before {
            content: '';
            position: absolute;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 85%;
            bottom: 25px;
            background-color: var(--color-paper);
            z-index: 0;
        }

        .scroll-middle.unfurl {
            animation: scroll-unfurl 0.6s ease-out forwards;
        }

        .scroll-middle.roll-up {
            animation: scroll-roll-up 0.6s ease-in forwards;
        }

        .scroll-top {
            width: 100%;
            height: 50px;
            background-image: url('assets/img_scroll_top_bottom.png');
            background-size: 100% 100%;
            background-repeat: no-repeat;
            background-position: center;
            position: relative;
            z-index: 2;
        }

        .scroll-middle {
            height: 0;
            width: 85%;
            margin-left: auto;
            margin-right: auto;
            padding: 30px;
            box-sizing: border-box;
            background-color: var(--color-paper);
            overflow: hidden;
            position: relative;
            z-index: 1;
            margin-top: -25px;
            margin-bottom: -25px;
            display: flex;
            flex-direction: column;
        }

        .scroll-middle textarea {
            width: 100%;
            flex: 0 1 auto;
            height: 250px;
            border: none;
            background-color: transparent;
            font-family: var(--font-pixel);
            font-size: 16px;
            color: var(--color-ink);
            resize: none;
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .scroll-middle textarea::-webkit-scrollbar { display: none; }
        .scroll-middle textarea:focus { outline: none; }

        .dream-title-input {
            width: 100%;
            padding: 10px 0;
            border: none;
            border-bottom: 2px solid var(--color-brass-dark);
            background-color: transparent;
            font-family: var(--font-pixel);
            font-size: 20px;
            font-weight: bold;
            color: var(--color-ink);
            margin-bottom: 15px;
        }

        .dream-title-input:focus {
            outline: none;
            border-bottom-color: var(--color-brass);
        }

        .dream-title-input::placeholder {
            color: var(--color-ink-light);
            opacity: 0.6;
        }

        .tag-input-area {
            margin-top: 20px;
        }

        .tag-input-area h3 {
            font-size: 14px;
            margin: 10px 0 5px 0;
            color: var(--color-ink);
        }

        .tag-input-area input {
            width: 100%;
            padding: 5px;
            border: none;
            border-bottom: 1px solid var(--color-brass-dark);
            background-color: transparent;
            color: var(--color-ink);
            font-family: var(--font-pixel);
            margin-bottom: 10px;
        }

        .tag-input-area input:focus {
            outline: none;
            border-bottom-color: var(--color-brass);
        }

        .tag-input-area input::placeholder {
            color: var(--color-ink-light);
            opacity: 0.6;
        }

        .selected-tags-area {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .tag-badge {
            background-color: var(--color-brass-dark);
            color: var(--color-paper);
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tag-badge .remove-btn {
            cursor: pointer;
            font-weight: bold;
        }

        .scroll-bottom {
            width: 100%;
            height: 50px;
            background-image: url('assets/img_scroll_top_bottom.png');
            transform: scaleY(-1);
            background-size: 100% 100%;
            background-repeat: no-repeat;
            background-position: center;
            position: relative;
            z-index: 2;
        }

        .scroll-controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: row;
            gap: 20px;
            z-index: 9100;
        }

        .ink-bottles {
            display: flex;
            flex-direction: row;
            gap: 10px;
        }

        .ink-bottle {
            width: 90px;
            height: 120px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            position: relative;
            transition: filter 0.2s;
            filter: drop-shadow(0px 5px 5px rgba(0,0,0,0.4));
        }

        .ink-bottle:hover {
            filter: brightness(1.2) drop-shadow(0px 5px 5px rgba(0,0,0,0.4));
        }

        .ink-label {
            position: absolute;
            top: 68%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: var(--font-pixel);
            font-size: 20px;
            font-weight: bold;
            color: rgba(0, 0, 0, 0.7);
            letter-spacing: 2px;
            pointer-events: none;
            text-shadow: 0px 0px 2px rgba(255, 255, 255, 0.5);
            -webkit-text-stroke: 0.5px rgba(0, 0, 0, 0.5);
        }

        .ink-bottle.peace { background-image: url('assets/img_ink_bottle_peace.png'); }
        .ink-bottle.chaos { background-image: url('assets/img_ink_bottle_chaos.png'); }
        .ink-bottle.fear { background-image: url('assets/img_ink_bottle_fear.png'); }
        .ink-bottle.elation { background-image: url('assets/img_ink_bottle_elation.png'); }

        .ink-bottle.selected {
            outline: 2px solid var(--color-brass);
            outline-offset: -2px;
            filter: brightness(1.5) drop-shadow(0px 5px 10px currentColor);
        }

        .save-bookmark {
            position: fixed;
            right: calc((100vw - (95vh * 4 / 3 * 0.8)) / 2);
            bottom: 30px;
            width: 75px;
            height: 120px;
            background-image: url('assets/icon_bookmark_silver.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            transition: transform 0.2s, filter 0.2s;
            filter: drop-shadow(0px 5px 5px rgba(0,0,0,0.4));
            z-index: 9100;
        }

        .save-bookmark:hover {
            transform: translateY(-5px);
            filter: brightness(1.2);
        }

        @keyframes bookmark-glow {
            0% {
                transform: translateY(0) scale(1);
                filter: brightness(1) saturate(1);
            }
            50% {
                transform: translateY(-10px) scale(1.1);
                filter: brightness(1.5) saturate(2);
            }
            100% {
                transform: translateY(0) scale(1);
                filter: brightness(1) saturate(1);
            }
        }

        .save-bookmark.glow {
            animation: bookmark-glow 0.3s ease-out;
        }
    </style>
</head>
<body>
    <!-- 4:3 Viewport with outer wall as background (from 5.5) -->
    <div class="viewport-container">
        <!-- インタラクティブ要素: ライブラリへ戻るボタン -->
        <div class="back-button" id="back-to-library-button"></div>

        <div class="bookshelf-display">
            <!-- Asset: img_bookshelf_empty.png is background (本棚本体) -->

            <div class="book-spines-container" id="book-spines-container">
                <!-- Example book spines (本の背表紙) -->
                <div class="book-spine peace" data-title="最初の夢" data-id="1"></div>
                <div class="book-spine chaos" data-title="混沌の夜" data-id="2"></div>
                <div class="book-spine fear" data-title="恐怖の影" data-id="3"></div>
                <div class="book-spine elation" data-title="高揚の空" data-id="4"></div>
                <div class="book-spine peace" data-title="古城の秘密" data-id="5"></div>
                <div class="book-spine peace" data-title="森の記憶" data-id="6"></div>
                <div class="book-spine chaos" data-title="無限回廊" data-id="7"></div>
                <div class="book-spine fear" data-title="忘れられた歌" data-id="8"></div>
                <div class="book-spine elation" data-title="星の彼方" data-id="9"></div>
                <div class="book-spine peace" data-title="月の涙" data-id="10"></div>
                <div class="book-spine chaos" data-title="古びた地図" data-id="11"></div>
                <div class="book-spine fear" data-title="砂の城" data-id="12"></div>
            </div>
        </div>

        <div class="pagination-left" id="pagination-left">❮</div>
        <div class="pagination-right" id="pagination-right">❯</div>

        <!-- インタラクティブ要素: 索引箱トリガー。クリックで索引カードモーダルを開く。 -->
        <div class="index-box-trigger" id="index-box-trigger"></div>
    </div>

    <!-- Detail Modal (詳細表示用) -->
    <div class="detail-modal-overlay" id="detail-modal-overlay">
        <div class="open-book-container">
            <div class="book-frame"></div>
            <div class="book-page book-page-left" id="left-page">
                <!-- 左ページの内容が動的に挿入されます -->
            </div>
            <div class="book-page book-page-right" id="right-page">
                <!-- 右ページの内容が動的に挿入されます -->
            </div>
        </div>
        <!-- 編集ボタン（羽ペンとペーパーナイフ） -->
        <div class="edit-quill-knife-btn interactive-object" id="detail-edit-button"></div>
        <!-- 削除ボタン（砂時計） -->
        <div class="hourglass-delete-btn interactive-object" id="detail-delete-button"></div>
    </div>

    <!-- Index Card Modal -->
    <div class="index-card-modal-overlay" id="index-card-modal">
        <div class="drawer-container">
    <header class="drawer-header">
        <div class="selected-tags-area" id="selected-tags">
            <span class="label">選択中の索引：</span>
            <!-- 選択されたタグがここに表示されます -->
        </div>
        <div class="search-bars">
            <input type="text" id="tag-filter-input" placeholder="タグを絞り込む...">
            <input type="text" id="body-search-input" placeholder="記憶の本文を探索...">
        </div>
    </header>

    <main class="drawer-content">
        <div class="card-list-area" id="card-list">
            <div class="tag-card" data-tag-name="古びた洋館" data-tag-yomi="ふるびたようかん">
                <div class="tag-title">古びた洋館</div>
                <div class="tag-description">（場所）地下室の奥で…</div>
                <div class="delete-tag-icon" title="このタグを削除"></div>
            </div>
            <div class="tag-card" data-tag-name="背の高い友人" data-tag-yomi="せのたかいゆうじん">
                <div class="tag-title">背の高い友人</div>
                <div class="tag-description">（人物）いつも隣にいる</div>
            </div>
            <div class="tag-card" data-tag-name="記憶の砂時計" data-tag-yomi="きおくのすなどけい">
                <div class="tag-title">記憶の砂時計</div>
                <div class="tag-description">（物）時間の流れを示す</div>
            </div>
            <div class="tag-card" data-tag-name="森の深淵" data-tag-yomi="もりのしんえん">
                <div class="tag-title">森の深淵</div>
                <div class="tag-description">（場所）呼んでいる声が…</div>
            </div>
            <div class="tag-card" data-tag-name="謎の少女" data-tag-yomi="なぞのしょうじょ">
                <div class="tag-title">謎の少女</div>
                <div class="tag-description">（人物）白いワンピース</div>
            </div>
            <div class="tag-card" data-tag-name="書斎の番人" data-tag-yomi="しょさいのばんにん">
                <div class="tag-title">書斎の番人</div>
                <div class="tag-description">（人物）動かない老人</div>
            </div>
            <div class="tag-card" data-tag-name="安らぎの木陰" data-tag-yomi="やすらぎのこかげ">
                <div class="tag-title">安らぎの木陰</div>
                <div class="tag-description">（場所）穏やかな光</div>
            </div>
            <div class="tag-card" data-tag-name="鍵束" data-tag-yomi="かぎたば">
                <div class="tag-title">鍵束</div>
                <div class="tag-description">（物）多くの扉を開く</div>
            </div>
            <div class="tag-card" data-tag-name="幻想の蝶" data-tag-yomi="げんそうのちょう">
                <div class="tag-title">幻想の蝶</div>
                <div class="tag-description">（生物）ひらひらと舞う</div>
            </div>
            <div class="tag-card" data-tag-name="歪んだ回廊" data-tag-yomi="ゆがんだかいろう">
                <div class="tag-title">歪んだ回廊</div>
                <div class="tag-description">（場所）どこへ続くのか</div>
            </div>
        </div>
        <div class="index-plate-container">
            <div class="index-plate">あ</div> <div class="index-plate">か</div> <div class="index-plate">さ</div>
            <div class="index-plate">た</div> <div class="index-plate">な</div> <div class="index-plate">は</div>
            <div class="index-plate">ま</div> <div class="index-plate">や</div> <div class="index-plate">ら</div>
            <div class="index-plate">わ</div> <div class="index-plate">英</div> <div class="index-plate">他</div>
        </div>
    </main>

    <footer class="drawer-footer">
        <button class="action-button" id="match-button">抽出</button>
        <button class="action-button" id="reset-button">開架</button>
    </footer>
</div>
    </div>

    <!-- Edit Modal (巻物モーダル - library.htmlから流用) -->
    <div class="create-edit-modal-overlay" id="create-edit-modal-overlay">
        <div class="scroll-container" id="scroll-container">
            <div class="scroll-top"></div>
            <div class="scroll-middle">
                <input type="text" id="dream-title-input" class="dream-title-input" placeholder="タイトル">
                <textarea id="dream-textarea" placeholder="夢の内容をここに書き記す..."></textarea>
                <div class="tag-input-area">
                    <h3>登場人物</h3>
                    <input type="text" id="character-tag-input" placeholder="登場人物名を入力">
                    <div id="character-tags-display" class="selected-tags-area"></div>
                    <h3>場所</h3>
                    <input type="text" id="location-tag-input" placeholder="場所名を入力">
                    <div id="location-tags-display" class="selected-tags-area"></div>
                </div>
            </div>
            <div class="scroll-bottom"></div>
        </div>
        <!-- Scroll Controls (Ink Bottles) -->
        <div class="scroll-controls">
            <!-- Emotion Ink Bottles (4色のインク瓶) -->
            <div class="ink-bottles">
                <div class="ink-bottle peace interactive-object" data-emotion="peace">
                    <span class="ink-label">平穏</span>
                </div>
                <div class="ink-bottle chaos interactive-object" data-emotion="chaos">
                    <span class="ink-label">混沌</span>
                </div>
                <div class="ink-bottle fear interactive-object" data-emotion="fear">
                    <span class="ink-label">恐怖</span>
                </div>
                <div class="ink-bottle elation interactive-object" data-emotion="elation">
                    <span class="ink-label">高揚</span>
                </div>
            </div>
        </div>
        <!-- Silver Bookmark (Save Button) -->
        <div class="save-bookmark interactive-object" id="list-save-bookmark"></div>
    </div>

    <script src="js/script.js"></script>
    <script>
        // グローバル変数: 現在開いている本の感情とIDを保持
        let currentBookEmotion = 'chaos';
        let currentBookId = null;

        // グローバル関数: 詳細モーダルを開く
        function openDetailModalInList(bookId, emotion = 'chaos') {
            const detailModalOverlay = document.getElementById('detail-modal-overlay');
            const bookFrame = document.querySelector('.book-frame');
            const leftPage = document.getElementById('left-page');
            const rightPage = document.getElementById('right-page');

            // 現在の感情とIDを保存
            currentBookEmotion = emotion;
            currentBookId = bookId;

            console.log('[openDetailModalInList] Starting detail modal open sequence for book:', bookId, 'emotion:', emotion);

            // 瞬き演出を実行（閉眼）
            closeEyes(() => {
                console.log('[openDetailModalInList] Eyes closed, displaying modal...');

                // 感情に応じてbook-frameの背景画像を変更
                const emotionFrames = {
                    peace: 'url("assets/img_book_open_frame_peace.png")',
                    chaos: 'url("assets/img_book_open_frame_chaos.png")',
                    fear: 'url("assets/img_book_open_frame_fear.png")',
                    elation: 'url("assets/img_book_open_frame_elation.png")'
                };
                if (bookFrame && emotionFrames[emotion]) {
                    bookFrame.style.backgroundImage = emotionFrames[emotion];
                    console.log(`[openDetailModalInList] Book frame set to ${emotion} emotion`);
                }

                // closeEyesのコールバック：300ms後に実行される（閉眼完了）
                // モーダルを表示
                detailModalOverlay.classList.add('active');

                // 見開き本に内容を表示
                leftPage.innerHTML = `
                    <p>左ページの内容。これは夢日記の詳細表示画面です。ここに夢の内容が記述されます。昔々、あるところに…。</p>
                    <p>夜の帳が降り、静寂が世界を包み込む頃、私の意識は深い森の奥へと誘われた。そこには古びた石の門があり、蔦に覆われたその扉は、まるで遥か昔からそこに存在し続けているかのように見えた。微かな月明かりが、湿った土の道を照らし、私の足元に細く白い筋を描き出していた。</p>
                    <p>門の向こうには、霧に霞む庭園が広がっていた。手入れのされていない薔薇の木々が、鋭い棘を夜空に突き刺し、その先にはさらに古い洋館の影が横たわっていた。窓は全て黒く、まるで巨大な眼窩のようだった。私は恐怖と好奇心に駆られ、一歩、また一歩と、その未知の領域へと足を踏み入れた。</p>
                `;

                rightPage.innerHTML = `
                    <p>右ページの内容。続きや詳細情報がここに表示されます。この夢は安らぎの色に染まっていた。</p>
                    <p>洋館の中は、外観とは裏腹に、不思議なほど温かい空気に満ちていた。薄暗いホールには、埃を被った肖像画が何枚も飾られており、彼らの視線が私を追っているかのように感じられた。遠くから微かに聞こえるオルゴールの音色は、どこか懐かしく、しかし同時に不穏な響きを帯びていた。</p>
                    <p>私は最奥の部屋へと導かれた。そこには、大きな窓から差し込む満月光を浴びて、一冊の古めかしい本が開かれていた。羊皮紙のページには、理解できない古代文字が記されており、私はその意味を探ろうと、必死に目を凝らした。その瞬間、窓の外から眩い光が差し込み、私の意識は急激に覚醒へと向かっていった。</p>
                `;

                // 開眼を実行（50msの小さなバッファを追加して、モーダル表示を確実に）
                console.log('[openDetailModalInList] Opening eyes...');
                setTimeout(() => {
                    console.log('[openDetailModalInList] Calling openEyes()...');
                    openEyes();
                }, 50);
            });
        }

        // グローバル関数: 詳細モーダルを閉じる
        function closeDetailModalInList() {
            const detailModalOverlay = document.getElementById('detail-modal-overlay');

            // モーダルを非表示（瞬き演出なし）
            detailModalOverlay.classList.remove('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Check for opening eyes animation (from page transition)
            checkAndOpenEyes();

            const backButton = document.getElementById('back-to-library-button');
            const bookSpinesContainer = document.getElementById('book-spines-container');
            const paginationLeft = document.getElementById('pagination-left');
            const paginationRight = document.getElementById('pagination-right');
            const indexBoxTrigger = document.getElementById('index-box-trigger');
            const detailModalOverlay = document.getElementById('detail-modal-overlay');

            // Index Card Modal elements
            const indexCardModal = document.getElementById('index-card-modal');

            // 詳細モーダル外クリックで閉じる
            detailModalOverlay.addEventListener('click', (e) => {
                if (e.target === detailModalOverlay) {
                    closeDetailModalInList();
                }
            });

            // 編集ボタンクリック → 巻物モーダルへ遷移
            const detailEditButton = document.getElementById('detail-edit-button');
            const createEditModalOverlay = document.getElementById('create-edit-modal-overlay');
            const scrollMiddle = document.querySelector('.scroll-middle');

            detailEditButton.addEventListener('click', () => {
                playSound('sfx_ui_confirm.wav'); // Asset: 選択・決定音

                closeEyes(() => {
                    console.log('[Edit Button] Eyes closed, transitioning to edit modal...');

                    // 詳細モーダルを確実に消すため、transitionを一時的に無効化
                    detailModalOverlay.style.transition = 'none';

                    // a. 詳細モーダルを閉じる
                    detailModalOverlay.classList.remove('active');

                    // b. 巻物モーダルを折り畳み状態で表示（scroll-middleは既にheight: 0）
                    createEditModalOverlay.classList.add('active');

                    // 感情と色の対応（瞬き中に設定）
                    const emotionColors = {
                        peace: '#a0a9a6',
                        chaos: '#b07a70',
                        fear: '#838387',
                        elation: '#ca9e63'
                    };

                    // 現在の本の感情に応じてインクボトルを選択し、背景色を設定
                    const inkBottles = document.querySelectorAll('.ink-bottle');
                    inkBottles.forEach(bottle => {
                        if (bottle.dataset.emotion === currentBookEmotion) {
                            bottle.classList.add('selected');
                        } else {
                            bottle.classList.remove('selected');
                        }
                    });

                    // scroll-middleの背景色を設定
                    if (scrollMiddle && emotionColors[currentBookEmotion]) {
                        scrollMiddle.style.backgroundColor = emotionColors[currentBookEmotion];
                    }
                    console.log(`[Edit Button] Ink bottle selected: ${currentBookEmotion}, color: ${emotionColors[currentBookEmotion]}`);

                    // 開眼
                    setTimeout(() => {
                        openEyes();

                        // 詳細モーダルのtransitionを元に戻す
                        setTimeout(() => {
                            detailModalOverlay.style.transition = '';
                        }, 100);

                        // 開眼後、巻物の伸長アニメーション（600ms）
                        setTimeout(() => {
                            console.log('[Edit Button] Starting scroll unfurl...');
                            scrollMiddle.classList.add('unfurl');
                        }, 500);
                    }, 50);
                });
            });

            // 巻物モーダル外クリックで閉じる
            createEditModalOverlay.addEventListener('click', (e) => {
                if (e.target === createEditModalOverlay) {
                    console.log('[Scroll Modal] Starting close sequence...');

                    // 巻物収縮アニメーション開始
                    console.log('[Scroll Modal] Starting scroll-middle roll-up animation...');
                    scrollMiddle.classList.remove('unfurl');
                    scrollMiddle.classList.add('roll-up');

                    // 巻物収縮完了後に瞬きを実行
                    setTimeout(() => {
                        console.log('[Scroll Modal] Starting blink animation after scroll collapse...');

                        closeEyes(() => {
                            console.log('[Scroll Modal] Eyes closed, closing modal...');

                            // 瞬き中にモーダルを確実に消すため、transitionを一時的に無効化
                            createEditModalOverlay.style.transition = 'none';

                            // 瞬き中にモーダルを閉じる
                            createEditModalOverlay.classList.remove('active');
                            scrollMiddle.classList.remove('unfurl', 'roll-up');

                            // 残像を完全に消すため、heightを明示的に0にリセット
                            scrollMiddle.style.height = '0';

                            // scroll-middleの色とインクボトルの選択状態をリセット（瞬き中）
                            if (scrollMiddle) {
                                scrollMiddle.style.backgroundColor = '';
                            }
                            inkBottles.forEach(b => b.classList.remove('selected'));
                            console.log('[Scroll Modal] Scroll color and ink bottle selection reset during blink');

                            // 瞬き明け
                            setTimeout(() => {
                                console.log('[Scroll Modal] Opening eyes...');
                                openEyes();

                                // 次回表示のため、transitionを元に戻す
                                setTimeout(() => {
                                    createEditModalOverlay.style.transition = '';
                                }, 100);
                            }, 50);
                        });
                    }, 600); // 巻物アニメーション時間に合わせる（0.6s = 600ms）
                }
            });

            // Save Bookmark click (巻物モーダルを保存して閉じる)
            const saveBookmark = document.getElementById('list-save-bookmark');
            saveBookmark.addEventListener('click', () => {
                console.log('[Save Bookmark] Save button clicked - initiating save...');

                // 栞の発光演出
                console.log('[Save Bookmark] Starting bookmark glow animation...');
                saveBookmark.classList.add('glow');
                playSound('sfx_ui_confirm.wav'); // Asset: 選択・決定音

                // 発光アニメーション完了後に巻物を閉じる処理を開始
                setTimeout(() => {
                    console.log('[Save Bookmark] Glow animation complete, starting close sequence...');

                    // 巻物収縮アニメーション開始
                    scrollMiddle.classList.remove('unfurl');
                    scrollMiddle.classList.add('roll-up');

                    // 巻物収縮完了後に瞬きを実行
                    setTimeout(() => {
                        closeEyes(() => {
                            console.log('[Save Bookmark] Eyes closed, closing modal...');

                            // 瞬き中にモーダルを確実に消すため、transitionを一時的に無効化
                            createEditModalOverlay.style.transition = 'none';

                            // 瞬き中にモーダルを閉じる
                            createEditModalOverlay.classList.remove('active');
                            scrollMiddle.classList.remove('unfurl', 'roll-up');

                            // 残像を完全に消すため、heightを明示的に0にリセット
                            scrollMiddle.style.height = '0';

                            // scroll-middleの色とインクボトルの選択状態をリセット（瞬き中）
                            if (scrollMiddle) {
                                scrollMiddle.style.backgroundColor = '';
                            }
                            inkBottles.forEach(b => b.classList.remove('selected'));
                            console.log('[Save Bookmark] Scroll color and ink bottle selection reset during blink');

                            // 瞬き明け
                            setTimeout(() => {
                                console.log('[Save Bookmark] Opening eyes...');
                                openEyes();

                                // glowクラスを削除
                                saveBookmark.classList.remove('glow');

                                // 次回表示のため、transitionを元に戻す
                                setTimeout(() => {
                                    createEditModalOverlay.style.transition = '';
                                }, 100);

                                // 開眼後、保存した本の背表紙を光らせる
                                if (currentBookId) {
                                    const bookSpine = document.querySelector(`.book-spine[data-id="${currentBookId}"]`);
                                    if (bookSpine) {
                                        console.log(`[Save Bookmark] Glowing book spine with ID: ${currentBookId}`);
                                        bookSpine.classList.add('glow');

                                        // アニメーション終了後にglowクラスを削除
                                        setTimeout(() => {
                                            bookSpine.classList.remove('glow');
                                        }, 3000); // アニメーション時間と同じ（3s）
                                    }
                                }
                            }, 50);
                        });
                    }, 600); // 巻物アニメーション時間に合わせる（0.6s = 600ms）
                }, 300); // bookmark-glowアニメーションの時間
            });

            // Ink bottle click (感情選択 - scroll-middleの背景色変更)
            const inkBottles = document.querySelectorAll('.ink-bottle');

            // 感情と色の対応
            const emotionColors = {
                peace: '#a0a9a6',
                chaos: '#b07a70',
                fear: '#838387',
                elation: '#ca9e63'
            };

            inkBottles.forEach(bottle => {
                bottle.addEventListener('click', () => {
                    const emotion = bottle.dataset.emotion;

                    // 全てのボトルから選択状態を解除
                    inkBottles.forEach(b => b.classList.remove('selected'));

                    // クリックしたボトルを選択状態に
                    bottle.classList.add('selected');

                    // scroll-middleの背景色を変更
                    if (scrollMiddle && emotionColors[emotion]) {
                        scrollMiddle.style.backgroundColor = emotionColors[emotion];
                    }

                    playSound('sfx_ui_confirm.wav'); // Asset: 選択・決定音
                    console.log(`Emotion selected: ${emotion}, color: ${emotionColors[emotion]}`);
                });
            });

            backButton.addEventListener('click', () => {
                playSound('sfx_ui_confirm.wav'); // Asset: 選択・決定音
                navigateWithBlink('library.html');
            });

            // Book spine click to detail modal (モーダル方式)
            bookSpinesContainer.addEventListener('click', (event) => {
                const bookSpine = event.target.closest('.book-spine');
                if (bookSpine) {
                    const bookId = bookSpine.dataset.id;

                    // 感情クラスを取得（peace, chaos, fear, elation）
                    let emotion = 'chaos'; // デフォルト
                    if (bookSpine.classList.contains('peace')) emotion = 'peace';
                    else if (bookSpine.classList.contains('chaos')) emotion = 'chaos';
                    else if (bookSpine.classList.contains('fear')) emotion = 'fear';
                    else if (bookSpine.classList.contains('elation')) emotion = 'elation';

                    playSound('sfx_ui_confirm.wav'); // Asset: 選択・決定音
                    console.log(`Clicked book with ID: ${bookId}, emotion: ${emotion}`);

                    // list.html内のモーダル関数を呼び出す（感情を渡す）
                    openDetailModalInList(bookId, emotion);
                }
            });

            // Pagination (placeholder)
            paginationLeft.addEventListener('click', () => {
                playSound('sfx_screen_slide.wav'); // Asset: 画面スライド音
                initiateBlinkTransition(() => {
                    console.log('Navigate to previous page of books');
                    // In a real app, load previous page data here
                });
            });

            paginationRight.addEventListener('click', () => {
                playSound('sfx_screen_slide.wav'); // Asset: 画面スライド音
                initiateBlinkTransition(() => {
                    console.log('Navigate to next page of books');
                    // In a real app, load next page data here
                });
            });

            // Index Box click to open modal
            indexBoxTrigger.addEventListener('click', () => {
                playSound('sfx_index_box_open_close.wav'); // Asset: 索引箱の開閉音
                initiateBlinkTransition(() => {
                    console.log('Opening index card modal');
                    indexBoxTrigger.style.display = 'none'; // Hide trigger when modal opens
                    indexCardModal.classList.add('visible');
                    initIndexCardModal(); // Initialize modal functionality
                });
            });


            // Close modal by clicking outside the drawer
            indexCardModal.addEventListener('click', (event) => {
                if (event.target === indexCardModal) {
                    playSound('sfx_index_box_open_close.wav'); // Asset: 索引箱の開閉音
                    initiateBlinkTransition(() => {
                        console.log('Closing index card modal by overlay click');
                        indexCardModal.classList.remove('visible');
                        indexBoxTrigger.style.display = 'block'; // Show trigger when modal closes
                    });
                }
            });
        });
    </script>
</body>
</html>
<% content_for :title, "夢日記帳 - 静寂の書斎" %>
<% content_for :html_class, "after-door library-page" %>

<% content_for :head do %>
    <script>
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('blink') === 'open') {
                document.documentElement.classList.add('will-open-eyes');
            }
        })();
    </script>
<% end %>

    <!-- 4:3 Viewport with outer wall as background (from 5.5) -->
    <div class="viewport-container">
        <!-- Asset: bg_library_desk.png applied as body background -->

        <div class="interactive-area desk-scroll interactive-object" id="desk-scroll">
            <!-- インタラクティブ要素: 机の上の巻物。クリックで「夢を編む」ページへ遷移。 -->
            <!-- 縮小版巻物UI（机上）5.4.2. 参照 -->
            <p id="desk-scroll-text" style="color:white; text-align:center; margin:0 0 10px 0;">夢を編む (作成)</p>

            <div class="desk-scroll-mini interactive-object" id="desk-scroll-mini">
                <!-- Asset: LocalStorage メモ有無に応じて画像を切り替え（JavaScript） -->
            </div>
        </div>

        <div class="interactive-area bookshelf interactive-object" id="bookshelf">
            <!-- インタラクティブ要素: 本棚。クリックで「記憶の目録」ページへ遷移。 -->
            <p style="color:white; text-align:center; margin: 0;">記憶の目録 (一覧)</p>
        </div>

        <div class="interactive-area window interactive-object" id="window">
            <!-- インタラクティブ要素: 窓。クリックで「夢の氾濫」特殊ギミックを発動。 -->
            <p style="color:white; text-align:center;">窓 (夢の氾濫)</p>
        </div>

        <div class="interactive-area mirror interactive-object" id="mirror">
            <!-- インタラクティブ要素: 鏡。クリックで「目覚める」（ログアウト処理）を発動。 -->
            <p style="color:white; text-align:center;">鏡 (目覚める)</p>
        </div>

        <%= render 'shared/modals/dream_flood' %>
    </div>

    <%= render 'shared/modals/scroll_modal', bookmark_id: 'library-save-bookmark' %>

    
    <script>
        // グローバル関数: 作成編集モーダルを開く
        function openCreateEditModal(isEdit = false) {
            const createEditModalOverlay = document.getElementById('create-edit-modal-overlay');
            const scrollMiddle = document.querySelector('.scroll-middle');
            const deskScrollMini = document.getElementById('desk-scroll-mini');
            const deskScrollText = document.getElementById('desk-scroll-text');

            console.log('[openCreateEditModal] Starting create/edit modal open sequence, isEdit:', isEdit);

            // 瞬き演出を実行
            closeEyes(() => {
                console.log('[openCreateEditModal] Eyes closed, displaying modal...');

                // 瞬き中に縮小版巻物とテキストを非表示にする（机の上の巻物が手に取られた感覚を演出）
                if (deskScrollMini) {
                    deskScrollMini.classList.add('hidden');
                    console.log('[openCreateEditModal] Desk scroll mini hidden during blink');
                }
                if (deskScrollText) {
                    deskScrollText.classList.add('hidden');
                    console.log('[openCreateEditModal] Desk scroll text hidden during blink');
                }

                // 瞬き中にモーダルオーバーレイを表示（巻物は見えない状態：scroll-middle height 0）
                createEditModalOverlay.classList.add('active');

                // 開眼を実行（50msの小さなバッファを追加して、モーダル表示を確実に）
                console.log('[openCreateEditModal] Opening eyes...');
                setTimeout(() => {
                    console.log('[openCreateEditModal] Calling openEyes()...');
                    openEyes();

                    // 目が開いた後、点滅アニメーション完了後に巻物の展開アニメーションを開始
                    setTimeout(() => {
                        console.log('[openCreateEditModal] Starting scroll-middle unfurl animation...');
                        scrollMiddle.classList.add('unfurl');
                        // playSound('sfx_scroll_unfurl.wav'); // Asset: 巻物を広げる音
                    }, 500); // openEyes()の点滅アニメーション完了を待つ
                }, 50);
            });
        }

        // グローバル関数: 作成編集モーダルを閉じる
        function closeCreateEditModal() {
            const createEditModalOverlay = document.getElementById('create-edit-modal-overlay');
            const scrollMiddle = document.querySelector('.scroll-middle');
            const deskScrollMini = document.getElementById('desk-scroll-mini');
            const deskScrollText = document.getElementById('desk-scroll-text');

            console.log('[closeCreateEditModal] Starting close sequence...');

            // 巻物収縮アニメーション開始
            console.log('[closeCreateEditModal] Starting scroll-middle roll-up animation...');
            scrollMiddle.classList.remove('unfurl');
            scrollMiddle.classList.add('roll-up');
            // playSound('sfx_scroll_roll_up.wav'); // Asset: 巻物の収束音

            // 巻物収縮完了後に瞬きを実行（巻物から本への遷移を隠蔽、または机に戻す）
            setTimeout(() => {
                console.log('[closeCreateEditModal] Starting blink animation after scroll collapse...');

                closeEyes(() => {
                    console.log('[closeCreateEditModal] Eyes closed, preparing modal closure...');

                    // 瞬き中にモーダルを確実に消すため、transitionを一時的に無効化
                    createEditModalOverlay.style.transition = 'none';

                    // 瞬き中にモーダルを閉じる
                    createEditModalOverlay.classList.remove('active');
                    scrollMiddle.classList.remove('unfurl', 'roll-up');

                    // 残像を完全に消すため、heightを明示的に0にリセット
                    scrollMiddle.style.height = '0';

                    // scroll-middleの色とインクボトルの選択状態をリセット（瞬き中）
                    const inkBottlesForReset = document.querySelectorAll('.ink-bottle');
                    if (scrollMiddle) {
                        scrollMiddle.style.backgroundColor = ''; // CSSデフォルトに戻す
                    }
                    inkBottlesForReset.forEach(b => b.classList.remove('selected'));
                    console.log('[closeCreateEditModal] Scroll color and ink bottle selection reset during blink');

                    // フォーム入力内容をクリア（保存時のリセット）
                    const dreamTitleInput = document.getElementById('dream-title-input');
                    const dreamTextarea = document.getElementById('dream-textarea');
                    const characterTagInput = document.getElementById('character-tag-input');
                    const locationTagInput = document.getElementById('location-tag-input');
                    const characterTagsDisplay = document.getElementById('character-tags-display');
                    const locationTagsDisplay = document.getElementById('location-tags-display');

                    if (dreamTitleInput) dreamTitleInput.value = '';
                    if (dreamTextarea) dreamTextarea.value = '';
                    if (characterTagInput) characterTagInput.value = '';
                    if (locationTagInput) locationTagInput.value = '';
                    if (characterTagsDisplay) characterTagsDisplay.innerHTML = '';
                    if (locationTagsDisplay) locationTagsDisplay.innerHTML = '';
                    console.log('[closeCreateEditModal] Form inputs cleared for next use');

                    // 瞬き明け
                    setTimeout(() => {
                        console.log('[closeCreateEditModal] Opening eyes and restoring desk scroll mini...');
                        openEyes();

                        // 次回表示のため、transitionを元に戻す
                        setTimeout(() => {
                            createEditModalOverlay.style.transition = '';
                        }, 100);
                    }, 50);

                    // 縮小版巻物とテキストを瞬きのタイミングで確実に再表示
                    setTimeout(() => {
                        if (deskScrollMini) {
                            deskScrollMini.classList.remove('hidden');
                            console.log('[closeCreateEditModal] Desk scroll mini shown - returned to desk');
                        }
                        if (deskScrollText) {
                            deskScrollText.classList.remove('hidden');
                            console.log('[closeCreateEditModal] Desk scroll text shown - returned to desk');
                        }
                    }, 100); // 瞬き明けのアニメーション完了後に表示
                });
            }, 600); // 巻物アニメーション時間に合わせる（0.6s = 600ms）
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Check for opening eyes animation (from page transition)
            checkAndOpenEyes();

            const deskScroll = document.getElementById('desk-scroll');
            const bookshelf = document.getElementById('bookshelf');
            const windowElement = document.getElementById('window');
            const mirror = document.getElementById('mirror');
            const dreamFloodOverlay = document.getElementById('dream-flood-overlay');
            const createEditModalOverlay = document.getElementById('create-edit-modal-overlay');

            // Play ambient sound (placeholder)
            // Commented out: playSound('sfx_library_ambience.mp3'); // Asset: 書斎の環境音 (loop)

            // Desk/Scroll click (夢を編む機能への遷移 - モーダル方式)
            deskScroll.addEventListener('click', () => {
                playSound('sfx_ui_confirm.wav'); // Asset: 選択・決定音
                openCreateEditModal(false); // false = 新規作成モード
            });

            // Create/Edit Modal: 外クリックで閉じる
            createEditModalOverlay.addEventListener('click', (e) => {
                if (e.target === createEditModalOverlay) {
                    closeCreateEditModal();
                    playSound('sfx_ui_confirm.wav'); // Asset: 選択・決定音
                }
            });

            // Bookshelf click (記憶の目録機能への遷移)
            bookshelf.addEventListener('click', () => {
                // Asset: ズームイン/アウト音 (sfx_zoom_in_out.wav)
                // 書斎から一覧へ（別ページ遷移）
                navigateWithBlink('<%= list_path %>');
            });

            // Window click (夢の氾濫ギミックの発動)
            windowElement.addEventListener('click', () => {
                playSound('sfx_glass_warp.wav'); // Asset: ガラスの歪む音
                dreamFloodOverlay.classList.add('active');
                // Auto-hide after 1 minute, or click outside to close
                setTimeout(() => {
                    if (dreamFloodOverlay.classList.contains('active')) {
                        dreamFloodOverlay.classList.remove('active');
                    }
                }, 60000); // 1 minute
            });
            
            // Click outside dream flood text to close
            dreamFloodOverlay.addEventListener('click', (event) => {
                if (event.target === dreamFloodOverlay) { // Only if clicking the overlay itself, not the text
                    dreamFloodOverlay.classList.remove('active');
                    playSound('sfx_ui_confirm.wav'); // Asset: 選択・決定音 (オーバーレイを閉じる確認音)
                }
            });

            // Save Bookmark click (Save/Close create-edit modal - 定着の儀式)
            const saveBookmark = document.getElementById('library-save-bookmark');
            saveBookmark.addEventListener('click', () => {
                console.log('[Save Bookmark] Save button clicked - initiating save ritual');

                // 栞の発光演出（保存の儀式を視覚的に表現）
                console.log('[Save Bookmark] Starting bookmark glow animation...');
                saveBookmark.classList.add('glow');
                playSound('sfx_ui_confirm.wav'); // Asset: 選択・決定音

                // 発光アニメーション完了後にモーダルを閉じる
                setTimeout(() => {
                    console.log('[Save Bookmark] Glow animation complete, closing modal...');
                    closeCreateEditModal();
                    // playSound('sfx_scroll_roll_up.wav'); // Asset: 巻物の収束音 (closeCreateEditModal内で実行)

                    // アニメーション終了後にglowクラスを削除
                    setTimeout(() => {
                        saveBookmark.classList.remove('glow');
                    }, 600); // closeCreateEditModalの処理時間に合わせる
                }, 300); // bookmark-glowアニメーションの時間
            });

            /* ============================================================
             * 段階2：本の実体化アニメーション（将来実装：アセット到着時に有効化）
             * ============================================================
             *
             * Assets Required:
             * - img_book_closed_front.png (本：正面（閉）)
             * - img_book_half_open.png (本：半分開きかけ)
             *
             * Animation Sequence (Timing: 栞の発光完了後 0.3s に開始):
             * 1. 巻物の中間部分が高速で縮小（Height: 0）
             *    - Sound: sfx_scroll_roll_up.wav（巻物の収束音）
             *
             * 2. 本のパラパラ漫画アニメーション（モーダル内中央）
             *    - img_book_half_open.png を表示（0.1s〜0.2s）
             *    - img_book_closed_front.png に切り替わる
             *    - Sound: sfx_book_close.wav（重厚な閉本音）を同期
             *
             * 3. 本が飛び去る演出
             *    - 本がモーダル背後の本棚へ縮小しながら飛んでいく
             *    - モーダルが閉じる
             *    - 書斎のぼかしが解除される
             *
             * 4. 本棚のテクスチャ更新
             *    - 蔵書数に応じて段階（小/中/大）へ更新
             *
             * Note: テキスト内容は表示しない（本のビジュアルアニメーションのみ）
             * Deferred: Assets未到着のため、段階1（発光演出）のみ実装
             * Status: 詳細な仕様で実装準備完了、アセット到着時に実装可能
             * ============================================================ */

            // Ink bottle click (感情選択 - scroll-middleの背景色変更)
            const inkBottles = document.querySelectorAll('.ink-bottle');
            const scrollMiddle = document.querySelector('.scroll-middle');

            // 感情と色の対応
            const emotionColors = {
                peace: '#a0a9a6',
                chaos: '#b07a70',
                fear: '#838387',
                elation: '#ca9e63'
            };

            inkBottles.forEach(bottle => {
                bottle.addEventListener('click', () => {
                    const emotion = bottle.dataset.emotion;

                    // 全てのボトルから選択状態を解除
                    inkBottles.forEach(b => b.classList.remove('selected'));

                    // クリックしたボトルを選択状態に
                    bottle.classList.add('selected');

                    // scroll-middleの背景色を変更
                    if (scrollMiddle && emotionColors[emotion]) {
                        scrollMiddle.style.backgroundColor = emotionColors[emotion];
                    }

                    playSound('sfx_ui_confirm.wav'); // Asset: 選択・決定音
                    console.log(`Emotion selected: ${emotion}, color: ${emotionColors[emotion]}`);
                });
            });

            // Mirror click (Logout - 目覚める儀式)
            mirror.addEventListener('click', () => {
                // Mirror effect (wave distortion)
                console.log('Mirror clicked - initiating awakening effect');

                // Logout sequence with awakening effect (3.4.1)
                logoutWithAwakeningEffect();
            });
        });
    </script>

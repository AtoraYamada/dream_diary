# 書斎（静寂の書斎）

アプリのハブとなる画面。「ポイント＆クリック」形式で、各機能へアクセスする。

---

## 要件

- 巻物クリックで作成画面へ
- 本棚クリックで一覧画面へ
- 窓クリックで夢の氾濫演出へ
- 鏡クリックでログアウト（目覚めの儀式）へ
- 本棚の蔵書画像が夢日記の冊数によって変化
- 縮小版巻物の状態がLocalStorageの有無によって変化
- 書斎の環境音をループ再生

---

## 設計判断

| 項目 | 選択 | 理由 |
|------|------|------|
| UI形式 | ポイント＆クリック | 没入型の探索体験を提供 |
| 本棚の表示 | 冊数による動的切替 | 蔵書の増加を視覚的に表現 |
| 縮小版巻物 | LocalStorageの有無で画像切替 | 下書きの存在を視覚的に示唆 |
| 環境音 | ループ再生（トップページ以外の全画面） | 夢の世界の雰囲気を統一 |

---

## 画面構成

| レイヤー | 要素 | 説明 |
|---------|------|------|
| 背景 | 書斎の背景 | 机・窓・鏡・壁が描き込まれたベース画像（`bg_library_desk.png`） |
| 中景 | 本棚（蔵書テクスチャ） | 夢日記の冊数に応じて画像を切り替え（`img_bookshelf_*.png`） |
| 前景（手前） | 縮小版巻物 | 机の上に配置。LocalStorageの有無で画像切り替え（`img_scroll_mini_*.png`） |
| 前景（左側） | 窓 | クリックで夢の氾濫（`screens/overflow.md`） |
| 前景（隅） | 鏡 | クリックでログアウト（`screens/logout.md`） |

### 本棚の蔵書画像

JavaScriptで夢日記の冊数に応じて画像ファイルを動的に切り替え：

| 冊数 | アセット |
|------|----------|
| 0冊 | `img_bookshelf_empty.png` |
| 1-3冊 | `img_bookshelf_small.png`（上段のみ） |
| 4-7冊 | `img_bookshelf_medium.png`（中段まで） |
| 8冊以上 | `img_bookshelf_large.png`（下段まで） |

### 縮小版巻物の状態表示

JavaScriptでLocalStorageの有無に応じて画像ファイルを動的に切り替え：

| LocalStorage | アセット |
|-------------|----------|
| なし | `img_scroll_mini_blank.png`（白紙） |
| あり | `img_scroll_mini_draft.png`（書きかけ） |

---

## UI動作

### 縮小版巻物をクリック（作成画面へ）

**トリガー**: 机上の縮小版巻物をクリック

**動作**:
1. 瞬き演出（`animations.md` 参照）
2. 瞬き（暗転中）: 縮小版巻物が非表示、背景がぼかし状態に
3. 瞬き（明転）: 閉じた状態の巻物が表示される
4. 巻物展開演出（`animations.md` 参照）
5. 作成画面（`create.md`）がモーダル表示される

### 本棚をクリック（一覧画面へ）

**トリガー**: 本棚オブジェクトをクリック

**動作**:
1. 本棚へズームイン（300ms）
2. SE: `sfx_zoom_in_out.wav`
3. 瞬き演出（`animations.md` 参照）
4. 一覧画面（`list.md`）へ遷移

### 窓をクリック（夢の氾濫）

**トリガー**: 窓をクリック

**動作**: 夢の氾濫演出（`overflow.md`）が開始

### 鏡をクリック（ログアウト）

**トリガー**: 鏡をクリック

**動作**: 目覚めの儀式（`logout.md`）が開始

### ホバー効果

| オブジェクト | ホバー動作 |
|-------------|-----------|
| 巻物 | 発光 |
| 本棚 | 発光 |
| 窓 | 七色に光りながら楕円が収縮 |
| 鏡 | 黄色く白く光りながら楕円が収縮 |

---

## エラーハンドリング

該当なし（画面遷移のみ）

---

## データ送受信（API）

### 夢日記の冊数取得（本棚画像切替用）

**エンドポイント**: `GET /api/v1/dreams`（パラメータ: `count_only=true`）

**レスポンス（成功: 200）**:
```json
{
  "count": 5
}
```

**用途**: 書斎画面表示時に冊数を取得し、本棚画像を切り替え

### ログアウト

**エンドポイント**: `DELETE /users/sign_out`

**レスポンス（成功: 200）**:
```json
{
  "message": "Logged out successfully."
}
```

---

## 演出

`animations.md` の以下のセクションを参照：
- 書斎（メインハブ） > 環境音
- 書斎（メインハブ） > 縮小版巻物をクリック（作成画面へ）
- 書斎（メインハブ） > 本棚をクリック（一覧画面へ）
- 書斎（メインハブ） > ホバー効果

---

## 実装状況

### バックエンド（API）

- [ ] GET /api/v1/dreams?count_only=true（Dreams#index）
- [ ] DELETE /users/sign_out（Sessions#destroy）

### フロントエンド

- [ ] HTMLビュー（app/views/pages/library.html.erb）
- [ ] JavaScript（app/javascript/library.js）
- [ ] CSS（app/assets/stylesheets/library.css）
- [ ] 画面表示
- [ ] 本棚蔵書画像の動的切替（冊数取得API連携）
- [ ] 縮小版巻物の状態表示（LocalStorage確認）
- [ ] ホバー発光効果
- [ ] 巻物クリック→作成画面遷移
- [ ] 本棚クリック→一覧画面遷移（ズーム演出）
- [ ] 窓クリック→夢の氾濫
- [ ] 鏡クリック→目覚めの儀式
- [ ] 書斎の環境音（sfx_library_ambience.mp3）ループ再生
- [ ] 演出・SE再生

**Note**: プロトタイプ（`prototype/`）に参考実装あり。Rails本体への統合が必要。

# 要件定義書：夢日記帳 (Dream Library)

## 1. プロジェクト概要

夢で見た内容を「忘れないうちに記録」し、「自分だけの書斎」に蓄積していくWebアプリ。
Mystのような没入感のある世界観と、PS1時代のレトロな質感を重視し、単なる実用ツールではなく「体験」としての夢日記を提供する。

---

## 2. ユーザー体験フロー

1. **【現実】** トップページ（森の扉）にアクセス。音声推奨文とミュートボタンを確認。
2. **【移行】** 扉をクリック。ズームと瞬きの演出を経て、扉の開く音と共にログイン・サインアップ画面へ。
3. **【境界】** ログイン前に殴り書きしたメモ（LocalStorage）を保持したままサインアップ/ログイン。
4. **【夢の中】** 「夢の書斎（マイページ）」へ到達。
5. **【定着】** 机の上のメモから「夢を編む（作成）」へ。メモがなくても作成可能。
6. **【一覧】** 本棚から「記憶の目録（一覧）」へ。索引箱で検索が可能。
7. **【閲覧】** 本棚に収まっている本をクリック。夢日記が開く。
8. **【編集・削除】** 閲覧ページから編集へ。削除も可能。
9. **【氾濫】** 「夢の書斎（マイページ）」の窓をクリックで、夢日記からランダムな文を抽出、その場限りの夢の断片生成。
10. **【目覚め】** 「夢の書斎（マイページ）」の鏡をクリックでログアウト。「夢から覚める」演出を経て、トップページ（現実）へ戻る。

---

## 3. 共通仕様

### 3.1. CRUD対応表

| 画面名（世界観呼称） | 主要オブジェクト | CRUD | 状態管理の主体 | 備考 |
| :--- | :--- | :---: | :--- | :--- |
| **現実（トップ）** | 殴り書きの紙片 | **C** | LocalStorage | ログイン前の一時保存 |
| **入館手続き（Auth）** | 入館証 | **R** | Session/DB | ログイン・サインアップ |
| **静寂の書斎（メイン）** | 巻物・窓・正面本棚・鏡 | **-** | Session | 各機能へのハブ、特殊演出、鏡でログアウト |
| **夢を編む（作成/編集）** | 巻物 | **C / U** | DB (API) | LocalStorageからデータ継承 |
| **記憶の目録（一覧）** | 正面本棚・背表紙・索引箱 | **R** | DB (API) | 索引（検索・絞り込み）、ページネーション |
| **記憶の断片（詳細）** | 見開きの本 | **R / D** | DB (API) | 夢の削除（忘却演出） |

---

### 3.2. 共通演出パターン定義

本セクションでは、複数の画面で共通して使用される演出パターンを定義します。各画面では「共通演出：パターン名」として参照します。

#### 瞬き演出

**用途**: 画面遷移時の視覚的な区切り

**演出フロー**:
1. **暗転**
   - 画面全体がフェードアウト
   - SE: `sfx_blink.wav`

2. **明転**
   - 新しい画面がフェードイン
   - SE: なし

**使用箇所**: トップ→認証、認証→書斎、書斎→一覧、作成開始、保存完了、詳細→編集、索引箱の開閉、等

---

#### ズーム演出

**用途**: オブジェクトに接近・離反する際の空間移動

**演出フロー**:
1. **ズームイン/アウト**
   - 対象オブジェクトへの視点移動
   - SE: `sfx_zoom_in_out.wav`

**使用箇所**: 書斎→一覧、一覧→書斎

---

#### 本の実体化演出

**用途**: 夢日記が「本」として物理的に現れる演出

**演出フロー**:
1. **半開きの本の出現**（瞬間）
   - 本が半開き状態で空間に現れる（`img_book_half_open_*.png`）

2. **完全に閉じる**
   - 本が閉じる（`img_book_closed_*.png`）
   - SE: `sfx_book_close_heavy.wav`（重厚な閉本音）

**使用箇所**: 作成後の定着、編集後の更新

---

#### 巻物展開/収束演出

**用途**: 作成・編集画面の開始・終了

**展開フロー**:
1. **巻物の出現・展開**
   - モーダルとして巻物が出現し、展開される
   - SE: `sfx_scroll_unfurl.wav`

**収束フロー**:
1. **巻物が巻き取られる**
   - 巻物がシュルシュルと巻き取られる
   - SE: `sfx_scroll_roll_up.wav`

**使用箇所**: 作成・編集画面の開始・終了

---

#### 画面スライド演出

**用途**: ページネーション等、横方向の画面移動

**演出フロー**:
1. **スライド**
   - 画面全体が左右にスライド
   - SE: `sfx_screen_slide.wav`

**使用箇所**: 一覧のページネーション

---

#### 選択・決定音

**用途**: UIボタン押下時の汎用SE

**タイミング**: ボタンクリック時（即時）
**SE**: `sfx_ui_confirm.wav`（世界観に合う「コッ」という短い木製音）

**使用箇所**: すべてのボタン操作（特定SEが定義されていない場合）

---

### 3.3. 画面構成の基本

#### 4:3ビューポートの固定

- メイン画面は **4:3（320x240基準）** を維持し、ブラウザ中央に配置
- 4:3画面の外側には、「暗い石壁」（`bg_stone_wall_dark.png`）を配置し、世界観を補強する（全画面共通の最背面）

#### PS1フィルタ（質感演出）

**演出の注力ポイント**: 複雑な3D挙動よりも、CSSアニメーションの「イージング」や「SE（効果音）との同期」に注力することで、低コストで高い没入感を実現する。

- **解像度とディザリング**: 全てのアセットを低解像度でレンダリングし、エッジを際立たせる。グラデーションにはディザリング処理を施す。
- **ジッター（不規則な揺れ）演出**: 特定のオブジェクトに微細なアニメーションで不規則な揺れを付与する。
- **ポストプロセス**: 画面全体の統一感を出すため、コントラスト・明度・セピア調整を全コンポーネントに一括適用する。

#### テクスチャの共通化

**共通ベース（羊皮紙の地色）**:
- 作成用巻物と見開き本のページは同一のアンティークな羊皮紙の地色・ノイズ感を採用
- 感情彩色が適用されていないデフォルト状態のベース質感

**構造的差異**:
- **巻物**: 垂直方向の波打ち、両端の「巻き癖」による影
- **見開き本**: 中央の「ノド（綴じ目）」に濃い影、左右ページの緩やかなカーブ

---

### 3.4. 横断的要件

#### メタデータ

**タグ**: 「登場人物」「場所」の2軸

**明晰夢チェック**: 「これは夢だと気づいていたか」

**感情彩色**: 「平穏・混沌・恐怖・高揚」から選択
- 作成・編集時の巻物の紙色に適用
- 背表紙、閉じた本、半開きの本、見開きの本すべてに適用

#### モバイル・レスポンシブ

- LocalStorageは端末固有（同期なし）
- ホバー→2段階タップ（1.タイトル表示、2.詳細遷移）
- 一覧/詳細は横持ち推奨、作成/編集は縦持ち最適化

#### 保存失敗時の救済処理

**通信中**:
- 巻物が震える

**失敗時**:
- モーダルは開いたまま、フォーム上にデータが残る
- 自動保存されたLocalStorageデータも保持される
- PS1風ノイズ、「不協和音（グリッチ音）」と共に「記憶が定着しません。霧が深すぎます。」等のメッセージ表示
- SE: `sfx_glitch_dissonance.wav`
- ユーザーは再度保存を試行可能
- 最終救済: クリップボードへコピーボタン

**自動保存**:
- 作成・編集画面でも入力中にLocalStorageへ自動保存
- 作成画面: `scratch_memo`（トップページと共有）
- 編集画面: `draft_dream_edit_{id}`

#### ナビゲーション制御

- `history.pushState`で仮想履歴
- ブラウザバック時は逆再生アニメーション
- 未保存時は警告「未定着の記憶が霧に消えます。現実に戻りますか？」

---

## 4. 機能要件（画面フロー順）

### 4.1. 現実（トップページ）【MVP】

#### 概要

トップページは「夢が消える前に捕まえる」切迫感と没入感を優先する。
ログイン前の殴り書きメモ機能により、ユーザーは認証前でも夢を記録できる。

---

#### 画面構成

| レイヤー | 要素 | 説明 |
|---------|------|------|
| 背景 | 森の扉 | 全画面を覆う背景画像（`bg_top_forest_door.png`）。ズームに耐える高解像度 |
| 中景 | 殴り書きの紙片 | 初期状態：扉の傍らに小さな「紙片」が落ちている。クリックで展開（`img_scratchpad_paper.png`） |
| 前景（上部） | 音声推奨文 | 画面中央上部に音声推奨文を表示 |
| 前景（右上） | ミュートボタン | 右上に配置 |

---

#### 入力フィールド

| フィールド | 必須 | 型 | 制約 | 初期値 | 備考 |
|-----------|------|-----|------|--------|------|
| メモ本文 | - | text | 最大2,000文字 | LocalStorageから復元 | 1文字ごとに自動保存 |

---

#### 操作フロー

##### 操作1：紙片の展開

**トリガー**: 紙片をクリック

**演出フロー**:
1. **紙片の移動・拡大**
   - 紙片が画面中央へ移動し拡大
   - 背景が減光
   - SE: なし

**結果**:
- 入力可能状態になる
- カーソルが「鉛筆」に変化（`cursor_pencil.png`）
- LocalStorageに保存されたテキストがあれば復元

---

##### 操作2：テキスト入力

**トリガー**: 入力エリアにフォーカス

**演出**:
- カーソルが「鉛筆」に変化（`cursor_pencil.png`）
- 「鉛筆の筆記音」ループ再生（フォーカス中のみ）
- SE: `sfx_pencil_write.wav`
- 1文字入力ごとにLocalStorageへ自動保存（debounceなし）

**データ保存**:
- キー: `scratch_memo`
- 構造（トップページ）:
  ```json
  {
    "content": "テキスト",
    "timestamp": 1234567890
  }
  ```

---

##### 操作3：紙片を閉じる

**トリガー**: 閉じるボタンをクリック

**演出フロー**:
1. **紙片の縮小・移動**
   - 紙片が元の位置へ戻る
   - 背景の減光解除
   - SE: なし

**結果**:
- LocalStorageの内容は保持
- 紙片の外観は変化なし

---

##### 操作4：扉をクリック（認証画面へ遷移）

**トリガー**: 扉をクリック

**演出フロー**:
1. **AudioContext有効化**（即時）
   - ブラウザ音声対応のため、最初のクリックでAudioContextを有効化

2. **共通演出：瞬き**（セクション3.2参照）
   - SE: `sfx_blink.wav`

3. **扉の開閉音**（瞬き中）
   - SE: `sfx_door_open_heavy.wav`

**結果**: 認証画面（4.2）へ遷移

---

#### データ要件

**LocalStorage**:
- キー: `scratch_memo`
- 構造（トップページ時点）:
  ```json
  {
    "content": "入力されたテキスト",
    "timestamp": 1234567890
  }
  ```
- ライフサイクル:
  - 発生: 未ログイン状態での入力
  - 継承: ログイン後の作成画面（4.4）で本文の初期値として使用
  - 削除: DB保存成功時
- タイムスタンプ管理:
  - ログイン後、作成画面を開く際に自動比較
  - DBの最終更新日時より新しければ復元を提案

---

#### 特記事項

- **入力制限**: 最大2,000文字
- **現実の質感**: 素朴な「紙片」と「鉛筆カーソル/筆記音」で、夢の中の豪華な巻物と対比

---

### 4.2. 入館手続き（認証）【MVP】

#### 概要

現実から夢（書斎）へアクセスするための「手続きの場」。
ログイン・サインアップ機能を提供する。

---

#### 画面構成

| レイヤー | 要素 | 説明 |
|---------|------|------|
| 背景 | シュールで幾何学的な廊下 | 奥に続く廊下のシルエット（`bg_auth_corridor.png`） |
| 中景 | バインダー | クリップとボードの質感・形状（`img_binder.png`） |
| 前景 | 入館証カード | 「継続（ログイン）」（`img_auth_card_in.png`）と「新規（サインアップ）」（`img_auth_card_up.png`）のカードが前後にズレて重なる（初期：ログインが前面） |
| 前景（左上） | 戻るボタン | トップページへ戻る（`icon_back.png`） |

---

#### 入力フィールド

**ログイン**:
| フィールド | 必須 | 型 | 制約 | 備考 |
|-----------|------|-----|------|------|
| メールアドレスまたはユーザー名 | ○ | string | メール形式またはユーザー名形式 | どちらでもログイン可能 |
| パスワード | ○ | string | 最小6文字 | |

**サインアップ**:
| フィールド | 必須 | 型 | 制約 | 備考 |
|-----------|------|-----|------|------|
| ユーザー名 | ○ | string | 英数字・アンダースコア・日本語 | 一意性制約 |
| メールアドレス | ○ | string | メール形式 | 一意性制約 |
| パスワード | ○ | string | 最小6文字 | |
| パスワード確認 | ○ | string | パスワードと一致 | |

---

#### 操作フロー

##### 操作1：カード切り替え（ログイン⇔サインアップ）

**初期表示**:
- ログインカードが前面に表示
- サインアップカードが背面にズレて重なっており、一部が見える

**トリガー**: 背面に見えているカードをクリック

**演出フロー**:
1. **カードの前後入れ替え**
   - クリックされたカードが前面に移動
   - 前面にあったカードが背面に移動（ズレて一部が見える状態に）
   - SE: `sfx_auth_card_slide.wav`

**結果**: ログイン⇔サインアップフォームが切り替わる

---

##### 操作2：ログイン成功

**トリガー**: ログインボタンをクリック、認証成功

**演出フロー**:
1. **共通演出：瞬き**（セクション3.2参照）
   - SE: `sfx_blink.wav`

2. **境界を越える音**（瞬き中）
   - 澄んだチャイムや光の音
   - SE: `sfx_boundary_pass.wav`

**結果**: 書斎画面（4.3）へ遷移

---

##### 操作3：認証エラー

**トリガー**: ログイン失敗、サインアップ失敗

**演出フロー**:
1. **文字の崩壊**
   - 入力文字が砂のように崩れ落ちる
   - SE: `sfx_sand_crumble.wav`

2. **エラーメッセージ表示**（即時）
   - 儚いエラーメッセージ表示

**結果**: 入力フィールドがクリアされ、再入力可能状態

---

##### 操作4：戻るボタン

**トリガー**: 左上の戻るボタンをクリック

**演出フロー**:
1. **共通演出：瞬き**（セクション3.2参照）

**結果**: トップページ（4.1）へ戻る

---

#### 特記事項

- **ビジュアルコンセプト**: 継続（ログイン）は古びれた紙、新規（サインアップ）は綺麗な新しい紙で視覚的に差別化
- **LocalStorage継承**: ログイン成功後、トップページのLocalStorageメモは保持され、作成画面で使用可能

---

### 4.3. 静寂の書斎（メインハブ）【MVP】

#### 概要

アプリのハブとなる画面。「ポイント＆クリック」形式で、各機能へアクセスする。

---

#### 画面構成

| レイヤー | 要素 | 説明 |
|---------|------|------|
| 背景 | 書斎の背景 | 机・窓・鏡・壁が描き込まれたベース画像（`bg_library_desk.png`） |
| 中景 | 本棚（蔵書テクスチャ） | 夢日記の冊数に応じて画像を切り替え（`img_bookshelf_*.png`） |
| 前景（手前） | 縮小版巻物 | 机の上に配置。LocalStorageの有無で画像切り替え（`img_scroll_mini_*.png`） |
| 前景（左側） | 窓 | クリックで夢の氾濫（4.10） |
| 前景（隅） | 鏡 | クリックでログアウト（4.11） |

---

#### 操作フロー

##### 操作1：縮小版巻物をクリック（作成画面へ）

**トリガー**: 机上の縮小版巻物をクリック

**演出フロー**:
1. **共通演出：瞬き**（セクション3.2参照）
   - 瞬き（暗転中）: 縮小版巻物が非表示、背景がぼかし状態に
   - 瞬き（明転）: 閉じた状態の巻物が表示される

2. **共通演出：巻物展開**（セクション3.2参照）

**結果**: 作成画面（4.4）がモーダル表示される

---

##### 操作2：本棚をクリック（一覧画面へ）

**トリガー**: 本棚オブジェクトをクリック

**演出フロー**:
1. **ズームイン**
   - 本棚へズーム
   - SE: `sfx_zoom_in_out.wav`

2. **共通演出：瞬き**（セクション3.2参照）

**結果**: 一覧画面（4.5）へ遷移

---

##### 操作3：窓をクリック（夢の氾濫）

**トリガー**: 窓をクリック

**結果**: 夢の氾濫演出（4.10）が開始

---

##### 操作4：鏡をクリック（ログアウト）

**トリガー**: 鏡をクリック

**結果**: 目覚めの儀式（4.11）が開始

---

##### ホバー効果

| オブジェクト | ホバー動作 |
|-------------|-----------|
| 巻物 | 発光 |
| 本棚 | 発光 |
| 窓 | 七色に光りながら楕円が収縮 |
| 鏡 | 黄色く白く光りながら楕円が収縮 |

---

#### 特記事項

**本棚の蔵書画像**:
書斎から見える本棚のクリックオブジェクトは、夢日記の冊数によって変化。JavaScriptで動的に切り替える。

| 冊数 | アセット |
|------|----------|
| 0冊 | `img_bookshelf_empty.png` |
| 少量 | `img_bookshelf_small.png`（上段のみ） |
| 中量 | `img_bookshelf_medium.png`（中段まで） |
| 多量 | `img_bookshelf_large.png`（下段まで） |

**縮小版巻物の状態表示**:
LocalStorageの有無に応じて画像を切り替え。

| LocalStorage | アセット |
|-------------|----------|
| なし | `img_scroll_mini_blank.png`（白紙） |
| あり | `img_scroll_mini_draft.png`（書きかけ） |

**音響**:
- 「書斎の環境音」をループ再生（`sfx_library_ambience.mp3`）
- トップページ以外の共通BGM

---

### 4.4. 夢を編む（作成）【MVP】

#### 概要

巻物スクロールに直接文字を書き込む没入型UI。書斎の背景上にモーダル表示。

---

#### 画面構成

| レイヤー | 要素 | 説明 |
|---------|------|------|
| 背景 | 書斎背景（ぼかし） | 書斎画面の減光・ぼかし状態 |
| 前景 | 巻物 | 縦スクロール。上端（画像）＋入力エリア＋下端（画像）。`img_scroll_top_bottom.png` |
| 前景 | 羽ペンカーソル | 入力中のカーソル（`cursor_quill.png`） |
| 前景 | インク瓶（4色） | 感情彩色選択UI（`img_ink_bottle_*.png`） |
| 前景 | 銀の栞 | 保存ボタン（`icon_bookmark_silver.png`） |

---

#### 入力フィールド

| フィールド | 必須 | 型 | 制約 | 初期値 | 備考 |
|-----------|------|-----|------|--------|------|
| タイトル | ○ | string | 最大15文字 | なし | リアルタイム文字数表示 |
| 夢を見た日 | ○ | date | - | 現在日付 | 日付選択 |
| 本文 | ○ | text | 最大10,000文字 | LocalStorageから | リアルタイム文字数表示 |
| 感情彩色 | ○ | enum | peace/chaos/fear/elation | なし | 4色のインク瓶から選択 |
| タグ（登場人物） | - | array | - | なし | サジェスト/オートコンプリート |
| タグ（場所） | - | array | - | なし | サジェスト/オートコンプリート |
| 明晰夢チェック | - | boolean | - | false | 「これは夢だと気づいていたか」【将来拡張：データ構造のみ確保、UI未実装】 |

---

#### 操作フロー

##### 操作1：作成開始（書斎から）

**前提**: セクション4.3の操作1で実行済み

**結果**:
- `scratch_memo` があれば構造化して全フィールドを初期化
  - `content`: トップページからの値を継承
  - `title`, `emotion_color`: null（未入力）
  - `dreamed_at`: 現在日付（デフォルト）
  - `tags`: 空配列
  - `lucid_dream_flag`: false（デフォルト）
- `scratch_memo` がなければ空白で開始
- タイムスタンプ比較: DBより新しければ復元を提案

---

##### 操作2：テキスト入力

**トリガー**: 入力エリアにフォーカス

**演出**:
- 羽ペンカーソルに変化（`cursor_quill.png`）
- 「羽ペンの筆記音」ループ再生（フォーカス中のみ）
- SE: `sfx_quill_write.wav`

---

##### 操作3：感情彩色の選択

**トリガー**: インク瓶をクリック

**演出フロー**:
1. **インクの滴り音**（即時）
   - SE: `sfx_ink_drip.wav`

2. **巻物の紙色変更**（即時）
   - 選択した感情彩色に応じて巻物の背景色が変化

**結果**: 感情彩色が選択状態になる

---

##### 操作4：タグ入力

**UI**: 巻物の入力エリア直下に「登場人物」「場所」の入力フィールド

**機能**:
- 過去のタグからサジェスト/オートコンプリート
- 追加されたタグは「×」ボタン付きバッジで表示
- 「×」クリックでタグ削除

---

##### 操作5：保存（銀の栞をクリック）

**トリガー**: 銀の栞をクリック

**演出フロー**:

1. **栞の発光**（即時）
   - 栞が一瞬発光
   - SE: なし

2. **共通演出：巻物収束**（セクション3.2参照）

3. **共通演出：瞬き**（セクション3.2参照）
   - 瞬き（暗転中）: 巻物が非表示、縮小版巻物が再表示される
   - 瞬き（明転）: 半開き本が表示されている状態に

4. **共通演出：本の実体化**（瞬き明け後、即時）
   - 半開き（`img_book_half_open_*.png`） → 閉じる（`img_book_closed_*.png`）
   - SE: `sfx_book_close_heavy.wav`

5. **本の飛翔**
   - 本が本棚へ飛翔
   - SE: `sfx_book_vanish.wav`

6. **書斎復帰**（即時）
   - モーダル閉じ、書斎画面復帰
   - 本棚の蔵書画像が更新（JavaScriptで動的切替）

**結果**:
- 夢日記がDBに保存される
- LocalStorageの`scratch_memo`が削除される
- 書斎画面（4.3）に戻る

---

##### 操作6：画面外クリック（保存せずに閉じる）

**トリガー**: 巻物の外側（画面外）をクリック

**演出フロー**:

1. **共通演出：巻物収束**（セクション3.2参照）

2. **共通演出：瞬き**（セクション3.2参照）
   - 瞬き（暗転中）: 縮小版巻物が再表示される
   - 瞬き（明転）: 書斎画面が表示される

**結果**:
- 書斎画面（4.3）に戻る
- LocalStorageの`scratch_memo`は保持される（再度開くと前の入力状態を保っている）

---

##### 保存失敗時

セクション3.4「保存失敗時の救済処理」参照

---

#### データ要件

**LocalStorage**:
- キー: `scratch_memo`（トップページと共有）
- 構造（作成画面で拡張後）:
  ```json
  {
    "title": "タイトル",
    "dreamed_at": "2024-01-01",
    "content": "本文",
    "emotion_color": "peace",
    "tags": [
      {"name": "太郎", "yomi": "たろう", "category": "person"},
      {"name": "公園", "yomi": "こうえん", "category": "place"}
    ],
    "lucid_dream_flag": false,
    "timestamp": 1234567890
  }
  ```
- 使用タイミング:
  - 作成画面を開く際、トップページからの値を継承して拡張
  - 入力ごとに自動保存
- 削除タイミング: DB保存成功時

**扱うデータ**:
- Dream（夢日記）: タイトル、本文、日付、感情彩色、明晰夢フラグ
- Tag（タグ）: 名前、カテゴリ（登場人物/場所）、読みがな

---

#### 特記事項

- **巻物の実装**: 上下固定フレーム（画像）+ 中間部はHTML・CSSベース
- **紙の質感**: CSSで表現（画像不要、軽量化）
- **背景色**: 感情彩色に応じて動的変更

---

### 4.5. 記憶の目録（一覧）【MVP】

#### 概要

本棚に背表紙が並ぶ形式で、日付順（降順）固定表示。

---

#### 画面構成

| レイヤー | 要素 | 説明 |
|---------|------|------|
| 背景 | 壁面アップ | 本棚が置かれている壁面（`bg_library_wall_up.png`） |
| 中景 | 本棚本体 | 空の棚（`img_bookshelf_empty.png`） |
| 前景 | 背表紙 | 感情彩色に応じた背表紙画像（`img_book_spine_*.png`） |
| 前景 | タイトル | 背表紙上に縦書きで表示（ホバー/1タップで浮遊表示） |
| 前景（端） | 真鍮製銘板 | 「一号館」「二号館」等（ページネーション現在地表示） |
| 前景（脇） | 索引箱 | 検索機能へのアクセス（`img_index_box_exterior.png`） |
| 前景（左上） | 戻るボタン | 書斎へ戻る（`icon_back.png`） |

---

#### 操作フロー

##### 操作1：一覧表示（書斎から）

**前提**: セクション4.3の操作2で実行済み

**結果**:
- 夢日記が日付順（降順）で表示される
- ページネーション付き

---

##### 操作2：背表紙ホバー/1タップ（タイトル表示）

**トリガー**: 背表紙にホバー（PC）/ 1タップ（モバイル）

**演出**:
- タイトルが浮遊表示される

**結果**: タイトル表示状態

---

##### 操作3：背表紙クリック/2タップ（詳細へ）

**トリガー**: 背表紙をクリック（PC）/ 2タップ（モバイル）

**演出フロー**:
1. **共通演出：瞬き**（セクション3.2参照）
   - 瞬き（暗転中）: クリックされた本の背表紙を非表示に

2. **背景のぼかし**（即時）
   - 一覧画面が背景として減光・ぼかし

3. **本が開くアニメーション**
   - 閉（`img_book_closed_*.png`） → 半開き（`img_book_half_open_*.png`） → 見開き（`img_book_open_frame_*.png`）
   - SE: `sfx_page_turn.wav`

**結果**: 詳細画面（4.6）がモーダル表示される

---

##### 操作4：ページネーション（左右端クリック）

**トリガー**: 画面左右端をクリック

**演出フロー**:
1. **共通演出：瞬き**（ラグ隠蔽）

2. **共通演出：画面スライド**（セクション3.2参照）

**結果**: 隣の本棚ページへ移動

---

##### 操作5：索引箱をクリック（検索へ）

**トリガー**: 索引箱をクリック

**演出フロー**:
1. **索引箱の開閉音**（即時）
   - SE: `sfx_index_box_open_close.wav`

2. **共通演出：瞬き**（セクション3.2参照）

**結果**: 検索画面（4.9）がモーダル表示される

---

##### 操作6：戻るボタン（書斎へ）

**トリガー**: 左上の戻るボタンをクリック

**演出フロー**:
1. **ズームアウト**
   - 本棚からズームアウト
   - SE: `sfx_zoom_in_out.wav`

2. **共通演出：瞬き**（セクション3.2参照）

**結果**: 書斎画面（4.3）へ戻る

---

#### 特記事項

**コールドスタート対策**: 0件時は「先代の主の手記」チュートリアル本を配置

**背表紙の感情彩色**: JavaScriptで emotion_color に応じて画像ファイルを動的に切り替え
- `img_book_spine_peace.png`
- `img_book_spine_chaos.png`
- `img_book_spine_fear.png`
- `img_book_spine_elation.png`

---

### 4.6. 記憶の断片（詳細）【MVP】

#### 概要

見開きの本としてモーダル表示。ページめくり機能付き。

---

#### 画面構成

| レイヤー | 要素 | 説明 |
|---------|------|------|
| 背景 | 一覧画面（ぼかし） | 一覧画面が減光・ぼかし状態 |
| 前景 | 見開き本フレーム | 感情彩色に応じた画像（`img_book_open_frame_*.png`） |
| 前景 | ページ内容 | 左右ページ。CSSで描画 |
| 前景（上方） | 編集トリガー | 羽ペンとペーパーナイフ（`icon_edit_quill_knife.png`） |
| 前景（上方） | 削除トリガー | アンティークな砂時計（`icon_hourglass_antique.png`） |
| 前景（下部） | ページ番号 | 各ページに「1/10」形式で表示 |

---

#### 操作フロー

##### 操作1：詳細表示（一覧から）

**前提**: セクション4.5の操作3で実行済み

**結果**:
- 見開き本が表示される
- 最初の見開き（1-2ページ）が表示される

---

##### 操作2：ページめくり

**トリガー**: 左右ページをクリック

**演出フロー**:
1. **ページ回転アニメーション**
   - 3D回転演出
   - SE: `sfx_page_turn.wav`

**結果**: 次/前のページへ移動

---

##### 操作3：本を閉じる（一覧へ戻る）

**トリガー**: 本の外側をクリック

**演出フロー**:
1. **本が閉じるアニメーション**
   - 見開き（`img_book_open_frame_*.png`） → 半開き（`img_book_half_open_*.png`） → 閉（`img_book_closed_*.png`）
   - SE: `sfx_book_close_heavy.wav`

2. **背表紙の再表示**（モーダル閉じた後、即時）
   - フェードインで背表紙が再表示される

**結果**:
- モーダル閉じ
- 一覧画面（4.5）に戻る
- 瞬き演出なし

---

##### 操作4：編集トリガー（編集画面へ）

**トリガー**: 羽ペンとナイフをクリック

**演出フロー**:
1. **本が閉じるアニメーション**
   - 見開き（`img_book_open_frame_*.png`） → 半開き（`img_book_half_open_*.png`） → 閉（`img_book_closed_*.png`）
   - SE: `sfx_book_close_heavy.wav`

2. **共通演出：瞬き**（セクション3.2参照）

3. **共通演出：巻物展開**（セクション3.2参照）

**結果**: 編集画面（4.7）がモーダル表示される

---

##### 操作5：削除トリガー（忘却の儀式へ）

**トリガー**: 砂時計をクリック

**結果**: 忘却の儀式（4.8）が開始

---

#### 特記事項

**見開き本の実装方針**:
- 見開きフレーム背景（画像）の上に、HTML/CSSベースのコンテンツを重ねる構成
- ページ形状と綴じ目の影をCSSで描画
- 背景色: 固定の羊皮紙色（感情彩色は背表紙のみ）
- めくり演出: CSS 3D変換を使用
- ページ分割: JavaScriptで処理

**この方針の利点**:
- テキストのコピー・検索が可能
- 3D演出に対応
- 画像制作不要で軽量

---

### 4.7. 夢を編む（編集）【標準】

#### 概要

既存の夢日記を編集する。巻物スクロールに直接文字を書き込む没入型UI。一覧画面の背景上にモーダル表示。

---

#### 画面構成

セクション4.4（作成）と同様。背景が「一覧画面（ぼかし）」になる点のみ異なる。

---

#### 入力フィールド

セクション4.4（作成）と同様。ただし、初期値は**DBの保存データ**。LocalStorageは参照しない。

---

#### 操作フロー

##### 操作1：編集開始（詳細から）

**前提**: セクション4.6の操作4で実行済み

**結果**:
- DBの保存データが初期値としてロード
- LocalStorageは参照しない

---

##### 操作2〜4：テキスト入力、感情彩色の選択、タグ入力

セクション4.4（作成）と同様

---

##### 操作5：保存（銀の栞をクリック）

**トリガー**: 銀の栞をクリック

**演出フロー**:

1. **栞の発光**（即時）
   - 栞が一瞬発光
   - SE: なし

2. **共通演出：巻物収束**（セクション3.2参照）

3. **共通演出：瞬き**（セクション3.2参照）

4. **共通演出：本の実体化**（暗転中）
   - 暗闇から本が実体化（半開き → 閉じる）
   - SE: `sfx_book_close_heavy.wav`
   - 実体化した本は暗闇に溶け込むように消える

5. **一覧画面へ遷移**（瞬き明け）
   - モーダル削除
   - 一覧画面（4.5）に戻る

6. **背表紙の再表示**（モーダル閉じた後、即時）
   - フェードインで背表紙が再表示される

7. **背表紙の光**（再表示後、即時）
   - 編集した本の背表紙が「キラリ」と光る
   - SE: `sfx_highlight.wav`

**結果**:
- 夢日記がDBに更新される
- 一覧画面（4.5）に戻る

---

##### 操作6：画面外クリック（保存せずに閉じる）

**トリガー**: 巻物の外側（画面外）をクリック

**演出フロー**:

1. **共通演出：巻物収束**（セクション3.2参照）

2. **共通演出：瞬き**（セクション3.2参照）

3. **本が開くアニメーション**（瞬き明け後）
   - 閉（`img_book_closed_*.png`） → 半開き（`img_book_half_open_*.png`） → 見開き（`img_book_open_frame_*.png`）
   - SE: `sfx_page_turn.wav`

**結果**:
- 詳細画面（4.6）に戻る
- LocalStorageの`draft_dream_edit_{id}`を削除
- 一覧画面には戻らない

---

##### 保存失敗時

セクション3.4「保存失敗時の救済処理」参照

---

#### データ要件

**LocalStorage**:
- キー: `draft_dream_edit_{id}`（編集対象のIDを含む）
- 構造: セクション4.4の `scratch_memo`（拡張後）と同様
- 使用タイミング:
  - 編集画面を開く際、DBの保存データで初期化
  - 入力ごとに自動保存
- 削除タイミング:
  - DB保存成功時
  - 画面外クリックで閉じる時
  - **保険機能**: 保存失敗時のみデータを保持
- 注意: `scratch_memo` は参照しない（LocalStorageの隔離）

**扱うデータ**: セクション4.4（作成）と同様

---

#### 特記事項

- **作成との違い**: 背景が一覧画面、初期値がDB、保存後の遷移先が一覧
- **LocalStorageの隔離**: 既存の夢を編集する際はLocalStorageを参照しない

---

### 4.8. 忘却の儀式（削除）【標準】

#### 概要

詳細画面から夢日記を削除する。儀式的な演出で削除を表現。

---

#### 操作フロー

##### 操作1：忘却の儀式（詳細から）

**前提**: セクション4.6の操作5（砂時計クリック）で開始

**演出フロー**:

1. **砂時計の逆回転**
   - 砂時計が逆回転する
   - SE: `sfx_hourglass_rotate.wav`

2. **文字の霧散**
   - 文字がインクのように滲み霧散
   - SE: `sfx_ink_dissipate.wav`

3. **本のフェードアウト**
   - 本がフェードアウト
   - SE: なし

4. **一覧画面へ戻る**（即時）
   - モーダル閉じ
   - 一覧画面（4.5）に戻る
   - 本棚に空隙ができる

5. **本のスライド**（数秒後）
   - 隣の本がスライドして隙間を埋める
   - SE: なし

**結果**:
- 夢日記がDBから削除される
- 一覧画面（4.5）に留まる

---

#### 特記事項

- **削除確認**: 砂時計クリック時に確認ダイアログを表示
- **取り消し不可**: 削除は取り消し不可であることを明示

---

### 4.9. 索引を辿る（検索）【標準】

#### 概要

本棚傍の「索引箱」をクリックで起動。「索引箱の開閉音」と瞬き演出を経て引き出しモーダル表示。
タグ選択とキーワード検索のAND検索が可能。

---

#### 画面構成

| レイヤー | 要素 | 説明 |
|---------|------|------|
| 背景 | 一覧画面（ぼかし） | 一覧画面が減光・ぼかし状態 |
| 前景 | 索引箱の内装 | フレーム（`img_index_box_interior.png`） |
| 前景（ヘッダー） | 選択中タグのバッジ | 「×」クリックで選択解除 |
| 前景（ヘッダー） | タグ絞り込み窓 | タグカードの絞り込み |
| 前景（ヘッダー） | タイトル・本文検索窓 | キーワード検索（スペース区切り） |
| 前景（中央） | タグカードリスト | 全タグがカード表示。五十音順（`img_tag_card_base.png`） |
| 前景（右端） | インデックス | 「あ」「か」「さ」…「英」「他」の真鍮製プレート |
| 前景（フッター） | 「抽出」ボタン | 検索実行 |
| 前景（フッター） | 「開架」ボタン | 検索リセット |

---

#### 操作フロー

##### 操作1：検索画面表示（一覧から）

**前提**: セクション4.5の操作5で実行済み

**結果**:
- 索引箱の引き出しが表示される
- 全タグがカード表示される

---

##### 操作2：タグカードをクリック（選択）

**トリガー**: タグカードをクリック

**演出フロー**:
1. **ピン留め**（即時）
   - ピン留めアイコン表示
   - SE: `sfx_pin.wav`

**結果**:
- タグが選択状態になる
- ヘッダーに選択中タグのバッジが表示される

---

##### 操作3：タグバッジの「×」クリック（選択解除）

**トリガー**: タグバッジの「×」をクリック

**結果**: タグの選択が解除される

---

##### 操作4：タグ絞り込み

**トリガー**: タグ絞り込み窓に入力

**機能**:
- 表示名・読みがな両方で検索可能
- リアルタイムでカードリストを絞り込み

---

##### 操作5：五十音ジャンプ

**トリガー**: インデックスをクリック

**結果**: カードリストが該当行までスクロール

---

##### 操作6：タグカードホバー

**トリガー**: タグカードにホバー

**演出**:
- SE: `sfx_tag_card_flip.wav`

---

##### 操作7：タグ削除

**トリガー**: タグカード右下の「破れた紙片」（`img_tag_delete.png`）をクリック

**演出フロー**:
1. **風化アニメーション**
   - タグカードが風化して消滅
   - SE: なし

**結果**:
- タグがDBから削除される（物理削除）
- カードリストから消える

---

##### 操作8：検索実行（「抽出」クリック）

**トリガー**: 「抽出」ボタンをクリック

**演出フロー**:
1. **共通演出：瞬き**（セクション3.2参照）

**結果**:
- 検索結果が一覧画面（4.5）に表示される
- モーダル閉じ

---

##### 操作9：検索リセット（「開架」クリック）

**トリガー**: 「開架」ボタンをクリック

**演出フロー**:
1. **共通演出：瞬き**（セクション3.2参照）

**結果**:
- 全表示に戻る
- 一覧画面（4.5）に戻る
- モーダル閉じ

---

#### データ要件（読みがな）

**Tag モデル**:
- **表示名 (name)**: ユーザー入力文字列
- **読みがな (yomi)**: ひらがな読み（自動生成）
- **五十音インデックス (yomi_index)**: 「あ」〜「他」（自動生成）

---

#### 特記事項

**検索仕様**: タグ選択とキーワード検索のAND検索
- タグ: 複数選択可能（AND検索）
- キーワード: スペース区切りで複数入力可能（AND検索）
- タグ × キーワード: AND検索

**タグ削除**: 物理削除。関連する夢日記からもタグが削除される。

---

### 4.10. 夢の氾濫（特殊演出）【拡張】

#### 概要

書斎の「窓」をクリックで起動。夢日記からランダムな文を抽出し、その場限りの夢の断片を生成。

---

#### 操作フロー

##### 操作1：夢の氾濫開始（書斎から）

**トリガー**: 書斎の窓をクリック

**演出フロー**:

1. **窓の歪み**
   - 窓が歪む
   - SE: `sfx_glass_warp.wav`

2. **文字の流入**
   - 文字が窓から流入（流入中の文字にランダムな感情彩色を表示）
   - 画面中央に「鏡文字」として表示（統一色）
   - SE: なし

**結果**:
- 鏡文字が画面中央に表示される
- ホバー/長押しで正像に反転

---

##### 操作2：文字の反転（ホバー/長押し）

**トリガー**: 鏡文字にホバー（PC）/ 長押し（モバイル）

**演出**:
- 鏡文字が正像に反転

---

##### 操作3：解除

**トリガー**: 背景クリック、または1分放置

**演出フロー**:
1. **文字のフェードアウト**
   - 文字が消える
   - SE: なし

**結果**: 書斎画面（4.3）に戻る

---

#### データ要件

**生成ロジック**:
- 最大10冊の夢日記を抽出
  - 優先順位1: 直近多用タグを含む夢日記を優先
  - 優先順位2: 多用タグがない場合は完全ランダム
- 抽出した夢日記から句点単位で分割
- 5〜8文をランダム結合

**フォールバック**:
- DB不足時はプリセット文章（『遠くで鐘が鳴っている』等）を混入

---

#### 特記事項

**視覚演出**:
- 流入演出: 感情彩色をランダムに付与
- 鏡文字表示: 統一色で表示
- ホバー/長押しで正像に反転

---

### 4.11. 目覚めの儀式（ログアウト）【拡張】

#### 概要

書斎の「鏡」をクリックでログアウト。「夢から覚める」演出を経て、トップページ（現実）へ戻る。

---

#### 操作フロー

##### 操作1：目覚めの儀式（書斎から）

**トリガー**: 書斎の鏡をクリック

**演出フロー**:

1. **鏡の反応**（即時）
   - 鏡が光る（ホバー時の演出継続）

2. **第1の瞬き**
   - 暗転
   - SE: `sfx_blink.wav`、`sfx_boundary_pass.wav`

3. **覚醒の兆候**
   - トップページの森がぼかし状態で表示
   - 霞がかったSE

4. **第2の瞬き**
   - 再度瞬き演出
   - SE: `sfx_blink.wav`

5. **完全な覚醒**（即時）
   - ピントが合ったトップページが表示
   - 操作可能に

**結果**:
- ログアウト処理が実行される
- トップページ（4.1）へ戻る

---

#### 特記事項

- **セッション管理**: ログアウト時にセッションを破棄
- **LocalStorage**: ログアウト後もトップページのLocalStorageは保持

---

## 5. 世界観と用語マッピング

### 5.1. UI名称の置き換え

- 作成 → **夢を編む**
- 一覧 → **記憶の目録**
- 検索 → **索引を辿る**
- 削除 → **忘却する**
- ログイン・サインアップ → **入館手続き**
- ログアウト → **目覚める**

### 5.2. 世界観用語対応表

| 世界観用語 | 実際の機能名 | 関連セクション |
| :--------- | :----------- | :------------- |
| 現実（トップ） | トップページ表示 | 4.1 |
| 殴り書きの紙片 | 一時メモの入力・自動保存 | 4.1 |
| 入館手続き（Auth） | ログイン・サインアップ画面 | 4.2 |
| 静寂の書斎（メイン） | メインハブ画面 | 4.3 |
| 夢を編む | 夢日記の新規作成・編集 | 4.4, 4.7 |
| 定着の儀式 | 保存処理と演出 | 4.4, 4.7 |
| 記憶の目録（一覧） | 一覧表示・検索画面 | 4.5 |
| 記憶の断片（詳細） | 詳細表示画面 | 4.6 |
| 忘却（削除） | 削除機能 | 4.8 |
| 忘却の儀式 | 削除時の演出 | 4.8 |
| 索引を辿る | 検索・絞り込み機能 | 4.9 |
| タグの削除 | タグマスター削除 | 4.9 |
| 夢の氾濫 | 特殊演出 | 4.10 |
| 目覚める | ログアウト処理 | 4.11 |
| 目覚めの儀式 | ログアウト演出 | 4.11 |
| 銀の栞 | 保存ボタンUI | 4.4, 4.7 |
| アンティークな砂時計 | 削除ボタンUI | 4.6, 4.8 |
| 修正用の羽ペンとペーパーナイフ | 編集トリガーUI | 4.6 |
| 破れた紙片 | タグ削除ボタンUI | 4.9 |

### 5.3. タイポグラフィ

- **トップページ（現実）**: 素朴な明朝体
- **それ以外の全画面（夢の世界）**: ビットマップフォント（DotGothic16等）

### 5.4. ビジュアル

生成AIによるPS1風レトロ質感

---

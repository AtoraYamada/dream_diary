# 要件定義書：夢日記帳 (Dream Library) - ver 1.36版

## 1. プロジェクト概要
夢で見た内容を「忘れないうちに記録」し、「自分だけの書斎」に蓄積していくWebアプリ。
Mystのような没入感のある世界観と、PS1時代のレトロな質感を重視し、単なる実用ツールではなく「体験」としての夢日記を提供する。

## 2. ユーザー体験 (UX) フロー
1.  **【現実】** トップページ（森の扉）にアクセス。音声推奨文とミュートボタンを確認。
  - **ブラウザ制限対応:** モダンブラウザの音声自動再生制限をクリアするため、「扉をクリック」する動作を `AudioContext` をレジューム（有効化）するトリガーとして利用する。
2.  **【移行】** 扉をクリック。ズームと瞬きの演出を経て、扉の開く音と共にログイン・サインアップ画面へ。
3.  **【境界】** ログイン前に殴り書きしたメモ（LocalStorage）を保持したままサインアップ/ログイン。
4.  **【夢の中】** 「夢の書斎（マイページ）」へ到達。
5.  **【定着】** 机の上のメモから「夢を編む（作成）」へ。メモがなくても作成可能。
6.  **【目覚め】** ログアウト時、「夢から覚める」演出を経て、トップページ（現実）へ戻る。詳細は `3.4.1. 目覚めの儀式（ログアウト演出）` を参照。

## 3. 機能要件と画面細詳

### 3.1. CRUD対応表
開発の優先順位付けと、データ操作のスコープを定義する。

| 画面名（世界観呼称） | 主要オブジェクト | CRUD | 状態管理の主体 | 備考 |
| :--- | :--- | :---: | :--- | :--- |
| **現実（トップ）** | 殴り書きの紙片 | **C** | LocalStorage | ログイン前の一時保存 |
| **入館手続き（Auth）** | 入館証 | **R** | Session/DB | ログイン・サインアップ |
| **静寂の書斎（メイン）** | 巻物・窓・正面本棚・鏡 | **-** | Session | 各機能へのハブ、特殊演出、鏡でログアウト |
| **夢を編む（作成/編集）** | 巻物 | **C / U** | DB (API) | LocalStorageからデータ継承 |
| **記憶の目録（一覧）** | 正面本棚・背表紙・索引箱 | **R** | DB (API) | 索引（検索・絞り込み）、ページネーション（瞬きロード） |
| **記憶の断片（詳細）** | 見開きの本 | **R / D** | DB (API) | 夢の削除（忘却演出） |

※ **C**: Create, **R**: Read, **U**: Update, **D**: Delete

### 3.2. 現実（トップページ）と殴り書きメモ
トップページは「夢が消える前に捕まえる」切迫感と没入感を優先する。

- **トップページ演出：** 扉クリック時のCSSアニメーション（上下黒幕の瞬き）および音声再生。
- **UI構成と表示トリガー:**
    - **初期状態**: 森の扉の傍らに、小さな「紙片」が落ちている、あるいはアイコンとして浮遊している。
    - **展開時**: 紙片をクリックすると、画面中央に「殴り書きの紙片」がオーバーレイで表示される。背景の森は少し暗転（減光）させ、入力に集中させる。
    - **入力欄**: HTMLの `textarea` を使用。紙片のテクスチャに合わせて、フォントは素朴な明朝体を採用し、枠線は表示せず「紙に直接書いている」感覚を出す。
    - **現実の質感**: 素朴な「紙片」と「鉛筆カーソル/筆記音」を用い、夢の中の豪華な巻物と対比させる。
    - **演出:** **瞬き演出は不要**。理由：現実の世界内での単純な表示/非表示であり、視点移動や世界の境界を越えるものではないため。
- **インタラクションの方針（シームレスな体験）:**
    - **保存ボタンの排除**: 「保存」ボタンは置かない。1文字入力するごとに `LocalStorage` に自動保存。
    - **鉛筆の演出**: 入力フォーカス（Focus）が当たっている間のみ、カーソルが「鉛筆」に変化し、背後で「カリカリ」という鉛筆の筆記音がループ再生される。
    - **紙の伸長挙動**: 伸長はせず、内部スクロール。
    - **閉じるボタン**: 閉じるボタンで明確に閉じる。誤って途中で閉じないように。
- **ライフサイクルと継承ルール（A案：新規作成時まで復元）:**
    - **定義:** トップページで入力される一時的なテキスト。役割は「書きかけのメモ」であり、ログイン後の「夢を編む（新規作成）」の初期値として利用される。
    - **発生と復元:** 未ログイン状態で入力された内容は `LocalStorage` に自動保存される。ユーザーが「新規作成」を行い、DBへの保存（定着）に成功するまでは、トップページで「紙片」を開けば常にその内容が復元・表示される。
    - **継承（新規作成時）:** ログイン後、「夢を編む（新規作成）」画面へ遷移した際、その時点の `LocalStorage` の内容が初期値として自動展開される。
    - **隔離（既存編集時）:** 本棚から既存の夢を選んで「修正」する際は、`LocalStorage` の内容は一切無視される。これにより、新しいメモが過去の記録を汚染することを防ぐ。
    - **消去:** 「新規作成」において、DBへの保存（定着）成功レスポンスを受け取った瞬間に、ブラウザ上の `LocalStorage` は完全に消去される。
        - **メリット:** ユーザーはDB保存前の書きかけメモを失うことがなく、トップページで繰り返し追記・修正できる。
        - **注意点:** 「新規作成」によるDB保存が完了すれば `LocalStorage` の内容は消去され、「新しい夢の種」という一時的な役割を果たす。
- **継承と判定のルール:**
    - **タイムスタンプ管理:** LocalStorageへの保存時、最終入力日時のUnixタイムスタンプを付与する。
    - **最新性の判定:** ログイン後、DBの最終更新日時よりもLocalStorageのタイムスタンプが新しい場合、「書きかけの記憶（未定着の断片）」があると判断し、復元または新規作成への流し込みを優先的に提案する。
- **入力制限:**
  - ブラウザのLocalStorage容量制限および通信エラー時のデータ肥大化を防ぐため、トップページの「殴り書き」には最大2,000文字程度の制限を設ける。
- **感情の排除:**
  - この段階では「感情（安らぎ、恐怖など）」の選択UIは表示しない。あくまで「内容の記録」に特化させ、感情の分類は夢の中の「編む（作成）」フェーズでの儀式として残しておく。

### 3.3. 入館手続き（認証）
現実から夢（書斎）へアクセスするための「手続きの場」。

- **ユーザー管理:** ログイン、サインアップ、ログアウト機能（Devise等を利用）。
- **新規登録後の挙動:** 登録成功後は自動的にログイン状態となり、瞬き演出を経て「静寂の書斎」へ遷移する。
- **ビジュアルコンセプト:** 
    - 前景に、古いバインダーと、その上に少し重なって置かれた **「継続（ログイン）」および「新規（サインアップ）」のカード** が大きく表示される。
        - 「継続（ログイン）」および「新規（サインアップ）」でカードを分ける
        - 継続は古びれた紙、新規は継続より綺麗な新しい紙で視覚的に差別化
    - 背景はこれらを邪魔しない、ぼんやりとしたシルエットで描画する。具体的には、奥へと収束していく廊下の構図に、チェス盤のように少し歪んだ床や、壁に光るシンボルが浮かぶような、シュールで幾何学的な雰囲気を組み合わせ、「夢の中」の不思議な玄関ホールを表現する。
- **切り替えUI（カード差し替え）:**
    - 控えめに重なっている方のカードをクリックすると、「シュッ」という摩擦音と共に、後ろのカードが手前に滑り込んでくるアニメーションで切り替える。
- **遷移演出:** 成功時、共通の瞬き演出（`5.6.2`参照）を経て「静寂の書斎」を表示。
- **認証エラー演出（消えゆく文字）:**
    - 認証失敗時、バインダー上の入力文字が「砂のように崩れ落ちて消える」アニメーションを実行。
    - 儚いエラーメッセージを表示。
    - サウンド：砂が流れる「サラサラ」という音を同期。
- **フォント・アセットのロード管理:**
  - ビットマップフォント（DotGothic16）適用時のガタつきを防ぐため、`font-display: block`（または読み込み完了までのローディング画面）を採用する。
  - ログイン成功時の「瞬き（暗転）」演出中にフォントと主要アセットのプリロードを完了させ、書斎が開いた瞬間に完全に没入できる状態を作る。

### 3.4. 静寂の書斎（メインハブ）
アプリのハブとなる画面。「ポイント＆クリック」形式を採用する。

- **レイアウトと視点構成（正面図）:**
  - **手前（机）:** 「巻物」が置かれ、クリックで『夢を編む（作成）』画面へ遷移。
  - **正面（奥の壁）:** 壁一面の「本棚」。クリックで『記憶の目録（一覧）』へ遷移。
  - **左側（窓）:** 霧に包まれた「窓」。クリックで『夢の氾濫』演出のトリガーとなる。
  - **隅（鏡）:** 部屋の隅にある「鏡」。クリックでログアウト演出（現実への帰還）を開始。
- **オブジェクト割当（ナビゲーション）:**
    - **机：** 夢を編む（作成機能 / 巻物UI）
    - **本棚：** 記憶の目録（一覧機能 / 背表紙UI）
    - **索引箱：** 索引を辿る（フィルタリング機能）
    - **窓：** 夢の氾濫（特殊ギミック）
    - **鏡：** 目覚める（ログアウト処理）
- **実装仕様:**
  - **座標管理:** 背景画像（320x240を基準としたアスペクト比）に対するパーセント指定でクリックエリアを定義し、レスポンシブに対応する。
  - **視覚的示唆:** クリック可能なオブジェクトにマウスオーバーした際、カーソルが専用のアイコン（指や鉛筆）に変化し、微かな発光（CSS Filter: brightness）を伴うフィードバックを行う。

#### 3.4.1. 目覚めの儀式（ログアウト演出）
「夢」から「現実への入口」へ、意識が混濁した状態を経て帰還するプロセスを演出する。(実際の機能名: ログアウト処理)
- **トリガー:** 書斎の隅にある「鏡」をクリックする。
- **演出フロー:**
    1.  **鏡の反応:** クリックすると、鏡の表面が波紋のように一瞬歪む。
    2.  **第1の瞬き（閉眼）:** 通常の「瞬き」演出で画面が暗転する。
    3.  **覚醒の兆候（開眼）:** 目を開くと、トップページの森の画像が **強いぼかし（`filter: blur()`）** がかかった状態で表示される。まだ夢と現の境界が曖昧な状態を表現する。音響は霞がかったようなSEを重ねる。
    4.  **第2の瞬き（再閉眼・開眼）:** 再度、高速な「瞬き」演出が入る。
    5.  **完全な覚醒:** 完全にピントが合った通常のトップページ（森の扉）が表示され、操作可能になる。

### 3.5. 夢を編む（作成・編集）- 機能名: 新規作成・編集
机上の巻物スクロールに直接文字を書き込む没入型UI。

- **UI構造:**
    - カーソルは世界観に合わせた「羽ペン」のデザインを採用。
    - 作成時はページネーションを行わず、際限なく書き込める「縦に長い1ページ（縦スクロール）」の構造とする。
    - 作成した内容はリアルタイムでページに反映される。
- **データ読み込みの優先順位:**
    - **A. 新規作成ルート (New):**
        - `LocalStorage` にデータがある場合：その内容を初期値としてロード。
        - データがない場合：白紙の巻物を表示。
    - **B. 既存編集ルート (Edit):**
        - 常に **DBの保存データ** を最優先でロード。`LocalStorage` は参照しない。
- **編集の厳密な定義:**
    - 「編集」とは、すでにDBに保存され「本（レコード）」となったデータを修正する行為を指す。
    - ログイン前のLocalStorage（殴り書き）の続きを書く行為は、システム上は「新規作成の初期値ロード」と定義し、「編集」とは区別する。
- **入力フィールド仕様:**
    - **夢のタイトル（必須）:**
        - プレースホルダー: 「夢に名を付ける...」
        - 最大15文字制限（背表紙の縦書き表示に対応）
        - リアルタイム文字数表示
    - **夢を見た日（必須）:**
        - 日付選択フィールド（HTMLの `<input type="date">` を使用）
        - **デフォルト値:** 現在の日付（アプリ起動時の日付）
        - ユーザーが過去の日付を遡って記録することも可能（編集時も同様）
    - **夢の本文（必須）:**
        - テキストエリア（縦スクロール対応）
        - 最大10,000文字制限
        - リアルタイム文字数表示
    - **感情彩色（必須）:**
        - 「安らぎ・混沌・恐怖・高揚」の4色から選択
        - 机の片隅に配置された「4色のインク瓶」をクリックして選択
        - 選択時のUI演出：巻物の背景色が対応する色に染まる
        - **デフォルト色:** インク未選択状態では、見開きページの地色を適用
    - **タグ登録（オプション）:**
        - 詳細仕様は `3.5.1. タグ登録機能` を参照
        - 「登場人物」「場所」の2カテゴリで複数登録可能
- **定着の儀式（保存フロー）:** (実際の機能名: 保存処理)
    - 保存ボタン押下前に「感情彩色（安らぎ・混沌・恐怖・高揚）」を選択するプロセスを必須とする。
    - **没入型UI演出:** 机の片隅に置かれた「4色のインク瓶」のうち、いずれかをクリックすることで色が確定し、巻物の背景色がその色に染まる演出を加える。**※新規作成時などインク未選択状態では、見開きページの地色に合わせたデフォルト色が適用される。**
      - **4色のインク瓶ボタン(UI)** **インク瓶（4種共通）**を利用
    - **更新時の演出:** 修正後の保存（Update）では、実装負荷とUXのバランスを考慮し、以下の軽量化された演出を実行する。
        1. 編集画面で保存ボタン（銀の栞）をクリックすると、巻物が収縮する（[巻物の収束音]）。
        2. 共通の「瞬き（暗転）」演出が開始される。
        3. 画面が完全に暗転している間に、暗闇の中から画面中央に「本が実体化する」アニメーション（「本：半分開きかけ」→「本：正面（閉）」）が浮かび上がるように表示され、[重厚な閉本音]が鳴る。
        4. 実体化した本は、そのままスッと暗闇に溶け込むように消える。
        5. 「瞬き」が完了（開眼）すると、直接「一覧画面」（本棚にズームインした状態）が表示される。
            - モーダルで編集画面が開くので、つまり、モーダル削除
        6. 最後に、今編集した本の背表紙が「キラリ」と光り、更新が完了したことを示す。
- **定着させるボタン（UI）** **銀の栞（しおり）**を利用

#### 3.5.1. タグ登録機能
夢日記にメタデータとして「登場人物」と「場所」のタグを付与する。巻物の入力エリアの下に専用のUIを配置する。

- **UI構成:**
    - 巻物の入力エリアの直下に「登場人物」用と「場所」用のタグ入力フィールドをそれぞれ設ける。
    - 各入力フィールドの下には、追加されたタグを「タグバッジ」として表示するエリアを設ける。
- **入力支援:**
    - 各入力フィールドでは、ユーザーが文字を入力し始めると、過去に登録されたタグから関連する候補をリアルタイムで表示するサジェスト/オートコンプリート機能を提供する。
    - 候補を選択することで、手入力を省き、タグを効率的に追加できる。
- **タグバッジの操作:**
    - 追加されたタグは視覚的に「タグバッジ」として表示され、それぞれに削除ボタン（例: 「×」アイコン）を持つ。
    - ユーザーは削除ボタンをクリックすることで、不要なタグを容易に解除できる。

#### 3.5.2. モーダル方式による「夢を編む（作成・定着）」のサイクル
「開く（作成）」と「閉じる（定着）」を対照的なアニメーションとSEで構成し、物理的な手触り感を演出する。モーダル方式を採用することで、実装コストを削減しつつ没入感を維持する。

- **A. 作成開始（展開の儀式）**:
  - **トリガー**: 書斎の机の上にある「巻物オブジェクト」（縮小版、参照：`5.4.2.`）をクリック。
  - **演出**:
    - 「瞬き（暗転）」演出を経て、書斎の背景に `filter: blur(8px) brightness(0.6)` を適用。
    - 画面中央にモーダルとして閉じた巻物が出現し、展開するイメージで表現する。
  - **机上の縮小版巻物の表示制御**:
    - **瞬き中（暗転中）**: 縮小版巻物UI を非表示に。これにより、「机の上の巻物が手に取られた」感覚を演出。
    - **瞬き明け**: 縮小版巻物UIは非表示のまま（モーダル内で拡大版が表示されているため）。
  - **挙動**: 中間エリアの `height` が 0 から伸長（CSSアニメーション）し、巻物が縦に広がる。
    - **アニメーション時間**: **0.6秒**（瞬き終了後 500ms 遅延 + 0.6s の展開アニメーション）
  - **音響**: **[巻物を広げる音]**（シュルルッという摩擦音）を再生。
  - **モーダル構造**:
    - モーダルオーバーレイが書斎全体を覆い、背景をぼかす。
    - 巻物UIはモーダルの中央に配置され、クリアにピントが合った状態で表示される。

- **B. 定着（保存の儀式）** - **段階1（実装済）と段階2（アセット待機中）に分離**:

  **【段階1】栞の発光演出（実装済）**
  - **トリガー**: 作成画面右端の**`銀の栞`**をクリック。
  - **栞の発光色**: **金色**（rgba(255, 215, 0, 0.8)）で一瞬発光する。
    - 理由：銀色だと銀の栞自体の色と被るため、金色を採用。
  - **発光アニメーション時間**: **0.3秒**
  - **発光後の挙動（段階1時点）**:
    - 0.3秒の発光完了と同時に、巻物の中間エリアが縮小（CSS Height 0）。
    - **巻物縮小アニメーション時間**: **0.6秒**で巻物が収納される。
    - **音響**: **[巻物の収束音]**（シュッという収納音）。
    - 巻物の縮小完了と同時に瞬き（暗転）が入る。
  - **机上の縮小版巻物の表示制御**:
    - **瞬き中（暗転中）**: 縮小版巻物UI を非表示のまま（段階2の処理に備える）。
    - **瞬き明け**: 縮小版巻物UI を再表示。これにより、「机の上に巻物が戻された」感覚を演出。
  - **モーダル消滅と書斎への復帰**:
    - 瞬き明け完了後、モーダルが閉じ、書斎のぼかしが解除される。
    - ユーザーは書斎に戻り、机上に縮小版巻物が置かれた状態を認識できる。

  **【段階2】本の実体化アニメーション（アセット待機中・実装準備完了）**
  - ※以下の仕様で実装準備完了。段階1の巻物縮小完了後に実行される。
  - **演出フロー**:
    1. 巻物の縮小完了（0.6秒）
    2. **暗転明け（瞬き演出）** ← 巻物から本への遷移を視覚的に隠蔽【必須】
        - 瞬き中に縮小版巻物UI を再表示。これにより、「机の上に巻物が戻された」感覚を演出。
    3. 本のパラパラ漫画アニメーション開始
  - **実体化**: モーダル内で画面中央に **`本：半分開きかけ`（0.1s〜0.2s）** → **`本：正面（閉）`** の順でパラパラ漫画風に表示。
  - **音響**: **[重厚な閉本音]**（バタン！）を閉じる瞬間に同期。
  - **完了**:
    - 本がモーダル背後の本棚（ぼかされた書斎の奥）へ縮小しながら飛んでいく。
    - モーダルが閉じ、書斎のぼかしが解除される。
    - **本棚の遠景テクスチャが現在の蔵書数に応じた段階（小/中/大）へ更新**される。
    - これにより、個別の座標管理を回避しつつ、「書斎の蔵書が増えた」という全体的な変化をユーザーに実感させる。

### 3.6. 記憶の目録（一覧）- 機能名: 一覧表示・検索
本棚に背表紙が並ぶ形式で、日付順（昇順/降順選択）で固定表示。

- **ページネーション（動的本棚・瞬きロード）:**
    - 記録数に応じて本棚が埋まる。画面の左右端をクリックすることで、隣の本棚へ移動する。
    - **ページング挙動:** 移動トリガーで共通の瞬き演出（`5.6.2`参照）を実行。暗転中に次ページのデータを非同期取得し、開眼時に表示する。これにより、データ読み込みのラグを世界観の一部として隠蔽する。
    - **現在地の視覚化:** 本棚の端に、真鍮製の小さな銘板（ネームプレート）を表示。「一号館」「二号館」のように現在の棚の位置を示す。
- **背表紙の表現:**
    - 日本語の特性を活かし「縦書き」で表示。
    - 通常時はタイトルを隠し、マウスオーバー（Hover）/1タップ目（Mobile）でタイトルが空中に浮遊して表示される。
    - **背表紙の制約:** 縦書きレイアウト維持のため、タイトルは最大15文字程度に制限。
- **フィルタリング:**
    - 検索実行時、本棚から検索結果に合致しない本は非表示にする。
- **コールドスタート対策（初期状態のフォロー）:**
    - 記録が0件の際に配置される「古い日記」は、単なるチュートリアルではなく「この書斎の先代の主（ある夢遊病者の手記）」という設定の物語を記述する。
    - これにより、操作方法の学習と同時に、アプリの世界観へ引き込むフックとする。
    - 記録が0件の際、本棚へ誘導するエフェクト、その後机の上の巻物を発光させる等で、**「ここから書き始める」という最初のアクション**を直感的に促す。

### 3.7. 記憶の断片（詳細）と忘却（削除）
- **モーダル方式による表示:**
    - **開く時の演出:**
      - 一覧画面（本棚）から背表紙をクリックすると、**瞬き（暗転）中に**、モーダル展開。
      - 瞬き明け後、背景（本棚）は `backdrop-filter: blur(12px)` と `rgba(0, 0, 0, 0.3)` の軽い暗転でぼかされ、本：正面（閉）のみにピントが合った状態となる。
      - 瞬き明け完了後、以下の順で画像を高速切り替え（パラパラ漫画風）して「本が開く」動きを表現する:
        1. **`本：正面（閉）`**（0.1s）
        2. **`本：半分開きかけ`**（0.1s）
        3. **`本：見開きフレーム`**（最終状態）
      - **音響**: **[ページをめくる音]**を再生。
    - **閉じる時の演出:**
      - 背景のぼかしが解除され、本棚（一覧）に戻る。
      - **瞬き演出は不要**。理由：視点移動がなく、単なる「画面表示の切り替え」のため、背景状態の変化のみで充分。
      - **音響**: **[重厚な閉本音]**
- **UI構造（見開き）:**
    - 本を見開いた状態でモーダル内に表示。
    - ページ遷移は複雑な3Dアニメーションではなく、JSやCSSを用いて簡易的な3D挙動とする。
- **忘却の儀式（削除演出）:** (実際の機能名: 削除処理)
    - **演出フェーズ**:
        1. 砂時計が「カチッ」という音と共に逆回転を始める。
        2. テキストエリアの文字がインクのように滲み、上に向かって霧散する。
        3. 本が開いた状態のまま、薄くなって消えていく（opacity フェードアウト 500ms）「夢日記の削除感を演出」。
        3. モーダルが閉じて本棚（一覧）へ戻る。
- **忘却後の物理的演出:**
  - 「忘却」実行後、モーダルが閉じると、本棚上で本が霧散した場所は一時的に「空隙（空白）」として残る。
  - 数秒の余韻の後、隣接する本がスッとスライドして隙間を埋めるアニメーションを挟むことで、「記憶が整理された」感覚を強調する。
  - **実装ルール:** この演出はフロントエンド上のDOM操作のみで行い、DBとの整合性は演出完了後の非同期通信、または次回のページ読み込み時に反映させる。
- **忘却ボタン（UI）** **アンティークな砂時計**を利用
- **記憶の修正（編集）トリガー:**
  - **UI:** 「修正用の羽ペンとペーパーナイフ」が結合した1つのオブジェクトを配置。
  - **配置:** 詳細画面の右下隅に配置された「アンティークな砂時計（忘却ボタン）」の上方に並べて配置する。
  - **役割:** クリックすることで、詳細モーダルから編集モーダル（夢を編む）へ切り替える。

### 3.8. 索引を辿る（検索）- 機能名: タグ・キーワード検索
本棚の傍にある「索引箱」は、記憶を探すための多角的な機能を提供する。クリックで起動すると、古い図書館のカードボックスのような引き出しが開き、その内部がモーダルとして表示される。この際、索引箱の開いた引き出し自体が、モーダルウィンドウ内のフレームとなる。

#### 3.8.1. UI構造（引き出しの内部）
引き出しの内部は、上部の「ヘッダー」、中央の「カードリスト」、右端の「インデックス」、下部の「フッター」の4領域で構成される。

- **ヘッダー領域:**
    - **選択中の索引エリア:** 選択されたタグが「タグバッジ」として一覧表示される。スクロールやフィルタリングを行っても、このエリアは常に表示され、現在の選択状況を把握できる。
        - **タグバッジ:** 選択したタグ名が表示される。右端に「×」ボタンがあり、クリックすることでそのタグの選択を解除できる。
    - **検索窓エリア:** 2種類の検索窓が配置される。
        1.  **タグ絞り込み窓:** `「タグを絞り込む...」`というプレースホルダーを持つ。入力すると、下のカードリストがリアルタイムで絞り込まれる。
        2.  **本文検索窓:** `「記憶の本文を探索...」`というプレースホルダーを持つ。夢日記の本文を対象としたキーワードを入力する。

- **カードリスト領域:**
    - ユーザーが作成したすべてのタグが「タグカード」として、少しずつ重なりながら並んで表示される。
    - 大量のタグがある場合は垂直方向にスクロール可能。

- **インデックス領域:**
    - 引き出しの右端に「あ」「か」「さ」…「英」「他」と刻印された真鍮製の「五十音インデックスプレート」が縦に並ぶ。

- **フッター領域:**
    - **抽出ボタン:** 選択したタグと入力したキーワードで、記憶（夢日記）を検索する。
    - **開架ボタン:** すべての検索条件と選択状態をリセットする。
    - **UI:** ボタンはビットマップフォント（DotGothic16）を用いたテキストラベルとして表示する。

#### 3.8.2. 検索の操作フロー（AND検索）
1.  **索引箱を開く:** 本棚の「索引箱」をクリックすると、[索引箱の開閉音]と「瞬き」演出を経て、引き出しの内部が表示される。
2.  **検索条件の指定:** ユーザーは以下の操作を順不同で行える。
    - **タグの選択:** カードリストから任意のタグカードをクリックする。
        - クリックされたカードは「選択状態」となり、右上に「ピン留め」のようなアイコンが表示される。
        - 同時に、ヘッダーの「選択中の索引エリア」に、対応するタグバッジが追加される。
        - カードのクリックは選択専用とし、再度クリックしても選択は解除されない。
    - **キーワードの入力:** ヘッダーの「本文検索窓」に、本文から探したいキーワードをスペース区切りで入力する。
3.  **検索実行:** フッターの`[ 抽出 ]`ボタンをクリックする。
    - **演出:** **瞬き（暗転）中に**、索引箱が自動で閉じ、本棚のビューが更新される。
    - **理由:** 本棚の表示内容が「全表示」から「フィルタ済み」に変わるため、瞬きで視覚的な切り替えを隠蔽する。
4.  **結果表示:** 瞬き明け後、本棚に戻る。
    - 指定した**全てのタグ**を含み、**かつ**、本文中に指定した**全てのキーワード**が存在する夢日記のみが本棚に表示される（フィルタリング演出）。
    - 検索実行中は、本棚のページネーションは一時的に無効化される。

#### 3.8.3. 補助機能
- **タグの選択解除:** ヘッダーの「選択中の索引エリア」に表示されたタグバッジの「×」ボタンをクリックする。対応するタグカードのピン留めアイコンも消え、選択が解除される。
- **検索のリセット:** フッターの`[ 開架 ]`ボタンをクリックする。
    - **演出:** **瞬き（暗転）中に**、索引箱が自動で閉じ、本棚のビューが全表示状態にリセットされる。
    - **理由:** 本棚の表示内容が「フィルタ済み」から「全表示」に変わるため、瞬きで視覚的な切り替えを隠蔽する。また、「抽出」ボタンと同じボタン形式のため、動作を統一してUI一貫性を確保する。
    - 全ての検索窓の入力内容と、選択されていた全てのタグがリセットされ、初期状態に戻る。
- **タグカードの絞り込み:**
    - ヘッダーの「タグ絞り込み窓」に文字を入力すると、カードリストがリアルタイムでフィルタリングされる。
    - この絞り込みは、タグの**「表示名（漢字等）」と「読みがな（ひらがな）」の両方を対象**とする。これにより、「東京」と「とうきょう」のどちらでも検索可能。
- **五十音インデックスによるジャンプ:**
    - 右端のインデックスプレート（例: 「さ」）をクリックすると、カードリストがアニメーション付きでスクロールし、「さ」行の最初のタグがリストの先頭に来るようにジャンプする。
    - この機能は表示上のショートカットであり、タグの絞り込み状態には影響しない。
- **タグの削除:**
    - 各タグカードの右下隅に、画像アセットで表現された「破れた紙片」アイコンを配置します。このアイコンは、タグをシステムから完全に削除するためのトリガーとなります。
    - アイコンをクリックすると、対象のタグカードは「風化する紙片」アニメーション（crumble-and-fade）を伴いながら消滅します。
    - タグが削除されると、そのタグは全ての夢日記から自動的に解除され、索引箱からも表示されなくなります。これにより、不要なタグが蓄積されることを防ぎ、タグリストの健全性を保つことができます。

#### 3.8.4. データ要件（読みがな）
- 五十音インデックスと、表示名・読みがな両対応のタグ絞り込み機能を実現するため、各タグは以下のデータを持つ。
    - **表示名 (name):** ユーザーが入力したタグの文字列（例: `古びた洋館`）。
    - **読みがな (yomi):** 表示名のひらがなの読み（例: `ふるびたようかん`）。新規タグ作成時、バックエンド（Ruby on Rails）で自動生成して設定される。自動生成されなかった場合や、自動生成が不適切な場合は「他」に分類される。

### 3.9. 夢の氾濫（特殊演出）
- **トリガー:** 書斎の「窓」をクリック。
- **生成ロジック:**
    - ランダムにピックアップした最大10冊の夢日記から文章を句点（。！？）単位で分割し、ランダムに **5〜8文** を繋ぎ合わせ、支離滅裂ながらも文単位で意味を保持した「断片」を生成する。
    - **優先抽出:** ユーザーが直近で多用しているタグを含む文を優先的に混ぜ込み、自身の内面が投影される感覚を演出する。
- **データ不足時のフォールバック（忘却の残滓）:**
    - DB内の文章が不足している場合、システム側で用意した「意味深で断片的なプリセット文章（例：『遠くで鐘が鳴っている』『鍵は開いたままだ』等）」をランダムに混ぜて生成する。
    - これにより、記録を始めたばかりのユーザーでも「自分のものではない記憶が混濁している」という不気味な没入感を損なわないようにする。
- **視覚演出（パプリカ風）:** 
    - 窓の外が歪み、日記の感情彩色（色）がついた文字が液体のように窓から流れ込む。
    - 画面中央に **「窓ガラスに浮かぶ光の鏡文字」** として断片を表示する。
    - **注視演出:** ユーザーが鏡文字にマウスホバー（モバイルでは長押し）している間のみ、文字が反転して「正像」となり、同時に窓の縁の光が強く波打つ。
- **制約と解除条件:**
  - 演出中は他のオブジェクトへのインタラクションを制限する。
  - **解除:** **「窓ガラスに浮かぶ光の鏡文字」の外側（背景の書斎領域）をクリック**するか、一定時間（例：1分間）放置すると自動で解除され、霧が晴れるように自動的に通常の書斎へ復帰する。
- **実装上の注意:**
    - **負荷軽減:** テキストの断片化・結合処理はサーバーサイド（Rails側）で実行し、APIで取得する。
    - **Z-index:** 鏡文字 > 解除用透明レイヤー > UIオブジェクト > 背景 の階層構造で誤操作を防ぐ。

### 3.10. 横断的要件
- **夢の断片のメタデータ:**
    - **索引（タグ付け）：** 「登場人物」「場所」の2軸でタグを付与。
    - **覚醒度判定（明晰夢チェック）：** 保存時に「これは夢だと気づいていたか」を記録。**※現在は本機能の実装スコープ外。データベーススキーマには保持するが、UI・検索機能には含めない（将来の拡張機能として実装予定）。**
    - **感情彩色：** 夢の雰囲気を「安らぎ・混沌・恐怖・高揚」から選択。背表紙の色に反映させ、後から修正（変更）可能。
- **モバイル・レスポンシブ仕様:**
    - `LocalStorage` に依存する「殴り書きメモ」は端末固有であり、同期されない。
    - **操作最適化:** マウスオーバーは2段階タップ（1.選択&タイトル表示、2.詳細へ遷移）で実現します。
        - **1タップ目:** 本を選択状態にし、空中にタイトルを浮遊表示させる。
        - **2タップ目（選択中を再度タップ）:** 本を開き、詳細画面へ遷移する。
        - ※選択状態の本以外をタップした場合は、選択が解除される。
    - **スクロール挙動の保護:** `overscroll-behavior-y: contain;` で「引っ張り更新」を無効化。
    - **画面の向き:** 一覧/詳細は横持ち推奨。作成/編集は縦持ちに最適化。
    - **キーボード表示対策:** `window.visualViewport` APIで表示領域をリアルタイム調整。
- **保存失敗（例外）時の演出:**
    - **待機演出:** 通信中は本が空中で震え、成功で本棚に収まる。
    - **状態の維持:** 失敗時、LocalStorageのデータは削除せず保持。
    - **セッション切れ救済:** 入力中の内容をLocalStorageの**専用避難領域（`lost_dream_fragment`）**へ緊急退避させ、再ログイン後に復元導線を提示。
        - これにより、通常の「殴り書き（`scratch_pad`）」データと混同することなく、再ログイン後に「拾い上げ（復元）」の導線を提示できる。
    - **フィードバック:** PS1風ノイズと共に「記憶が定着しません。霧が深すぎます。」等のメッセージを表示。
    - **最終救済:** 通信エラーが続く場合、「記憶を写し取る（クリップボードへコピー）」ボタンを表示。
- **ナビゲーション制御（ブラウザバック対応）:**
    - **仮想履歴:** `history.pushState` を活用し、UIの展開（ズーム等）を履歴にスタックする。
    - **逆再生演出:** `popstate` イベント検知時、ズームアウト等の逆再生アニメーションを実行する。
    - **境界の警告演出:** ブラウザの戻る操作やタブを閉じようとした際、PS1風ノイズと警告メッセージ「未定着の記憶が霧に消えます。現実に戻りますか？」を表示する。

## 4. デザイン・アセットガイドライン
### 4.1. 世界観の統一
- **UI名称の置き換え:**
    - 作成 → **「夢を編む」**
    - 一覧 → **「記憶の目録」**
    - 検索 → **「索引を辿る」**
    - 削除 → **「忘却する」**
    - ログイン・サインアップ → **「入館手続き」**
    - ログアウト → **「目覚める」**
- **タイポグラフィの使い分け:**
    - **夢の中（書斎・巻物・本）:** PS1時代のレトロ感を再現するため、ビットマップフォント（例：DotGothic16等）をWebフォントとして採用。
    - **現実（トップページ）:** より素朴な明朝体を使用。
- **ビジュアル・演出:**
    - 生成AIによるレトロな質感（PS1風）。
    - ログアウト時は、トップページの森の画像をぼかして表示することで、夢から覚める途中の曖昧な意識を表現する。

#### 4.1.1 世界観用語マッピング
| 世界観用語 | 実際の機能名（または説明） | 関連セクション |
| :--------- | :----------------------------- | :--------------- |
| **現実（トップ）** | アプリケーションのトップページ表示 | 3.2 |
| **殴り書きの紙片** | 未ログイン時の一時メモの入力と自動保存機能 | 3.2 |
| **入館手続き（Auth）** | ユーザー認証（ログイン・サインアップ）画面 | 3.3 |
| **静寂の書斎（メイン）** | メインハブ画面（各機能へのナビゲーション） | 3.4 |
| **夢を編む** | 夢日記の新規作成・編集画面 | 3.5 |
| **定着の儀式** | 夢日記の保存処理と演出 | 3.5 |
| **記憶の目録（一覧）** | 夢日記の一覧表示・検索画面 | 3.6 |
| **記憶の断片（詳細）** | 夢日記の詳細表示画面 | 3.7 |
| **忘却（削除）** | 夢日記の削除機能 | 3.7 |
| **忘却の儀式** | 夢日記削除時の演出と処理 | 3.7 |
| **索引を辿る** | タグやキーワードによる夢日記の検索・絞り込み機能 | 3.8 |
| **タグの削除** | タグマスターからのタグ削除機能 | 3.8.3 |
| **夢の氾濫** | ランダムな夢の断片を表示する特殊演出 | 3.9 |
| **目覚める** | ログアウト処理 | 3.4.1 |
| **目覚めの儀式** | ログアウト時の演出と処理 | 3.4.1 |
| **銀の栞** | 夢日記の保存ボタンUI | 3.5 |
| **アンティークな砂時計** | 夢日記の削除ボタンUI | 3.7 |
| **修正用の羽ペンとペーパーナイフ** | 夢日記の編集トリガーUI | 3.7 |
| **破れた紙片** | タグの削除ボタンUI | 3.8.3 |

### 4.2. プライバシーとデータポリシー
- **共有機能の排除:** 本アプリは「自分だけの孤独で贅沢な書斎」をコンセプトとするため、他ユーザーへの共有・公開機能は一切持たない。
- **忘却の徹底:** ユーザーが「忘却（削除）」を実行した場合、データはDBから物理的に削除され、復元不可能となる。

### 4.3. アセット（素材）リスト
#### 4.3.1. 画像素材：ベース背景
| 素材名 | 詳細・用途 | 備考 |
| :--- | :--- | :--- | :--- |
| **森の中の古びた扉** | トップページ（現実）用背景。ズームに耐える高解像度。 | 全画面を覆うため透過不要。 |
| **入館手続きの背景** | シュールで幾何学的な、奥に続く廊下のシルエット。ログイン・サインアップ画面用。 | 全画面を覆うため透過不要。 |
| **静寂の書斎（机あり）** | 机・窓・鏡・壁が描き込まれたベース画像。本棚と索引箱の場所のみ空けておく。 | 全画面を覆うため透過不要。 |
| **一覧・詳細用背景（壁アップ）** | 本棚が置かれている場所の「壁面」をアップにした画像。目録（一覧）と断片（詳細）の共通ベース背景として使用。 | 全画面を覆うため透過不要。 |
| **暗い石壁** | 4:3画面の外側の余白（額縁）用。世界観を補強するベース背景。 | 全画面を覆うため透過不要。 |

#### 4.3.2. 形状透過のみ必要な画像素材

##### 4.3.2.1. 形状透過のみ必要な画像素材
| カテゴリ | 素材名 | 詳細・用途 | 備考 |
| :--- | :--- | :--- | :--- |
| **現実（トップ）**| **殴り書きの紙片** | 破れた端、汚れのある素朴な紙。トップページでの入力エリア背景。 | 不規則な形状を背景と合成するため。 |
| | **鉛筆/チャコールのカーソル** | 現実世界での入力中のみ使用する、羽ペンより素朴な筆記具。 | カーソル形状を定義するため。 |
| **本棚ユニット** | **本棚本体** | 空の棚。書斎画面では縮小配置、一覧画面では等倍〜拡大配置して使い回す。ズーム（scale）に耐えるため、高解像度（2k）で作成。 | 本（遠景）の画像を重ねるため。一覧で本の背表紙を並べるため。 |
| | **索引箱の外装** | 本棚の傍に配置。アップ時のフレーム兼用。 | |
| | **タグカード** | 箱の中のカードの形状・質感がある画像。文字はHTMLで載せる。 | カードの形状を出すため。**※複雑な「物理的な破壊表現」を含むアニメーションには、別途素材制作手法の検討が必要。CSSアニメーション（`opacity`, `transform`等）による風化・フェードアウト演出は可能。** |
| | **破れた紙片** | タグの削除ボタン。タグカードの右下済みに配置 |
| | **棚板の影・奥行き** | 本の背面に敷き、棚の立体感を出すための「奥の暗がり」。 | 影の表現のため（半透明）。**※本棚本体に十分な影が組み込まれている場合は、この素材は不要となる可能性があります。** |
| **巻物** | **巻物：上端/下端** | 芯と紙の端。中間はHTML/CSSで描画。机の上に配置。 | 不規則な形状を背景と合成するため。 |
| **本（遠景）** | **蔵書テクスチャ（小/中/大）** | 本棚の埋まり具合（数冊/半分/満杯）を示すオーバーレイ画像。 | 本棚の遠景画像に重ねるため。 |
| **入館手続き（Auth）** | **バインダー** | クリップとボードの質感・形状・色ありの画像。 | 入館証カードを載せる背景とするため。 |
|  | **入館証カード（ログイン）**  | ログイン画面用。カードの厚み、汚れ、手垢の質感を保持。 | |
| | **入館証カード（サインアップ）** | サインアップ画面用。ログイン版と異なる色合い。 | |
| **UI/その他** | **羽ペンのカーソル** | 夢を編む時に使用する筆記具。 | カーソル形状を定義するため。 |
| | **汎用影テクスチャ** | 机の上の巻物やカードの下に敷く、接地感を出すためのぼかした影。 | 影の表現のため（半透明）。 |
| | **操作アイコン/戻る** | ズームアウトや画面を閉じるための、世界観に沿ったボタン。 | |
| | **窓・鏡の歪み・ヒビ** | 「夢の氾濫」演出時に、既存画像の上に重ねる透過ノイズ。 | オーバーレイとして機能するため。 |
| | **アンティークな砂時計** | 忘却（削除）トリガー。詳細画面の隅に配置。クリックで逆回転を開始。 | |
| | **銀の栞（しおり）** | 保存トリガー。シンプルで上品な細身の銀板。月や星の控えめな彫刻。 | |
| | **修正用ツール（羽ペンとナイフ）** | 詳細画面用の編集トリガー。「修正用の羽ペン」と「ペーパーナイフ」が一体となったデザイン。 | |

##### 4.3.2.2. 感情彩色対応アセット（4色版）
感情彩色（peace/chaos/fear/exalt）に対応した画像群です。
JavaScriptで色別の画像ファイルを動的に選択して表示します（`getEmotionImagePath()` 関数参照）。

**巻物（作成UI）**
感情彩色に対応したインク瓶を用意します。

| 感情彩色 | ファイル名 |
|---|---|
| 安らぎ（平穏） | img_ink_bottle_peace.png |
| 混沌 | img_ink_bottle_chaos.png |
| 恐怖 | img_ink_bottle_fear.png |
| 高揚 | img_ink_bottle_exalt.png |

**説明**:
- 瓶のガラス部分にはインクの色が満たされた状態で表現
- 瓶の質感（光反射、ラベル）は4色共通で、インクの色のみが異なります

**本（近景）**
感情彩色に応じて、以下の各アセットを4色版で用意します。

- **背表紙（本棚表示用）**:

| 感情彩色 | ファイル名 |
|---|---|
| 安らぎ（平穏） | img_book_spine_peace.png |
| 混沌 | img_book_spine_chaos.png |
| 恐怖 | img_book_spine_fear.png |
| 高揚 | img_book_spine_exalt.png |

- **本：正面（閉）**:

| 感情彩色 | ファイル名 |
|---|---|
| 安らぎ（平穏） | img_book_closed_peace.png |
| 混沌 | img_book_closed_chaos.png |
| 恐怖 | img_book_closed_fear.png |
| 高揚 | img_book_closed_exalt.png |

- **本：半分開きかけ**:

| 感情彩色 | ファイル名 |
|---|---|
| 安らぎ（平穏） | img_book_half_open_peace.png |
| 混沌 | img_book_half_open_chaos.png |
| 恐怖 | img_book_half_open_fear.png |
| 高揚 | img_book_half_open_exalt.png |

- **本：見開きフレーム**:

| 感情彩色 | ファイル名 |
|---|---|
| 安らぎ（平穏） | img_book_open_frame_peace.png |
| 混沌 | img_book_open_frame_chaos.png |
| 恐怖 | img_book_open_frame_fear.png |
| 高揚 | img_book_open_frame_exalt.png |

### 4.3.3. テクスチャの共通化と構造的差異
世界観の統一と開発効率のため、紙の質感は以下のルールで管理する。

- **共通ベース（羊皮紙の地色）**:
  - `作成用巻物` と `見開き本のページ` は、同一のアンティークな羊皮紙の地色・ノイズ感を採用し、記憶の連続性を表現する。**ここでいう「同一の地色・ノイズ感」とは、感情彩色が適用されていないデフォルト状態におけるベースの質感と色合いを指す。**
- **構造的差異（影の描き込み）**:
  - **巻物**: 垂直方向のわずかな波打ちと、両端の「巻き癖」による影を優先。
  - **見開き本**: 中央の「ノド（綴じ目）」に濃い影を配置し、左右のページが緩やかにカーブしている立体感を強調。
- **質感表現**:
  - 紙の質感は CSS（`repeating-linear-gradient` など）で表現
  - 巻物について、縮小版巻物に書きかけテクスチャを表示する場合、CSS グラデーション（`repeating-linear-gradient`）で表現
  - 詳細は（`dream_diary_asset_list.md 1.2.3, 1.2.5`参照）

#### 4.3.4. 音素材（SE）
- **管理:** トップページに「音声推奨文」と「ミュートボタン」を設置

| カテゴリ | 素材名 | 再生タイミング・演出上の役割 |
| :--- | :--- | :--- |
| **汎用** | 瞬きの音 | [画面転換] 画面暗転演出時の「フッ」という短い音。 |
| | 画面スライド音 | [移動] 本棚移動時などの重く乾いた音。 |
| | 選択・決定音 | [共通] UIボタン押下時。世界観に合う「コッ」という短い木製音。 |
| | 不協和音（グリッチ音） | [保存失敗] 保存失敗時。ザッ…という短い電子ノイズ。世界による「拒絶」を表現。 |
| **現実（トップページ）** | 重厚な扉の開閉音 | [トップ] 森の扉をクリックし、書斎へ移行する瞬間。 |
| | 鉛筆の筆記音 | [トップ] トップページでの入力中（ループ）。羽ペンより少し硬い音。 |
| **入館手続き（Auth）** | 境界を越える音 | [ログイン成功] 暗転から書斎が開ける瞬間の、澄んだチャイムや光の音。 |
| | カードの摩擦音 | [ログイン・サインアップ] カードをスライドさせて入れ替える音。 |
| | 砂の崩落音（さらさら） | [認証失敗] 現実の雑音ではなく、夢の崩壊を感じさせる音。 |
| **静寂の書斎（メインハブ）** | 書斎の環境音 | [常時] メイン画面滞在中（ループ）。時計の秒針、遠くの風、木の軋み。 |
| | ズーム移動音（入/出） | [ズーム] 本棚ユニットや索引箱へ接近・離反する際の空気移動音。 |
| **夢を編む（作成・編集）** | インクの滴り音 | [彩色] 感情選択時、栞が光るのと同期。「ピチャン」という透明感のある音。 |
| | 羽ペンの筆記音 | [入力] テキストエリアへのFocus中（ループ）。「カリカリ」という音。 |
| | 巻物を広げる音 | [作成開始] 巻物UIが表示される際の、乾いた紙が広がる音。 |
| | 巻物の収束音 | [定着] 銀の栞クリック後、巻物がシュルシュルと巻き取られる摩擦音。 |
| | 重厚な閉本音 | [定着/忘却] 「閉じた本」に切り替わる瞬間の「バタン！」という音。 |
| | 吸入・飛翔音 | [定着] 本が本棚の奥へ吸い込まれていく際のスーッという風切り音。 |
|  | キラリという光の音 | [更新完了] 背表紙が光って更新完了を示す際の澄んだ音。 | |
| **記憶の断片（詳細）** | ページをめくる音 | [閲覧] 本のページ画像がスライドする際の紙の音。 |
| | 砂時計の回転音 | [忘却] 砂時計をクリックした際、木とガラスが「カチッ」と擦れる音。 |
| | インクの滲む音 | [忘却] 文字が霧散する際の、液体が吸い込まれるような微細なノイズ。 |
| **索引を辿る（検索）** | ピン留め音 | [索引箱] タグカードをクリックして選択（ピン留め）する際の「トンッ」という短い音。 |
| | 索引箱の開閉音 | [索引箱] 索引箱をクリックした際、引き出しが滑る「ガラッ」という木の音。 |
| | 索引カードをめくる音 | [索引箱] 索引箱の中でタグカードを切り替える際の、厚手の紙が擦れる音。 |
| **夢の氾濫（特殊演出）** | ガラスの歪む音 | [夢の氾濫] 夢の氾濫（窓）開始時の不穏な軋み音。 |

## 5. 技術仕様・非機能要件
### 5.1. 技術スタック・制限
- **開発期間：** 5日間（デプロイ含まず）。
- **Backend:** Ruby on Rails。
- **Frontend:** Vanilla JS / CSS 3D Transforms / LocalStorage。
- **Database:** PostgreSQL。
- **Asset:** 生成AIによる画像・SE素材。

### 5.2. 実装方針（5日間完遂のために）
- **実装方針:** 標準的なCSS（`opacity`, `transform`, `z-index`）とVanilla JSでのDOM操作を優先し、WebGL等の重いライブラリを避ける。
- **優先順位（MVP）:** 1.CRUDとLocalStorage連動、2.書斎ハブのUI、3.各種演出ギミックの順で実装。
- **将来の保守性:** 「巻物（作成）」と「本（閲覧）」はロジック肥大化を防ぐため、コンポーネントを完全に分離する。

### 5.3. 質感の演出（PS1フィルタ）
- **演出の注力ポイント:**
  - 複雑な3D挙動よりも、CSSアニメーションの「イージング」や「SE（効果音）との同期」に注力することで、低コストで高い没入感を実現する。
- **解像度とディザリング:** 全てのアセットを低解像度でレンダリングし、CSSの `image-rendering: pixelated;` を適用してエッジを際立たせる。グラデーションにはディザリング処理を施す。
- **ジッター（不規則な揺れ）演出:** 特定のオブジェクトに微細なCSSアニメーションで不規則な揺れを付与する。
- **ポストプロセスCSS:** 画面全体の統一感を出すため、全コンポーネントに一括適用する。
  ```css
  .retro-shader {
    filter: contrast(1.1) brightness(0.9) sepia(0.1);
    image-rendering: pixelated;
  }
  ```

### 5.4. 実装構造：質感透過ハイブリッド方式
5日間で没入感と動的な演出を両立させるためのアセット・レイヤー構造。

#### 5.4.1. 本棚・索引ユニットの独立構造:**
- **背景レイヤー (Static):** 壁、床、窓、机を描いた静止画。
- **動的コンポーネント (Dynamic):** 空の本棚、記憶の本（背表紙）、索引箱を背景から分離して配置。
- **遠景:** 本の総数に応じて、`蔵書テクスチャ（小/中/大）` をオーバーレイ表示。
- **近景（ズーム時）:** 遠景テクスチャを非表示にし、個別にクリック可能な「動的な背表紙パーツ」を生成・配置する。
    - **構造:** 「背表紙（PNG）」＋「タイトル（HTML縦書き）」。

#### 5.4.2. 巻物コンポーネントの構造:**
- **書斎オブジェクト（静止）**:
    - 作成時の縮小版UI
    - **挙動**: 机の上のクリック対象。LocalStorageにデータがある場合にのみ「書きかけテクスチャ」を重ねる。
    - **白紙状態（メモなし）**: 質感のある真っさらな紙として画像表示。
    - **書きかけ状態（メモあり）**: 上記の白紙状態の上に、「掠れた黒い線」や「インクのシミ」が描かれた書きかけテクスチャをCSSで描画。
- **作成画面UI（動的）**: 上端パーツ（画像）＋ 中間エリア（HTML/CSS可変長）＋ 下端パーツ（画像）の3段構成。

#### 5.4.3. モーダル方式による画面切り替えアニメーションの整合性:**

- **書斎→夢を編む（新規作成/編集）:**
    - **Step 1（書斎）:** 机の上の「巻物オブジェクト」をクリック。
    - **Step 2（移行）:** **「瞬き（暗転）」演出の実行**。
    - **Step 3（モーダル表示）:** 暗転明け、書斎背景に `filter: blur(8px) brightness(0.6)` を適用し、画面中央に巻物モーダルが出現して展開する（音響：巻物を広げる音）。

- **一覧→詳細（モーダル方式）:**
    - **Step 1（一覧）:** 本棚に並ぶ「背表紙」をクリック。
    - **Step 2（移行）:** **「瞬き（暗転）」演出の実行**。
    - **Step 3（モーダル表示）:** 暗転明け、背景（本棚）に `backdrop-filter: blur(12px)` と `rgba(0, 0, 0, 0.3)` を適用。
    - **Step 4（本を開くアニメーション）:** モーダル内で以下の順で画像を高速切り替え（パラパラ漫画風）:
        1. **`本：正面（閉）`**（0.1s）
        2. **`本：半分開きかけ`**（0.1s）
        3. **`本：見開きフレーム`**（最終状態）
    - **音響**: **[ページをめくる音]**を再生。

- **詳細→編集（モーダル切り替え）:**
    - **Step 1（詳細モーダル）:** 右下隅上方に配置された「修正用の羽ペンとペーパーナイフ」の結合オブジェクトをクリック。
    - **Step 2（モーダル切り替え）:** 見開きの本が「パタン」と閉じるアニメーション（音響：重厚な閉本音）で詳細モーダルが閉じる。
    - **Step 3（場面転換）:** 共通の「瞬き（暗転）」演出を実行。
    - **Step 4（編集モーダル表示）:** 暗転明け、巻物モーダルが出現し、縦に伸長して「夢を編む（編集）」画面へ移行する（音響：巻物を広げる音）。

#### 5.4.4. インタラクションレイヤー:**
背景画像内のオブジェクト座標に合わせ、透明なクリッカブルエリアを配置し、演出のトリガーとする。

#### 5.4.5. この構造によるメリット:**
3Dモデルを排除し、静止画の差し替えとCSSのみでリッチな体験を構築。

### 5.5. 画面構成と余白（額縁）の演出
- **4:3 ビューポートの固定:** メイン画面は **4:3（320x240基準）** を維持し、ブラウザ中央に配置。
- **余白（額縁）:** 4:3画面の外側には、「暗い石壁」を配置し、世界観を補強する。
     - **特殊演出時（案B）:「霧の侵食」**。「夢の氾濫」発生時は、余白にもディザリングの効いた「深い霧」やノイズを出現させる。

### 5.6. エンジニア向け詳細ガイド
#### 5.6.1. パラパラ漫画風アニメーション（状態遷移）:**
3D制御を避け、画像を高速切り替えし、SEと同期させる。

#### 5.6.2. 共通演出：瞬き（暗転）タイムライン:** 全ての視点切り替えで共通利用。 
1. **閉眼 (0.3s):** CSSの `transform: scaleY(1)` で黒い幕が上下から中央へ閉じる。
2. **静止/ロード (不定):** 通信が発生する場合、この状態でレスポンスを待機。
3. **開眼 (0.5s):** データの準備が整い次第、`scaleY(0)` へ戻り、黒い幕が中央から上下へ広がり、視界が開ける。

#### 5.6.3. 巻物（作成画面）のモーダル実装詳細:**
- **モーダル構造:**
    - モーダルオーバーレイが書斎全体を覆い、背景に `filter: blur(8px) brightness(0.6)` を適用。
    - 巻物UIはモーダル中央に配置され、クリアにピントが合った状態で表示される。
- **レイアウト:** `display: flex; flex-direction: column;` のコンテナで、中間エリアを `flex-grow: 1;` として可変長にする。これは`上端パーツ` + `可変中間エリア(HTML)` + `下端パーツ`のサンドイッチ構造を形成する。
- **スクロール挙動**:
    - **対象**: ブラウザ全体ではなく、入力欄のいmをスクロールさせる。上端・下端パーツは固定。
- **背景処理**: アンティークな紙色を敷き、紙の質感は CSS（`repeating-linear-gradient` など）で表現。

#### 5.6.4. 感情彩色（動的テーマカラー）のCSS実装:** 選択された感情に応じたCSS変数を定義し、Base Color Layerへ適用する。
```css
:root {
    --color-peace: #d4c5b9;   /* 0: 安らぎ・平穏（ベージュ） */
    --color-chaos: #8b4c4c;   /* 1: 混沌（深紅） */
    --color-fear: #4a5568;    /* 2: 恐怖（紺） */
    --color-exalt: #c9a854;   /* 3: 高揚（金） */
}
```
- **適用範囲:** 作成（編集）中の巻物の背景色、夢の氾濫の文字色に適用。

#### 5.6.5. コンポーネントのスケーリング制御:**
- 高解像度の質感透過PNGを、表示場所に応じてCSSでスケール調整する。
- `image-rendering: pixelated;` を適用し、拡大縮小してもドット絵風のエッジを維持する。
**1. 本のサイズ制御**
- **本棚（一覧画面）**:
    - 背表紙パーツを `width: 20px〜40px` 程度に縮小し、`flex` や `grid` で並べる。
- **詳細表示（見開き）**:
    - 見開きフレームを画面中央に大きく表示（例: `width: 80vw`）。
    - 文字の可読性を優先し、高解像度設定を維持する。

**2. 巻物のサイズ制御**
- **机上の置物（マイページ）**:
    - `position: absolute` で机の上の特定座標に配置。
    - `transform: scale(0.2)` や `width` 指定で、風景に馴染むサイズに縮小する。
    - 遠目に見えるため、ディテールよりも「書きかけ（黒い線）」のテクスチャの有無による状態表現を優先する。

### 5.6.6. 視点切り替え：書斎（メイン）から目録（一覧）への遷移

「本棚本体（PNG）」アセットを共通利用し、背景画像を差し替えることで、低コストかつ没入感のある移動演出を実現する。

- **アセット構成:**
    1. **静寂の書斎（机あり）**: ハブ画面のベース。引きの視点。
    2. **一覧時の背景（壁のアップ）**: 本棚の背後の壁をアップにした画像。詳細画面の背景としても流用。
    3. **本棚本体（PNG）**: 書斎と一覧で使い回す共通オブジェクト（高解像度版）。

- **書斎→目録（一覧）の遷移フロー:**
    - **Step 1（書斎）:** 書斎の奥にある「本棚」をクリック。
    - **Step 2（移行）:** **「瞬き（暗転）」演出の実行**。
    - **Step 3（背景/オブジェクト差し替え）:** 暗転中に以下の処理を非同期で行う。
        1. 背面画像が `静寂の書斎（机あり）` から `一覧時の背景（壁のアップ）` へ変わる。
        2. 共通の `本棚本体（PNG）` を縮小配置から「等倍（あるいは画面いっぱいの拡大）」配置へ変更。
        3. 本棚の上に、クリック可能な「動的な背表紙パーツ（1冊ずつ）」を生成・重畳。
    - **Step 4（開眼）:** 暗転が明け、目の前に本棚がある「記憶の目録（一覧）」が表示される。

- **スケーリング:** 本棚本体は `image-rendering: pixelated;` を指定。これにより、書斎から一覧への「疑似ズーム（暗転中の差し替え）」時に、質感がボケることなくPS1風のレトロな解像度感を維持する。

- **音響との同期:** - 暗転開始と同時に `ズーム移動音（入）` を再生し、物理的な距離の移動を補強する。

- **詳細画面（記憶の断片）のモーダル実装:**
    - `一覧時の背景（壁のアップ）` は詳細画面でもそのまま継続して背景として使用する。
    - 詳細画面では、モーダルとして見開き本を表示し、背景（本棚）に `backdrop-filter: blur(12px)` と `rgba(0, 0, 0, 0.3)` の軽い暗転を適用することで、見開き本のみにピントが合った状態を演出する。
    - **共通背景の活用:** 「一覧」から「詳細」へ移る際、背景アセット（壁アップ）を切り替えずそのまま保持することで、読み込み待ち（白飛び）を防ぎ、シームレスな体験を提供する。
    - **モーダル表示時のアニメーション:** 瞬き演出の後、モーダル内で「本：正面（閉）→半分開きかけ→見開きフレーム」のパラパラ漫画風アニメーションを実行する。

#### 5.6.7. 実装上の盲点と対策（物理的実在感の補強）:**
- **接地感:** `filter: drop-shadow()` や影テクスチャで、机の上のオブジェクトが浮かないようにする。
- **アセット劣化対策:** ズーム対象のパーツは、最終表示サイズの2倍解像度で作成・読み込みを行う。
- **SEの残響管理:** 画面遷移時に不要な音を停止またはフェードアウトさせる処理を徹底する。

#### 5.6.8. チュートリアルデータの取り扱い:**
- **初期配置:** ユーザー作成時、Seedデータで「書斎の使い方」という本を1冊自動生成する。
- **削除制限:** チュートリアル本も通常の夢日記と同様に「砂時計」で忘却（削除）可能とする。

#### 5.6.9. 巻物の伸長とスクロール挙動** 巻物（作成画面）は、上端・中間・下端をひとつの「動的な長いオブジェクト」として扱う。
1. **サンドイッチ構造の連動**:
    - 中間エリア（HTML）の伸長に伴い、下端パーツ（画像）の `top` 座標は自動的に下がる。
    - 上端・中間・下端はすべて同じ親コンテナ内に配置し、ひとつのユニットとして扱う。
2. **スクロールの対象**:
-    中間エリアのみ。上端・下端は固定

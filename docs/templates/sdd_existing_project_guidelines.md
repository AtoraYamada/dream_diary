# 既存プロジェクト参入時のガイドライン

## 概要

既存プロジェクトに途中から参入する際のSDD + TDDワークフロー。
新規プロジェクト向けの `sdd_workflow_guidelines.md` とは別に、既存コードベースがある状況に対応。

**重要**: 仕様書は「実装に必要十分な情報」を含むこと。「決定事項のみ」は失敗した方針。

## 参入時フロー

```
0. sdd_workflow_guidelines.md を読み込む（基本方針の確認）
1. SerenaMCPオンボーディング実施
2. 既存ドキュメントの確認
3. code-explorer でコードベース分析
4. 仕様書の整備（なければ作成）
5. ユーザー承認
6. 通常のワークフローに移行
```

## 各ステップの詳細

### Step 0: 基本方針の確認
- `sdd_workflow_guidelines.md` を読み込む
- 仕様書構造、変更管理ルール、テスト方針を把握

### Step 1: SerenaMCPオンボーディング
- プロジェクト構造の把握
- 技術スタックの確認
- メモリに基本情報を保存

### Step 2: 既存ドキュメントの確認

| 状況 | 対応 |
|------|------|
| 要件定義書あり | 内容を確認、必要なら整理 |
| 仕様書あり | 構造を確認、必要なら再編成 |
| ドキュメントなし | Step 4 で作成 |

### Step 3: code-explorer でコードベース分析
- 既存のアーキテクチャパターン
- ディレクトリ構成
- 主要なモデル/コントローラー/サービス
- テストの有無と構成
- フロントエンドの構成（あれば）

### Step 4: 仕様書の整備

既存コードから「実装に必要十分な情報」を抽出し、新しい仕様書構造に落とし込む。

#### 作成するファイル

既存プロジェクトの性質に応じて、適切な構造を選択：

```
docs/specs/
├── architecture.md    ← 既存構成を記録
├── roadmap.md         ← 実装済み + 未実装を整理
└── screens/           ← UI中心の場合（パターンA）
    または
└── features/          ← 機能中心の場合（パターンB）
    または
└── stories/           ← 複雑なワークフロー中心の場合（パターンC）
```

**構造の選択基準**: 既存コードベースの実装パターンに合わせる。例：画面ベースのビューがあればscreens/、APIエンドポイント中心ならfeatures/。

#### architecture.md に含める内容
- 技術スタック（既存の選択を記録）
- **仕様書構造**（screens/ or features/ or stories/ - 既存プロジェクトに合わせて選択）
- ディレクトリ構成
- 共通パターン（Service Object、Concern等）
- **JS構成**（ファイル分割、共通関数）
- **CSS構成**（ファイル分割）
- **データ送受信パターン**（フォーム送信パターン、API連携パターン（fetchラッパー）等）
- **アセット一覧**（画像、音声）
- テスト構成

#### roadmap.md に含める内容
- 実装済み機能（✅）
- 未実装/進行中の機能（⬜）
- 各タスクと参照先の紐づけ

#### 仕様書ファイル（screens/*.md or features/*.md or stories/*.md）に含める内容
- 既存の決定事項を抽出
- データ構造（テーブル定義）
- データ送受信設計（フォームパラメータ、エンドポイント、JSON例）
- **UI動作**（画面構成、操作フロー）- 画面がある場合
- **演出**（タイミングms単位）- 演出がある場合
- 実装状況チェックリスト（バックエンド/フロントエンド分離）

### Step 5: ユーザー承認

作成した仕様書をユーザーに提示し、承認を得る。
**承認なしに実装フェーズへ進んではいけない。**

### Step 6: 通常のワークフローに移行

仕様書整備後は `sdd_workflow_guidelines.md` の「各機能の実装」フローを適用：
1. roadmap.md で次のタスクと参照先を確認
2. 仕様書（screens/*.md or features/*.md or stories/*.md）で仕様を確認
3. コードベースを分析（SerenaMCP）
4. 実装計画を動的生成
5. ユーザー承認
6. TDD実装
7. レビュー（rails-reviewer / code-reviewer）
8. 進捗状況を更新
   - roadmap.md: タスクの状態を更新（⬜ → ✅）
   - 仕様書: 実装状況チェックリストを更新（[ ] → [x]）

## 新規 vs 既存の違い

| | 新規プロジェクト | 既存プロジェクト |
|--|----------------|----------------|
| 要件定義書 | ユーザーが作成 | あれば確認、なければ抽出 |
| プロトタイプ | 作成 | 既存UIを確認 |
| 仕様書 | Planから抽出 | コードから抽出 |
| 世界観 | 定義する | 既存を理解する |
| アーキテクチャ | 設計する | 既存を記録する |

## コードから情報を抽出する方法

### モデルから
- テーブル構成
- バリデーションルール
- アソシエーション
- スコープ

### コントローラーから
- エンドポイント（アクション、ルーティング）
- 認証・認可パターン
- レスポンス形式（redirect、render、JSON等）

### サービスから
- ビジネスロジックの分離パターン
- 設計判断

### テストから
- 期待される動作
- エッジケース
- カバレッジ状況

### フロントエンドから
- 画面構成
- 操作フロー
- 演出タイミング

## 特定機能依頼時のワークフロー

全体のロードマップが不明な場合や、一部機能だけ依頼される場合のフロー。

### フロー

```
1. 依頼内容の確認
   - 何を実現したいか（What）
   - なぜ必要か（Why）
   - 制約・条件があるか
        ↓
2. code-explorer で関連コードを分析
   - 既存の類似機能
   - 使用すべきパターン
   - 関連するモデル/コントローラー
        ↓
3. 影響範囲の特定
   - 変更が必要なファイル
   - 既存機能への影響
        ↓
4. 仕様書を整理（選択した構造で作成）
   - 要件（What）
   - 設計判断（Why）
   - データ/データ送受信設計
   - **UI動作**（画面構成、操作フロー）- 画面がある場合
   - **演出**（タイミングms単位）- 演出がある場合
        ↓
5. 実装計画を動的生成
   - code-architect（複雑な場合）
        ↓
6. ユーザー承認
        ↓
7. TDD実装
        ↓
8. レビュー
        ↓
9. 進捗状況を更新
   - roadmap.md: タスクの状態を更新（⬜ → ✅）
   - 仕様書: 実装状況チェックリストを更新（[ ] → [x]）
```

### 仕様書の作成タイミング

Step 4 で作成。実装前に仕様を整理する。

### 既存機能の修正・追加時

| 状況 | 対応 |
|------|------|
| 仕様書なし + 新機能追加 | 新規作成 |
| 仕様書なし + 既存機能修正 | 既存機能 + 修正内容をまとめて作成 |
| 仕様書あり + 機能追加 | 既存仕様書に追記 |
| 仕様書あり + 修正 | 既存仕様書を更新 |

### 既存機能修正時の仕様書（例）

```markdown
# 機能名（既存 + 修正）

## 既存の仕様（コードから抽出）
- テーブル: xxx
- データ送受信: xxx
- 制約: xxx

## 今回の変更
- 要件: 〇〇したい
- 設計判断: △△を採用

## UI動作（変更がある場合）
- 〇〇の操作フロー変更

## 実装状況
- [x] 既存機能（実装済み）
- [ ] 今回の変更
```

### 仕様書の粒度

| 機能の規模 | 仕様書 |
|-----------|--------|
| 小さい（バックエンドのみ） | 最小限（要件 + 設計判断 + データ/API） |
| 小さい（UIあり） | 最小限 + UI動作 |
| 中程度 | 標準テンプレート |
| 大きい（複数機能に跨る） | 詳細に記載 |

### 最小限の仕様書（バックエンドのみ）

```markdown
# 機能名

## 要件
- ユーザーは〇〇できる

## 設計判断
- 既存の△△パターンを流用

## 実装状況

### バックエンド
- [x] コントローラアクション
- [x] モデル・バリデーション

### フロントエンド
- [ ] なし（バックエンドのみ）
```

### 最小限の仕様書（UIあり）

```markdown
# 機能名

## 要件
- ユーザーは〇〇できる

## 設計判断
- 既存の△△パターンを流用

## UI動作
- 〇〇ボタンクリック → △△表示

## 実装状況

### バックエンド
- [x] コントローラアクション
- [x] ビュー（ERB/JSON）

### フロントエンド
- [x] 画面表示
- [x] UI動作実装
```

## 注意点

- 既存コードの「なぜそうなっているか」が不明な場合は、ユーザー/チームに確認
- 仕様書作成は完璧を目指さず、必要な部分から段階的に整備
- 既存のコーディング規約やパターンに従う

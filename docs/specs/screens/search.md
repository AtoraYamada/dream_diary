# 索引を辿る（検索）

本棚傍の「索引箱」から過去の夢を探し出す。タグと本文検索のAND条件で絞り込み可能。

---

## 画面構成

| 要素 | 説明 |
|------|------|
| 背景 | 書斎の壁（bg_library_wall_up.png） |
| 索引箱外観 | 本棚脇に配置（クリックでモーダル起動） |
| モーダル内部 | 索引箱内部（bg: img_index_box_interior.png） |
| ヘッダー | 選択中タグバッジ、タグ絞り込み窓、キーワード検索窓 |
| カードリスト | 全タグがカード表示（五十音順） |
| インデックス | 右端に「あ」「か」「さ」…「英」「他」の真鍮製プレート |
| フッター | 「抽出」「開架」ボタン |

---

## 入力フィールド

| フィールド | 必須 | 制約 | 説明 |
|------------|------|------|------|
| タグ絞り込み窓 | - | - | タグカードの表示名・読みがな両方で検索 |
| キーワード検索窓 | - | スペース区切り | タイトル・本文を対象に複数キーワードAND検索 |
| タグ選択（カードクリック） | - | 複数選択可 | 選択タグはヘッダーにバッジ表示 |

---

## UI動作

### 索引箱の開閉

| 操作 | 動作 |
|------|------|
| 索引箱クリック | 瞬き演出→モーダル表示（索引箱の開閉音） |
| 背景クリック | モーダル閉じる（索引箱の開閉音） |

### タグカード操作

| 操作 | 動作 |
|------|------|
| カードクリック | タグ選択（ピン留め音）、ピン留めアイコン表示 |
| カードホバー | 「索引カードをめくる音」再生 |
| タグバッジの「×」クリック | 選択解除（ピン留め解除） |
| カード右下の「破れた紙片」クリック | タグ削除確認→API呼出→風化アニメーション |

### 検索実行

| 操作 | 動作 |
|------|------|
| 「抽出」クリック | 瞬き演出→検索API呼出→本棚に結果表示 |
| 「開架」クリック | 瞬き演出→全選択解除→全件表示に戻る |

### 補助機能

| 操作 | 動作 |
|------|------|
| タグ絞り込み窓入力 | debounce 300ms、表示名・読みがなで前方一致検索 |
| 五十音インデックスクリック | 該当セクションへスムーズスクロール |

---

## エラーハンドリング

エラーメッセージは `config/locales/ja.yml` 参照。

| 状況 | 対応 |
|------|------|
| API通信失敗 | 「索引が開けません。霧が深すぎます。」表示、PS1風ノイズ |
| 検索結果0件 | 「該当する記憶がありません」表示（本棚空白） |
| タグ削除時、紐付く夢あり | 確認メッセージ「このタグは N 個の夢に紐づいています。削除しますか？」 |
| タグ削除失敗 | 「削除できませんでした。もう一度お試しください。」 |

---

## API

### タグ一覧取得

**エンドポイント**: `GET /api/v1/tags`

**クエリパラメータ**:
| パラメータ | 型 | 説明 |
|-----------|-----|------|
| category | string | person / place（省略時: 全カテゴリ） |
| yomi_index | string | 五十音インデックス（あ、か、さ...）（省略時: 全て） |

**レスポンス（成功: 200）**:
```json
{
  "tags": [
    {
      "id": 1,
      "name": "太郎",
      "yomi": "たろう",
      "yomi_index": "た",
      "category": "person"
    },
    {
      "id": 2,
      "name": "学校",
      "yomi": "がっこう",
      "yomi_index": "か",
      "category": "place"
    }
  ]
}
```

### 夢検索

**エンドポイント**: `GET /api/v1/dreams/search`

**クエリパラメータ**:
| パラメータ | 型 | 説明 |
|-----------|-----|------|
| tag_ids | string | タグIDのカンマ区切り文字列（例: "1,2,3"） |
| keywords | string | キーワード文字列（スペース区切りでAND検索） |
| page | integer | ページ番号（デフォルト: 1） |

**レスポンス（成功: 200）**:
```json
{
  "dreams": [
    {
      "id": 1,
      "title": "タイトル",
      "emotion_color": "peace",
      "lucid_dream_flag": false,
      "dreamed_at": "2025-01-15T00:00:00+09:00",
      "tags": [
        { "id": 1, "name": "太郎", "yomi": "たろう", "category": "person" }
      ]
    }
  ],
  "pagination": {
    "current_page": 1,
    "total_pages": 1,
    "total_count": 1,
    "per_page": 12
  }
}
```

### タグ削除

**エンドポイント**: `DELETE /api/v1/tags/:id`

**レスポンス（成功: 204）**: No Content

---

## 演出

`animations.md` 参照。

- 索引箱を開く（400ms、sfx_index_box_open_close.wav）
- カード表示（200ms フェードイン）
- カードめくり（sfx_tag_card_flip.wav）
- ピン留め（sfx_pin.wav）
- カード削除（500ms 風化アニメーション、sfx_sand_crumble.wav）
- 索引箱を閉じる（300ms、sfx_index_box_open_close.wav）
- 瞬き演出（検索実行時、リセット時）

---

## 実装状況

### バックエンド（API）

- [x] GET /api/v1/tags (tags_controller.rb)
- [x] GET /api/v1/dreams/search (dreams_controller.rb)
- [x] DELETE /api/v1/tags/:id (tags_controller.rb)
- [x] Jbuilderビュー (index.json.jbuilder, search.json.jbuilder)

### フロントエンド

- [ ] 索引箱外観クリックでモーダル起動
- [ ] タグ一覧取得API連携
- [ ] タグカードの五十音順表示
- [ ] タグ選択（ピン留め）機能
- [ ] タグ絞り込み窓（debounce 300ms）
- [ ] キーワード検索窓
- [ ] 「抽出」ボタンで検索API呼出
- [ ] 「開架」ボタンでリセット
- [ ] 五十音インデックスでスクロール
- [ ] タグ削除機能（確認→API→風化）
- [ ] エラーハンドリング
- [ ] 検索結果0件時の表示
- [ ] 瞬き演出との統合
- [ ] 全SE再生

**Note**: プロトタイプ (`prototype/js/script.js`) に一部機能実装あり。Rails本体への統合が必要。

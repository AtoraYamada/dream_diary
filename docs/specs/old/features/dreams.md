# 夢記録機能

## 要件

- ユーザーは夢を記録できる（作成・編集・削除）
- ユーザーは夢の一覧を閲覧できる
- ユーザーは夢の詳細を閲覧できる
- ユーザーはキーワードとタグで検索できる
- ユーザーは殴り書きメモを LocalStorage に保存できる
- 夢の氾濫: 書斎で窓をクリック時に発生する演出

## 設計判断

| 決定 | 理由 |
|------|------|
| XSSサニタイズ (before_save) | セキュリティ |
| タイトル15文字制限 | 背表紙表示のため |
| 本文10,000文字制限 | パフォーマンス |
| 500字/ページ分割 | 読みやすさ |
| LocalStorage (殴り書き) | サーバー負荷回避、即時保存 |

## データ

### dreams テーブル

| カラム | 型 | 制約 |
|--------|-----|------|
| id | bigint | PK |
| user_id | bigint | FK, NOT NULL |
| title | string(15) | NOT NULL |
| content | text | NOT NULL, max 10,000 |
| emotion_color | integer | NOT NULL, enum |
| lucid_dream_flag | boolean | default: false | ※将来拡張（UI未実装） |
| dreamed_at | datetime | NOT NULL |
| created_at | datetime | NOT NULL |
| updated_at | datetime | NOT NULL |

### enum

| 値 | 名称 |
|----|------|
| 0 | peace |
| 1 | chaos |
| 2 | fear |
| 3 | elation |

### アソシエーション

- belongs_to :user
- has_many :dream_tags, dependent: :destroy
- has_many :tags, through: :dream_tags

### スコープ

- recent: dreamed_at DESC
- by_emotion: emotion_color でフィルタ
- search_by_keyword: title OR content の LIKE 検索
- tagged_with: タグID配列で AND 検索

## API

| メソッド | パス | 説明 |
|----------|------|------|
| GET | /api/v1/dreams | 一覧取得 |
| GET | /api/v1/dreams/:id | 詳細取得 |
| POST | /api/v1/dreams | 新規作成 |
| PUT | /api/v1/dreams/:id | 更新 |
| DELETE | /api/v1/dreams/:id | 削除 |
| GET | /api/v1/dreams/search | 検索 |
| GET | /api/v1/dreams/overflow | 夢の氾濫 |

### 主要パラメータ

**作成/更新**
```json
{
  "dream": {
    "title": "夢のタイトル",
    "content": "夢の内容...",
    "emotion_color": "peace",
    "dreamed_at": "2024-01-01",
    "tag_names": [
      { "name": "場所A", "yomi": "ばしょえー" }
    ]
  }
}
```

**検索**
- keyword: タイトル・本文検索
- tag_ids[]: タグID配列 (AND条件)

## UI動作

### 画面構成

| 画面 | パス | 説明 |
|------|------|------|
| 書斎 | /library | 机上の巻物、本棚、窓、鏡 |
| 一覧 | /list | 本棚に背表紙が並ぶ形式 |
| 作成 | モーダル | 巻物展開、タグサジェスト |
| 詳細 | モーダル | 本を開く演出、ページめくり |
| 編集 | モーダル | 巻物展開、既存データ表示 |

### 書斎画面

**構成要素**
- 机上の巻物（新規作成トリガー）
- 本棚（蔵書数に応じて画像切替: 0, 1-3, 4-7, 8-12, 13+）
- 窓（氾濫演出トリガー）
- 鏡（ログアウトトリガー）
- 背景BGM（sfx_library_ambience.mp3、ループ）

**操作フロー**
1. 机上の巻物クリック → 作成モーダル表示
2. 本棚クリック → 一覧画面へ（瞬き遷移）
3. 窓クリック → 氾濫演出開始
4. 鏡クリック → ログアウト演出（→ auth.md 参照）

### 一覧画面

**構成要素**
- 本棚（背表紙が並ぶ形式、日付降順）
- 背表紙（感情彩色別、タイトル縦書き）
- 索引箱（検索トリガー → tags.md 参照）
- 真鍮製銘板（現在地表示: 「一号館」「二号館」等）

**ページネーション**
- 左右端クリック → 隣の本棚へスライド（「画面スライド音」）
- 瞬きロードでラグを隠蔽

**コールドスタート対策**
- 0件時は「先代の主の手記」チュートリアル本を配置

**操作フロー**
1. 背表紙ホバー → タイトル浮遊表示
2. 背表紙クリック → 詳細モーダル（本を開く演出）
3. 索引箱クリック → 検索モーダル

### 作成画面（モーダル）

**構成要素**
- 巻物（展開アニメーション）
- タイトル入力（15文字制限、リアルタイムカウント）
- 本文入力（10,000文字制限）
- 感情彩色選択（インク壺4種）
- 日付選択
- タグ入力（サジェスト連動）
- 銀の栞（保存ボタン）

**操作フロー**
1. モーダル表示 → 巻物展開（400ms）
2. インク壺クリック → 感情彩色選択、インク滴下音
3. タグ入力 → APIサジェスト表示
4. 銀の栞クリック → 保存演出（新規）

### 詳細画面（モーダル）

**構成要素**
- 本（感情彩色別フレーム）
- ページ（500字/ページ分割）
- ページめくりボタン
- 編集ボタン（羽ペンアイコン）
- 削除ボタン（砂時計アイコン）

**操作フロー**
1. 背表紙クリック → 瞬き → 本開き演出
2. ページ端クリック → ページめくり（3D回転）
3. 編集ボタン → 編集モーダルへ
4. 削除ボタン → 確認 → 忘却の儀式演出
5. 背景クリック → 本閉じ → 一覧へ戻る

### 編集画面（モーダル）

作成画面と同構成。既存データを初期表示。
保存時は「保存演出（更新）」を実行。

### 夢の氾濫

**構成要素**
- 窓（歪みアニメーション）
- 流入文字（感情彩色付き、鏡文字）
- オーバーレイ

**操作フロー**
1. 窓クリック → API呼び出し
2. 窓歪み演出開始
3. ランダムな夢の断片が鏡文字で流入
4. ホバー/長押し → 正像に反転
5. 背景クリック or 60秒経過 → 解除

## 実装状況

- [x] Dream モデル
- [x] Dreams CRUD API
- [x] Dreams 検索 API
- [x] Dreams 氾濫 API
- [ ] LocalStorage連携
- [ ] 作成画面連携
- [ ] 編集画面連携
- [ ] 一覧画面連携
- [ ] 詳細画面連携
- [ ] 削除機能連携
- [ ] 検索機能連携
- [ ] 夢の氾濫連携

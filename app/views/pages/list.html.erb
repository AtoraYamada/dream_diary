<% content_for :title, "夢日記帳 - 記憶の目録" %>
<% content_for :html_class, "after-door list-page" %>

<% content_for :head do %>
    <script>
        // チラつき完全防止：URL確認して即座にhtml要素にクラス追加
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('blink') === 'open') {
                document.documentElement.classList.add('will-open-eyes');
            }
        })();
    </script>
<% end %>

    <!-- 4:3 Viewport with outer wall as background (from 5.5) -->
    <div class="viewport-container">
        <!-- インタラクティブ要素: ライブラリへ戻るボタン -->
        <div class="back-button" id="back-to-library-button"></div>

        <div class="bookshelf-display">
            <!-- Asset: img_bookshelf_empty.png is background (本棚本体) -->

            <div class="book-spines-container" id="book-spines-container">
                <!-- Example book spines (本の背表紙) -->
                <div class="book-spine peace" data-title="最初の夢" data-id="1"></div>
                <div class="book-spine chaos" data-title="混沌の夜" data-id="2"></div>
                <div class="book-spine fear" data-title="恐怖の影" data-id="3"></div>
                <div class="book-spine elation" data-title="高揚の空" data-id="4"></div>
                <div class="book-spine peace" data-title="古城の秘密" data-id="5"></div>
                <div class="book-spine peace" data-title="森の記憶" data-id="6"></div>
                <div class="book-spine chaos" data-title="無限回廊" data-id="7"></div>
                <div class="book-spine fear" data-title="忘れられた歌" data-id="8"></div>
                <div class="book-spine elation" data-title="星の彼方" data-id="9"></div>
                <div class="book-spine peace" data-title="月の涙" data-id="10"></div>
                <div class="book-spine chaos" data-title="古びた地図" data-id="11"></div>
                <div class="book-spine fear" data-title="砂の城" data-id="12"></div>
            </div>
        </div>

        <div class="pagination-left" id="pagination-left">❮</div>
        <div class="pagination-right" id="pagination-right">❯</div>

        <!-- インタラクティブ要素: 索引箱トリガー。クリックで索引カードモーダルを開く。 -->
        <div class="index-box-trigger" id="index-box-trigger"></div>
    </div>

    <!-- Detail Modal (詳細表示用) -->
    <%= render 'shared/modals/detail_modal' %>

    <!-- Index Card Modal -->
    <%= render 'shared/modals/index_card_modal' %>

    <!-- Edit Modal (巻物モーダル - library.htmlから流用) -->
    <%= render 'shared/modals/scroll_modal', bookmark_id: 'list-save-bookmark' %>

    
    <script>
        // グローバル変数: 現在開いている本の感情とIDを保持
        let currentBookEmotion = 'chaos';
        let currentBookId = null;

        // グローバル関数: 詳細モーダルを開く
        function openDetailModalInList(bookId, emotion = 'chaos') {
            const detailModalOverlay = document.getElementById('detail-modal-overlay');
            const bookFrame = document.querySelector('.book-frame');
            const leftPage = document.getElementById('left-page');
            const rightPage = document.getElementById('right-page');

            // 現在の感情とIDを保存
            currentBookEmotion = emotion;
            currentBookId = bookId;

            console.log('[openDetailModalInList] Starting detail modal open sequence for book:', bookId, 'emotion:', emotion);

            // 瞬き演出を実行（閉眼）
            closeEyes(() => {
                console.log('[openDetailModalInList] Eyes closed, displaying modal...');

                // 感情に応じてbook-frameの背景画像を変更
                const emotionFrames = {
                    peace: 'url("assets/img_book_open_frame_peace.png")',
                    chaos: 'url("assets/img_book_open_frame_chaos.png")',
                    fear: 'url("assets/img_book_open_frame_fear.png")',
                    elation: 'url("assets/img_book_open_frame_elation.png")'
                };
                if (bookFrame && emotionFrames[emotion]) {
                    bookFrame.style.backgroundImage = emotionFrames[emotion];
                    console.log(`[openDetailModalInList] Book frame set to ${emotion} emotion`);
                }

                // closeEyesのコールバック：300ms後に実行される（閉眼完了）
                // モーダルを表示
                detailModalOverlay.classList.add('active');

                // 見開き本に内容を表示
                leftPage.innerHTML = `
                    <p>左ページの内容。これは夢日記の詳細表示画面です。ここに夢の内容が記述されます。昔々、あるところに…。</p>
                    <p>夜の帳が降り、静寂が世界を包み込む頃、私の意識は深い森の奥へと誘われた。そこには古びた石の門があり、蔦に覆われたその扉は、まるで遥か昔からそこに存在し続けているかのように見えた。微かな月明かりが、湿った土の道を照らし、私の足元に細く白い筋を描き出していた。</p>
                    <p>門の向こうには、霧に霞む庭園が広がっていた。手入れのされていない薔薇の木々が、鋭い棘を夜空に突き刺し、その先にはさらに古い洋館の影が横たわっていた。窓は全て黒く、まるで巨大な眼窩のようだった。私は恐怖と好奇心に駆られ、一歩、また一歩と、その未知の領域へと足を踏み入れた。</p>
                `;

                rightPage.innerHTML = `
                    <p>右ページの内容。続きや詳細情報がここに表示されます。この夢は平穏の色に染まっていた。</p>
                    <p>洋館の中は、外観とは裏腹に、不思議なほど温かい空気に満ちていた。薄暗いホールには、埃を被った肖像画が何枚も飾られており、彼らの視線が私を追っているかのように感じられた。遠くから微かに聞こえるオルゴールの音色は、どこか懐かしく、しかし同時に不穏な響きを帯びていた。</p>
                    <p>私は最奥の部屋へと導かれた。そこには、大きな窓から差し込む満月光を浴びて、一冊の古めかしい本が開かれていた。羊皮紙のページには、理解できない古代文字が記されており、私はその意味を探ろうと、必死に目を凝らした。その瞬間、窓の外から眩い光が差し込み、私の意識は急激に覚醒へと向かっていった。</p>
                `;

                // 開眼を実行（50msの小さなバッファを追加して、モーダル表示を確実に）
                console.log('[openDetailModalInList] Opening eyes...');
                setTimeout(() => {
                    console.log('[openDetailModalInList] Calling openEyes()...');
                    openEyes();
                }, 50);
            });
        }

        // グローバル関数: 詳細モーダルを閉じる
        function closeDetailModalInList() {
            const detailModalOverlay = document.getElementById('detail-modal-overlay');

            // モーダルを非表示（瞬き演出なし）
            detailModalOverlay.classList.remove('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Check for opening eyes animation (from page transition)
            checkAndOpenEyes();

            const backButton = document.getElementById('back-to-library-button');
            const bookSpinesContainer = document.getElementById('book-spines-container');
            const paginationLeft = document.getElementById('pagination-left');
            const paginationRight = document.getElementById('pagination-right');
            const indexBoxTrigger = document.getElementById('index-box-trigger');
            const detailModalOverlay = document.getElementById('detail-modal-overlay');

            // Index Card Modal elements
            const indexCardModal = document.getElementById('index-card-modal');

            // 詳細モーダル外クリックで閉じる
            detailModalOverlay.addEventListener('click', (e) => {
                if (e.target === detailModalOverlay) {
                    closeDetailModalInList();
                }
            });

            // 編集ボタンクリック → 巻物モーダルへ遷移
            const detailEditButton = document.getElementById('detail-edit-button');
            const createEditModalOverlay = document.getElementById('create-edit-modal-overlay');
            const scrollMiddle = document.querySelector('.scroll-middle');

            detailEditButton.addEventListener('click', () => {
                playSound('sfx_ui_confirm.wav'); // Asset: 選択・決定音

                closeEyes(() => {
                    console.log('[Edit Button] Eyes closed, transitioning to edit modal...');

                    // 詳細モーダルを確実に消すため、transitionを一時的に無効化
                    detailModalOverlay.style.transition = 'none';

                    // a. 詳細モーダルを閉じる
                    detailModalOverlay.classList.remove('active');

                    // b. 巻物モーダルを折り畳み状態で表示（scroll-middleは既にheight: 0）
                    createEditModalOverlay.classList.add('active');

                    // 感情と色の対応（瞬き中に設定）
                    const emotionColors = {
                        peace: '#a0a9a6',
                        chaos: '#b07a70',
                        fear: '#838387',
                        elation: '#ca9e63'
                    };

                    // 現在の本の感情に応じてインクボトルを選択し、背景色を設定
                    const inkBottles = document.querySelectorAll('.ink-bottle');
                    inkBottles.forEach(bottle => {
                        if (bottle.dataset.emotion === currentBookEmotion) {
                            bottle.classList.add('selected');
                        } else {
                            bottle.classList.remove('selected');
                        }
                    });

                    // scroll-middleの背景色を設定
                    if (scrollMiddle && emotionColors[currentBookEmotion]) {
                        scrollMiddle.style.backgroundColor = emotionColors[currentBookEmotion];
                    }
                    console.log(`[Edit Button] Ink bottle selected: ${currentBookEmotion}, color: ${emotionColors[currentBookEmotion]}`);

                    // 開眼
                    setTimeout(() => {
                        openEyes();

                        // 詳細モーダルのtransitionを元に戻す
                        setTimeout(() => {
                            detailModalOverlay.style.transition = '';
                        }, 100);

                        // 開眼後、巻物の伸長アニメーション（600ms）
                        setTimeout(() => {
                            console.log('[Edit Button] Starting scroll unfurl...');
                            scrollMiddle.classList.add('unfurl');
                        }, 500);
                    }, 50);
                });
            });

            // 巻物モーダル外クリックで閉じる
            createEditModalOverlay.addEventListener('click', (e) => {
                if (e.target === createEditModalOverlay) {
                    console.log('[Scroll Modal] Starting close sequence...');

                    // 巻物収縮アニメーション開始
                    console.log('[Scroll Modal] Starting scroll-middle roll-up animation...');
                    scrollMiddle.classList.remove('unfurl');
                    scrollMiddle.classList.add('roll-up');

                    // 巻物収縮完了後に瞬きを実行
                    setTimeout(() => {
                        console.log('[Scroll Modal] Starting blink animation after scroll collapse...');

                        closeEyes(() => {
                            console.log('[Scroll Modal] Eyes closed, closing modal...');

                            // 瞬き中にモーダルを確実に消すため、transitionを一時的に無効化
                            createEditModalOverlay.style.transition = 'none';

                            // 瞬き中にモーダルを閉じる
                            createEditModalOverlay.classList.remove('active');
                            scrollMiddle.classList.remove('unfurl', 'roll-up');

                            // 残像を完全に消すため、heightを明示的に0にリセット
                            scrollMiddle.style.height = '0';

                            // scroll-middleの色とインクボトルの選択状態をリセット（瞬き中）
                            if (scrollMiddle) {
                                scrollMiddle.style.backgroundColor = '';
                            }
                            inkBottles.forEach(b => b.classList.remove('selected'));
                            console.log('[Scroll Modal] Scroll color and ink bottle selection reset during blink');

                            // 瞬き明け
                            setTimeout(() => {
                                console.log('[Scroll Modal] Opening eyes...');
                                openEyes();

                                // 次回表示のため、transitionを元に戻す
                                setTimeout(() => {
                                    createEditModalOverlay.style.transition = '';
                                }, 100);
                            }, 50);
                        });
                    }, 600); // 巻物アニメーション時間に合わせる（0.6s = 600ms）
                }
            });

            // Save Bookmark click (巻物モーダルを保存して閉じる)
            const saveBookmark = document.getElementById('list-save-bookmark');
            saveBookmark.addEventListener('click', () => {
                console.log('[Save Bookmark] Save button clicked - initiating save...');

                // 栞の発光演出
                console.log('[Save Bookmark] Starting bookmark glow animation...');
                saveBookmark.classList.add('glow');
                playSound('sfx_ui_confirm.wav'); // Asset: 選択・決定音

                // 発光アニメーション完了後に巻物を閉じる処理を開始
                setTimeout(() => {
                    console.log('[Save Bookmark] Glow animation complete, starting close sequence...');

                    // 巻物収縮アニメーション開始
                    scrollMiddle.classList.remove('unfurl');
                    scrollMiddle.classList.add('roll-up');

                    // 巻物収縮完了後に瞬きを実行
                    setTimeout(() => {
                        closeEyes(() => {
                            console.log('[Save Bookmark] Eyes closed, closing modal...');

                            // 瞬き中にモーダルを確実に消すため、transitionを一時的に無効化
                            createEditModalOverlay.style.transition = 'none';

                            // 瞬き中にモーダルを閉じる
                            createEditModalOverlay.classList.remove('active');
                            scrollMiddle.classList.remove('unfurl', 'roll-up');

                            // 残像を完全に消すため、heightを明示的に0にリセット
                            scrollMiddle.style.height = '0';

                            // scroll-middleの色とインクボトルの選択状態をリセット（瞬き中）
                            if (scrollMiddle) {
                                scrollMiddle.style.backgroundColor = '';
                            }
                            inkBottles.forEach(b => b.classList.remove('selected'));
                            console.log('[Save Bookmark] Scroll color and ink bottle selection reset during blink');

                            // 瞬き明け
                            setTimeout(() => {
                                console.log('[Save Bookmark] Opening eyes...');
                                openEyes();

                                // glowクラスを削除
                                saveBookmark.classList.remove('glow');

                                // 次回表示のため、transitionを元に戻す
                                setTimeout(() => {
                                    createEditModalOverlay.style.transition = '';
                                }, 100);

                                // 開眼後、保存した本の背表紙を光らせる
                                if (currentBookId) {
                                    const bookSpine = document.querySelector(`.book-spine[data-id="${currentBookId}"]`);
                                    if (bookSpine) {
                                        console.log(`[Save Bookmark] Glowing book spine with ID: ${currentBookId}`);
                                        bookSpine.classList.add('glow');

                                        // アニメーション終了後にglowクラスを削除
                                        setTimeout(() => {
                                            bookSpine.classList.remove('glow');
                                        }, 3000); // アニメーション時間と同じ（3s）
                                    }
                                }
                            }, 50);
                        });
                    }, 600); // 巻物アニメーション時間に合わせる（0.6s = 600ms）
                }, 300); // bookmark-glowアニメーションの時間
            });

            // Ink bottle click (感情選択 - scroll-middleの背景色変更)
            const inkBottles = document.querySelectorAll('.ink-bottle');

            // 感情と色の対応
            const emotionColors = {
                peace: '#a0a9a6',
                chaos: '#b07a70',
                fear: '#838387',
                elation: '#ca9e63'
            };

            inkBottles.forEach(bottle => {
                bottle.addEventListener('click', () => {
                    const emotion = bottle.dataset.emotion;

                    // 全てのボトルから選択状態を解除
                    inkBottles.forEach(b => b.classList.remove('selected'));

                    // クリックしたボトルを選択状態に
                    bottle.classList.add('selected');

                    // scroll-middleの背景色を変更
                    if (scrollMiddle && emotionColors[emotion]) {
                        scrollMiddle.style.backgroundColor = emotionColors[emotion];
                    }

                    playSound('sfx_ui_confirm.wav'); // Asset: 選択・決定音
                    console.log(`Emotion selected: ${emotion}, color: ${emotionColors[emotion]}`);
                });
            });

            backButton.addEventListener('click', () => {
                playSound('sfx_ui_confirm.wav'); // Asset: 選択・決定音
                navigateWithBlink('<%= library_path %>');
            });

            // Book spine click to detail modal (モーダル方式)
            bookSpinesContainer.addEventListener('click', (event) => {
                const bookSpine = event.target.closest('.book-spine');
                if (bookSpine) {
                    const bookId = bookSpine.dataset.id;

                    // 感情クラスを取得（peace, chaos, fear, elation）
                    let emotion = 'chaos'; // デフォルト
                    if (bookSpine.classList.contains('peace')) emotion = 'peace';
                    else if (bookSpine.classList.contains('chaos')) emotion = 'chaos';
                    else if (bookSpine.classList.contains('fear')) emotion = 'fear';
                    else if (bookSpine.classList.contains('elation')) emotion = 'elation';

                    playSound('sfx_ui_confirm.wav'); // Asset: 選択・決定音
                    console.log(`Clicked book with ID: ${bookId}, emotion: ${emotion}`);

                    // list.html内のモーダル関数を呼び出す（感情を渡す）
                    openDetailModalInList(bookId, emotion);
                }
            });

            // Pagination (placeholder)
            paginationLeft.addEventListener('click', () => {
                playSound('sfx_screen_slide.wav'); // Asset: 画面スライド音
                initiateBlinkTransition(() => {
                    console.log('Navigate to previous page of books');
                    // In a real app, load previous page data here
                });
            });

            paginationRight.addEventListener('click', () => {
                playSound('sfx_screen_slide.wav'); // Asset: 画面スライド音
                initiateBlinkTransition(() => {
                    console.log('Navigate to next page of books');
                    // In a real app, load next page data here
                });
            });

            // Index Box click to open modal
            indexBoxTrigger.addEventListener('click', () => {
                playSound('sfx_index_box_open_close.wav'); // Asset: 索引箱の開閉音
                initiateBlinkTransition(() => {
                    console.log('Opening index card modal');
                    indexBoxTrigger.style.display = 'none'; // Hide trigger when modal opens
                    indexCardModal.classList.add('visible');
                    initIndexCardModal(); // Initialize modal functionality
                });
            });


            // Close modal by clicking outside the drawer
            indexCardModal.addEventListener('click', (event) => {
                if (event.target === indexCardModal) {
                    playSound('sfx_index_box_open_close.wav'); // Asset: 索引箱の開閉音
                    initiateBlinkTransition(() => {
                        console.log('Closing index card modal by overlay click');
                        indexCardModal.classList.remove('visible');
                        indexBoxTrigger.style.display = 'block'; // Show trigger when modal closes
                    });
                }
            });
        });
    </script>
